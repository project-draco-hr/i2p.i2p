{
  String nsClass=router.getClass().getSimpleName();
  boolean isTextFile=nsClass.equals("HostsTxtNamingService") || nsClass.equals("SingleFileNamingService");
  Set<String> knownNames=null;
  NamingService publishedNS=null;
  Iterator<AddressBook> iter=subscriptions.iterator();
  while (iter.hasNext()) {
    long start=System.currentTimeMillis();
    AddressBook addressbook=iter.next();
    if (DEBUG && log != null && addressbook.getLocation() != null) {
      long end=System.currentTimeMillis();
      log.append("Fetch of " + addressbook.getLocation() + " took "+ (end - start));
      start=end;
    }
    int old=0, nnew=0, invalid=0, conflict=0, total=0;
    int deleted=0;
    for (    Map.Entry<String,HostTxtEntry> entry : addressbook) {
      total++;
      String key=entry.getKey();
      boolean isKnown;
      Destination oldDest;
      if (isTextFile) {
        if (knownNames == null) {
          Properties opts=new Properties();
          opts.setProperty("file","hosts.txt");
          knownNames=router.getNames(opts);
        }
        oldDest=null;
        isKnown=knownNames.contains(key);
      }
 else {
        oldDest=router.lookup(key);
        isKnown=oldDest != null;
      }
      try {
        HostTxtEntry he=entry.getValue();
        Properties hprops=he.getProps();
        boolean mustValidate=MUST_VALIDATE || hprops != null;
        String action=hprops != null ? hprops.getProperty(HostTxtEntry.PROP_ACTION) : null;
        if (mustValidate && !he.hasValidSig()) {
          if (log != null) {
            if (isKnown)             log.append("Bad signature for old key " + key);
 else             log.append("Bad signature for new key " + key);
          }
          invalid++;
        }
 else         if (action != null || !isKnown) {
          if (AddressBook.isValidKey(key)) {
            Destination dest=new Destination(he.getDest());
            Properties props=new OrderedProperties();
            props.setProperty("s",addressbook.getLocation());
            if (mustValidate) {
              props.setProperty("v","true");
            }
            if (hprops != null) {
              for (              Map.Entry<Object,Object> e : hprops.entrySet()) {
                props.setProperty(RCVD_PROP_PREFIX + e.getKey(),(String)e.getValue());
              }
            }
            if (action != null) {
              if (action.equals(HostTxtEntry.ACTION_ADDDEST)) {
                String polddest=hprops.getProperty(HostTxtEntry.PROP_OLDDEST);
                if (polddest != null) {
                  Destination pod=new Destination(polddest);
                  if (isKnown && isTextFile)                   oldDest=router.lookup(key);
                  if (pod.equals(dest)) {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " identical old and new destinations for "+ key+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
 else                   if (!isKnown) {
                  }
 else                   if (dest.equals(oldDest)) {
                    old++;
                    continue;
                  }
 else                   if (pod.equals(oldDest)) {
                    if (!he.hasValidInnerSig()) {
                      if (log != null)                       log.append("Action: " + action + " failed because"+ " inner signature for key "+ key+ " failed"+ " from "+ addressbook.getLocation());
                      invalid++;
                      continue;
                    }
                    if (log != null)                     log.append("Action: " + action + " unimplemented"+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters");
                  invalid++;
                  continue;
                }
              }
 else               if (action.equals(HostTxtEntry.ACTION_ADDNAME)) {
                if (isKnown) {
                  old++;
                  continue;
                }
                String poldname=hprops.getProperty(HostTxtEntry.PROP_OLDNAME);
                if (poldname != null) {
                  Destination pod=router.lookup(poldname);
                  if (pod == null) {
                  }
 else                   if (pod.equals(dest)) {
                  }
 else {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " destination for old name "+ poldname+ " does not match"+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                  continue;
                }
              }
 else               if (action.equals(HostTxtEntry.ACTION_ADDSUBDOMAIN)) {
                if (isKnown) {
                  old++;
                  continue;
                }
                String polddest=hprops.getProperty(HostTxtEntry.PROP_OLDDEST);
                String poldname=hprops.getProperty(HostTxtEntry.PROP_OLDNAME);
                if (polddest != null && poldname != null) {
                  if (!AddressBook.isValidKey(poldname) || key.indexOf('.' + poldname) <= 0) {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " old name "+ poldname+ " is invalid"+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                  Destination pod=new Destination(polddest);
                  Destination pod2=router.lookup(poldname);
                  if (pod2 == null) {
                  }
 else                   if (pod.equals(pod2)) {
                    if (!he.hasValidInnerSig()) {
                      if (log != null)                       log.append("Action: " + action + " failed because"+ " inner signature for old name "+ poldname+ " failed"+ " from "+ addressbook.getLocation());
                      invalid++;
                      continue;
                    }
                  }
 else {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " destination for old name "+ poldname+ " does not match provided"+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                  continue;
                }
              }
 else               if (action.equals(HostTxtEntry.ACTION_CHANGEDEST)) {
                String polddest=hprops.getProperty(HostTxtEntry.PROP_OLDDEST);
                if (polddest != null) {
                  Destination pod=new Destination(polddest);
                  if (isKnown && isTextFile)                   oldDest=router.lookup(key);
                  if (!isKnown) {
                  }
 else                   if (pod.equals(oldDest)) {
                    if (!he.hasValidInnerSig()) {
                      if (log != null)                       log.append("Action: " + action + " failed because"+ " inner signature for key "+ key+ " failed"+ " from "+ addressbook.getLocation());
                      invalid++;
                      continue;
                    }
                  }
 else {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " destination for key "+ key+ " does not match provided"+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                  continue;
                }
              }
 else               if (action.equals(HostTxtEntry.ACTION_CHANGENAME)) {
                if (isKnown) {
                  old++;
                  continue;
                }
                String poldname=hprops.getProperty(HostTxtEntry.PROP_OLDNAME);
                if (poldname != null) {
                  Destination pod=router.lookup(poldname);
                  if (pod == null) {
                  }
 else                   if (pod.equals(dest)) {
                    if (knownNames != null)                     knownNames.remove(poldname);
                    boolean success=router.remove(poldname);
                    if (success)                     deleted++;
                    if (log != null) {
                      if (success)                       log.append("Removed: " + poldname + " to be replaced with "+ key+ " from "+ addressbook.getLocation());
 else                       log.append("Remove failed for: " + poldname + " to be replaced with "+ key+ " from "+ addressbook.getLocation());
                    }
                    if (published != null) {
                      if (publishedNS == null)                       publishedNS=new SingleFileNamingService(I2PAppContext.getGlobalContext(),published.getAbsolutePath());
                      success=publishedNS.remove(poldname);
                      if (log != null && !success)                       log.append("Remove from published address book " + published.getAbsolutePath() + " failed for "+ poldname);
                    }
                  }
 else {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " destination for old name "+ poldname+ " does not match new name "+ key+ " from "+ addressbook.getLocation());
                    invalid++;
                    continue;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                  continue;
                }
              }
 else               if (action.equals(HostTxtEntry.ACTION_REMOVE)) {
                if (!isKnown) {
                  old++;
                  continue;
                }
                String polddest=hprops.getProperty(HostTxtEntry.PROP_DEST);
                String poldname=hprops.getProperty(HostTxtEntry.PROP_NAME);
                if (polddest != null && poldname != null) {
                  Destination pod=new Destination(polddest);
                  Destination pod2=router.lookup(poldname);
                  if (pod.equals(pod2)) {
                    if (knownNames != null)                     knownNames.remove(poldname);
                    boolean success=router.remove(poldname);
                    if (success)                     deleted++;
                    if (log != null) {
                      if (success)                       log.append("Removed: " + poldname + " as requested"+ " from "+ addressbook.getLocation());
 else                       log.append("Remove failed for: " + poldname + " as requested"+ " from "+ addressbook.getLocation());
                    }
                    if (published != null) {
                      if (publishedNS == null)                       publishedNS=new SingleFileNamingService(I2PAppContext.getGlobalContext(),published.getAbsolutePath());
                      success=publishedNS.remove(poldname);
                      if (log != null && !success)                       log.append("Remove from published address book " + published.getAbsolutePath() + " failed for "+ poldname);
                    }
                  }
 else                   if (pod2 != null) {
                    if (log != null)                     log.append("Action: " + action + " failed because"+ " destination for "+ poldname+ " does not match"+ " from "+ addressbook.getLocation());
                    invalid++;
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                }
                continue;
              }
 else               if (action.equals(HostTxtEntry.ACTION_REMOVEALL)) {
                if (!isKnown) {
                  old++;
                  continue;
                }
                String polddest=hprops.getProperty(HostTxtEntry.PROP_DEST);
                if (polddest != null) {
                  Destination pod=new Destination(polddest);
                  String poldname=hprops.getProperty(HostTxtEntry.PROP_NAME);
                  if (poldname != null) {
                    Destination pod2=router.lookup(poldname);
                    if (pod.equals(pod2)) {
                      if (knownNames != null)                       knownNames.remove(poldname);
                      boolean success=router.remove(poldname);
                      if (success)                       deleted++;
                      if (log != null) {
                        if (success)                         log.append("Removed: " + poldname + " as requested"+ " from "+ addressbook.getLocation());
 else                         log.append("Remove failed for: " + poldname + " as requested"+ " from "+ addressbook.getLocation());
                      }
                      if (published != null) {
                        if (publishedNS == null)                         publishedNS=new SingleFileNamingService(I2PAppContext.getGlobalContext(),published.getAbsolutePath());
                        success=publishedNS.remove(poldname);
                        if (log != null && !success)                         log.append("Remove from published address book " + published.getAbsolutePath() + " failed for "+ poldname);
                      }
                    }
 else                     if (pod2 != null) {
                      if (log != null)                       log.append("Action: " + action + " failed because"+ " destination for "+ poldname+ " does not match"+ " from "+ addressbook.getLocation());
                      invalid++;
                    }
                  }
                  String rev;
                  String rev2=null;
                  while ((rev=router.reverseLookup(pod)) != null) {
                    if (rev.equals(rev2))                     break;
                    rev2=rev;
                    Destination fwd=router.lookup(rev);
                    if (!pod.equals(fwd))                     break;
                    if (knownNames != null)                     knownNames.remove(rev);
                    boolean success=router.remove(rev);
                    if (success)                     deleted++;
                    if (log != null) {
                      if (success)                       log.append("Removed: " + rev + " as requested"+ " from "+ addressbook.getLocation());
 else                       log.append("Remove failed for: " + rev + " as requested"+ " from "+ addressbook.getLocation());
                    }
                    if (published != null) {
                      if (publishedNS == null)                       publishedNS=new SingleFileNamingService(I2PAppContext.getGlobalContext(),published.getAbsolutePath());
                      success=publishedNS.remove(rev);
                      if (log != null && !success)                       log.append("Remove from published address book " + published.getAbsolutePath() + " failed for "+ rev);
                    }
                  }
                }
 else {
                  if (log != null)                   log.append("Action: " + action + " failed, missing required parameters"+ " from "+ addressbook.getLocation());
                  invalid++;
                }
                continue;
              }
 else               if (action.equals(HostTxtEntry.ACTION_UPDATE)) {
                if (isKnown) {
                }
              }
 else {
                if (log != null)                 log.append("Action: " + action + " unrecognized"+ " from "+ addressbook.getLocation());
                invalid++;
                continue;
              }
            }
            boolean success=router.put(key,dest,props);
            if (log != null) {
              if (success)               log.append("New address " + key + " added to address book. From: "+ addressbook.getLocation());
 else               log.append("Save to naming service " + router + " failed for new key "+ key);
            }
            if (published != null) {
              if (publishedNS == null)               publishedNS=new SingleFileNamingService(I2PAppContext.getGlobalContext(),published.getAbsolutePath());
              success=publishedNS.putIfAbsent(key,dest,props);
              if (log != null && !success) {
                log.append("Save to published address book " + published.getAbsolutePath() + " failed for new key "+ key);
              }
            }
            if (isTextFile)             knownNames.add(key);
            nnew++;
          }
 else           if (log != null) {
            log.append("Bad hostname " + key + " from "+ addressbook.getLocation());
            invalid++;
          }
        }
 else {
          old++;
        }
      }
 catch (      DataFormatException dfe) {
        if (log != null)         log.append("Invalid b64 for " + key + " From: "+ addressbook.getLocation());
        invalid++;
      }
    }
    if (DEBUG && log != null && total > 0) {
      log.append("Merge of " + addressbook.getLocation() + " into "+ router+ " took "+ (System.currentTimeMillis() - start)+ " ms with "+ total+ " total, "+ nnew+ " new, "+ old+ " old, "+ deleted+ " deleted, "+ invalid+ " invalid, "+ conflict+ " conflicts");
    }
    addressbook.delete();
  }
  subscriptions.write();
}
