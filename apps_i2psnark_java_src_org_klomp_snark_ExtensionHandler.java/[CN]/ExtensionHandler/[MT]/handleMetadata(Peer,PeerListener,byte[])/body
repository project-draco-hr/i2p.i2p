{
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Got metadata msg from " + peer);
  try {
    InputStream is=new ByteArrayInputStream(bs);
    BDecoder dec=new BDecoder(is);
    BEValue bev=dec.bdecodeMap();
    Map<String,BEValue> map=bev.getMap();
    int type=map.get("msg_type").getInt();
    int piece=map.get("piece").getInt();
    MagnetState state=peer.getMagnetState();
    if (type == TYPE_REQUEST) {
      byte[] pc;
synchronized (state) {
        pc=state.getChunk(piece);
      }
      sendPiece(peer,piece,pc);
      peer.uploaded(pc.length);
      listener.uploaded(peer,pc.length);
    }
 else     if (type == TYPE_DATA) {
      int size=map.get("total_size").getInt();
      boolean done;
      int chk=-1;
synchronized (state) {
        if (state.isComplete())         return;
        int len=is.available();
        peer.downloaded(len);
        listener.downloaded(peer,len);
        done=state.saveChunk(piece,bs,bs.length - len,len);
        if (_log.shouldLog(Log.INFO))         _log.info("Got chunk " + piece + " from "+ peer);
        if (!done)         chk=state.getNextRequest();
      }
      if (done) {
        if (_log.shouldLog(Log.WARN))         _log.warn("Got last chunk from " + peer);
      }
 else {
        if (_log.shouldLog(Log.INFO))         _log.info("Request chunk " + chk + " from "+ peer);
        sendRequest(peer,chk);
      }
    }
 else     if (type == TYPE_REJECT) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Got reject msg from " + peer);
      peer.disconnect(false);
    }
 else {
      if (_log.shouldLog(Log.WARN))       _log.warn("Got unknown metadata msg from " + peer);
      peer.disconnect(false);
    }
  }
 catch (  Exception e) {
    if (_log.shouldLog(Log.WARN))     _log.info("Metadata ext. msg. exception from " + peer,e);
    peer.disconnect(false);
  }
}
