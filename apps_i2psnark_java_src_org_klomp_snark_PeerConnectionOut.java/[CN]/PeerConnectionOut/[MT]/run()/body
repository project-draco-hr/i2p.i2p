{
  try {
    while (!quit && peer.isConnected()) {
      Message m=null;
      PeerState state=null;
synchronized (sendQueue) {
        while (!quit && peer.isConnected() && sendQueue.isEmpty()) {
          try {
            dout.flush();
            sendQueue.wait();
          }
 catch (          InterruptedException ie) {
          }
        }
        state=peer.state;
        if (!quit && state != null && peer.isConnected()) {
          Iterator it=sendQueue.iterator();
          while (m == null && it.hasNext()) {
            Message nm=(Message)it.next();
            if (nm.type == Message.PIECE) {
              if (state.choking) {
                it.remove();
                SimpleTimer.getInstance().removeEvent(nm.expireEvent);
              }
              nm=null;
            }
 else             if (nm.type == Message.REQUEST && state.choked) {
              it.remove();
              SimpleTimer.getInstance().removeEvent(nm.expireEvent);
              nm=null;
            }
            if (m == null && nm != null) {
              m=nm;
              SimpleTimer.getInstance().removeEvent(nm.expireEvent);
              it.remove();
            }
          }
          if (m == null && sendQueue.size() > 0) {
            m=(Message)sendQueue.remove(0);
            SimpleTimer.getInstance().removeEvent(m.expireEvent);
          }
        }
      }
      if (m != null) {
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Send " + peer + ": "+ m+ " on "+ peer.metainfo.getName());
        m.sendMessage(dout);
        lastSent=System.currentTimeMillis();
        if (m.type == Message.CHOKE)         removeMessage(Message.PIECE);
        if (m.type == Message.PIECE)         state.uploaded(m.len);
        m=null;
      }
    }
  }
 catch (  IOException ioe) {
    if (_log.shouldLog(Log.INFO))     _log.info("IOError sending to " + peer,ioe);
  }
catch (  Throwable t) {
    _log.error("Error sending to " + peer,t);
    if (t instanceof OutOfMemoryError)     throw (OutOfMemoryError)t;
  }
 finally {
    quit=true;
    peer.disconnect();
  }
}
