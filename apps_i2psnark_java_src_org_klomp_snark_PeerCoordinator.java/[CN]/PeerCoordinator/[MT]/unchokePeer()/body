{
  List interested=new LinkedList();
synchronized (peers) {
    int count=0;
    int unchokedCount=0;
    int maxUploaders=allowedUploaders();
    Iterator it=peers.iterator();
    while (it.hasNext()) {
      Peer peer=(Peer)it.next();
      if (peer.isChoking() && peer.isInterested()) {
        count++;
        if (uploaders < maxUploaders) {
          if (!peer.isChoked())           interested.add(unchokedCount++,peer);
 else           interested.add(peer);
        }
      }
    }
    while (uploaders < maxUploaders && interested.size() > 0) {
      Peer peer=(Peer)interested.remove(0);
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Unchoke: " + peer);
      peer.setChoking(false);
      uploaders++;
      count--;
      peers.remove(peer);
      peers.add(peer);
      peerCount=peers.size();
    }
    interestedAndChoking=count;
  }
}
