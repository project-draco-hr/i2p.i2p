{
  if ((!dontAutoStart) && !_util.connected()) {
    addMessage("Connecting to I2P");
    boolean ok=_util.connect();
    if (!ok) {
      addMessage("Error connecting to I2P - check your I2CP settings!");
      return;
    }
  }
  File sfile=new File(filename);
  try {
    filename=sfile.getCanonicalPath();
  }
 catch (  IOException ioe) {
    _log.error("Unable to add the torrent " + filename,ioe);
    addMessage("ERR: Could not add the torrent '" + filename + "': "+ ioe.getMessage());
    return;
  }
  File dataDir=getDataDir();
  Snark torrent=null;
synchronized (_snarks) {
    torrent=(Snark)_snarks.get(filename);
  }
  if (torrent == null) {
synchronized (_addSnarkLock) {
synchronized (_snarks) {
        if (_snarks.get(filename) != null)         return;
      }
      FileInputStream fis=null;
      try {
        fis=new FileInputStream(sfile);
        MetaInfo info=new MetaInfo(fis);
        fis.close();
        fis=null;
        String rejectMessage=locked_validateTorrent(info);
        if (rejectMessage != null) {
          sfile.delete();
          addMessage(rejectMessage);
          return;
        }
 else {
          torrent=new Snark(_util,filename,null,-1,null,null,this,_peerCoordinatorSet,_connectionAcceptor,false,dataDir.getPath());
          torrent.completeListener=this;
synchronized (_snarks) {
            _snarks.put(filename,torrent);
          }
        }
      }
 catch (      IOException ioe) {
        addMessage("Torrent in " + sfile.getName() + " is invalid: "+ ioe.getMessage());
        if (sfile.exists())         sfile.delete();
        return;
      }
 finally {
        if (fis != null)         try {
          fis.close();
        }
 catch (        IOException ioe) {
        }
      }
    }
  }
 else {
    return;
  }
  File f=new File(filename);
  if (!dontAutoStart && shouldAutoStart()) {
    torrent.startTorrent();
    addMessage("Torrent added and started: '" + f.getName() + "'.");
  }
 else {
    addMessage("Torrent added: '" + f.getName() + "'.");
  }
}
