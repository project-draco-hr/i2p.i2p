{
  String[] ls=null;
  if (r.isDirectory()) {
    ls=r.list();
    Arrays.sort(ls,Collator.getInstance());
  }
  StringBuilder buf=new StringBuilder(4096);
  buf.append(DOCTYPE + "<HTML><HEAD><TITLE>");
  String title=URIUtil.decodePath(base);
  if (title.startsWith("/i2psnark/"))   title=title.substring("/i2psnark/".length());
  String torrentName;
  int slash=title.indexOf('/');
  if (slash > 0)   torrentName=title.substring(0,slash);
 else   torrentName=title;
  Snark snark=_manager.getTorrentByBaseName(torrentName);
  if (snark != null && postParams != null)   savePriorities(snark,postParams);
  if (title.endsWith("/"))   title=title.substring(0,title.length() - 1);
  String directory=title;
  title=_("Torrent") + ": " + title;
  buf.append(title);
  buf.append("</TITLE>").append(HEADER_A).append(_themePath).append(HEADER_B).append("<link rel=\"shortcut icon\" href=\"" + _themePath + "favicon.ico\">"+ "</HEAD><BODY>\n<center><div class=\"snarknavbar\"><a href=\"/i2psnark/\" title=\"Torrents\"");
  buf.append(" class=\"snarkRefresh\"><img alt=\"\" border=\"0\" src=\"" + _imgPath + "arrow_refresh.png\">&nbsp;&nbsp;I2PSnark</a></div></center>\n");
  if (parent)   buf.append("<div class=\"page\"><div class=\"mainsection\">");
  boolean showPriority=ls != null && snark != null && snark.getStorage() != null && !snark.getStorage().complete();
  if (showPriority)   buf.append("<form action=\"").append(base).append("\" method=\"POST\">\n");
  if (snark != null) {
    buf.append("<table class=\"snarkTorrentInfo\">\n");
    buf.append("<tr><th><b>").append(_("Torrent")).append(":</b> ").append(snark.getBaseName()).append("</th></tr>\n");
    buf.append("<tr><td>").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "file.png\" >&nbsp;<b>").append(_("Torrent file")).append(":</b> ").append(snark.getName()).append("</td></tr>\n");
    MetaInfo meta=snark.getMetaInfo();
    if (meta != null) {
      String announce=meta.getAnnounce();
      if (announce != null) {
        buf.append("<tr><td>");
        String trackerLink=getTrackerLink(announce,snark.getInfoHash());
        if (trackerLink != null)         buf.append(trackerLink).append(' ');
        buf.append("<b>").append(_("Tracker")).append(":</b> ");
        String trackerLinkUrl=getTrackerLinkUrl(announce,snark.getInfoHash());
        if (trackerLinkUrl != null)         buf.append(trackerLinkUrl);
        if (announce.startsWith("http://"))         announce=announce.substring(7);
        int slsh=announce.indexOf('/');
        if (slsh > 0)         announce=announce.substring(0,slsh);
        if (announce.length() > 67)         announce=announce.substring(0,40) + "&hellip;" + announce.substring(announce.length() - 8);
        buf.append(announce);
        if (trackerLinkUrl != null)         buf.append("</a>");
        buf.append("</td></tr>");
      }
    }
    String hex=I2PSnarkUtil.toHex(snark.getInfoHash());
    if (meta == null || !meta.isPrivate()) {
      buf.append("<tr><td><a href=\"").append(MAGNET_FULL).append(hex).append("\">").append(toImg("magnet",_("Magnet link"))).append("</a> <b>Magnet:</b> <a href=\"").append(MAGNET_FULL).append(hex).append("\">").append(MAGNET_FULL).append(hex).append("</a>").append("</td></tr>\n");
    }
 else {
      buf.append("<tr><td>").append(_("Private torrent")).append("</td></tr>\n");
    }
    buf.append("<tr><td>").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "size.png\" >&nbsp;<b>").append(_("Size")).append(":</b> ").append(formatSize(snark.getTotalLength()));
    int pieces=snark.getPieces();
    double completion=(pieces - snark.getNeeded()) / (double)pieces;
    if (completion < 1.0)     buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "head_rx.png\" >&nbsp;<b>").append(_("Completion")).append(":</b> ").append((new DecimalFormat("0.00%")).format(completion));
 else     buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "head_rx.png\" >&nbsp;").append(_("Complete"));
    long needed=snark.getNeededLength();
    if (needed > 0)     buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "head_rx.png\" >&nbsp;<b>").append(_("Remaining")).append(":</b> ").append(formatSize(needed));
    if (meta != null) {
      List files=meta.getFiles();
      int fileCount=files != null ? files.size() : 1;
      buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "file.png\" >&nbsp;<b>").append(_("Files")).append(":</b> ").append(fileCount);
    }
    buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "file.png\" >&nbsp;<b>").append(_("Pieces")).append(":</b> ").append(pieces);
    buf.append("&nbsp;<img alt=\"\" border=\"0\" src=\"" + _imgPath + "file.png\" >&nbsp;<b>").append(_("Piece size")).append(":</b> ").append(formatSize(snark.getPieceLength(0))).append("</td></tr>\n");
  }
 else {
    buf.append("<tr><th>Not found<br>resource=\"").append(r.toString()).append("\"<br>base=\"").append(base).append("\"<br>torrent=\"").append(torrentName).append("\"</th></tr>\n");
  }
  buf.append("</table>\n");
  if (ls == null) {
    buf.append("</div></div></BODY></HTML>");
    return buf.toString();
  }
  buf.append("<table class=\"snarkDirInfo\"><thead>\n");
  buf.append("<tr>\n").append("<th colspan=2>").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "file.png\" >&nbsp;").append(_("Directory")).append(": ").append(directory).append("</th>\n");
  buf.append("<th align=\"right\">").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "size.png\" >&nbsp;").append(_("Size")).append("</th>\n");
  buf.append("<th class=\"headerstatus\">").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "status.png\" >&nbsp;").append(_("Status")).append("</th>\n");
  if (showPriority)   buf.append("<th class=\"headerpriority\">").append("<img alt=\"\" border=\"0\" src=\"" + _imgPath + "priority.png\" >&nbsp;").append(_("Priority")).append("</th>\n");
  buf.append("</tr>\n</thead>\n");
  buf.append("<tr><td colspan=\"" + (showPriority ? '5' : '4') + "\" class=\"ParentDir\"><A HREF=\"");
  buf.append(URIUtil.addPaths(base,"../"));
  buf.append("\"><img alt=\"\" border=\"0\" src=\"" + _imgPath + "up.png\"> ").append(_("Up to higher level directory")).append("</A></td></tr>\n");
  boolean showSaveButton=false;
  for (int i=0; i < ls.length; i++) {
    String encoded=URIUtil.encodePath(ls[i]);
    Resource item=r.addPath(ls[i]);
    String rowClass=(i % 2 == 0 ? "snarkTorrentEven" : "snarkTorrentOdd");
    buf.append("<TR class=\"").append(rowClass).append("\">");
    boolean complete=false;
    String status="";
    long length=item.length();
    if (item.isDirectory()) {
      complete=true;
      status=toImg("tick") + ' ' + _("Directory");
    }
 else {
      if (snark == null || snark.getStorage() == null) {
        complete=true;
        status=toImg("cancel") + ' ' + _("Torrent not found?");
      }
 else {
        Storage storage=snark.getStorage();
        try {
          File f=item.getFile();
          if (f != null) {
            long remaining=storage.remaining(f.getCanonicalPath());
            if (remaining < 0) {
              complete=true;
              status=toImg("cancel") + ' ' + _("File not found in torrent?");
            }
 else             if (remaining == 0 || length <= 0) {
              complete=true;
              status=toImg("tick") + ' ' + _("Complete");
            }
 else {
              int priority=storage.getPriority(f.getCanonicalPath());
              if (priority < 0)               status=toImg("cancel");
 else               if (priority == 0)               status=toImg("clock");
 else               status=toImg("clock_red");
              status+=" " + (100 * (length - remaining) / length) + "% "+ _("complete")+ " ("+ DataHelper.formatSize2(remaining)+ "B "+ _("remaining")+ ")";
            }
          }
 else {
            status="Not a file?";
          }
        }
 catch (        IOException ioe) {
          status="Not a file? " + ioe;
        }
      }
    }
    String path=URIUtil.addPaths(base,encoded);
    if (item.isDirectory() && !path.endsWith("/"))     path=URIUtil.addPaths(path,"/");
    String icon=toIcon(item);
    buf.append("<TD class=\"snarkFileIcon ").append(rowClass).append("\">");
    if (complete) {
      buf.append("<a href=\"").append(path).append("\">");
      String plc=item.toString().toLowerCase(Locale.US);
      if (plc.endsWith(".jpg") || plc.endsWith(".jpeg") || plc.endsWith(".png")|| plc.endsWith(".gif")|| plc.endsWith(".ico")) {
        buf.append("<img alt=\"\" border=\"0\" class=\"thumb\" src=\"").append(path).append("\"></a>");
      }
 else {
        buf.append(toImg(icon,_("Open"))).append("</a>");
      }
    }
 else {
      buf.append(toImg(icon));
    }
    buf.append("</TD><TD class=\"snarkFileName ").append(rowClass).append("\">");
    if (complete)     buf.append("<a href=\"").append(path).append("\">");
    buf.append(ls[i]);
    if (complete)     buf.append("</a>");
    buf.append("</TD><TD ALIGN=right class=\"").append(rowClass).append(" snarkFileSize\">");
    if (!item.isDirectory())     buf.append(DataHelper.formatSize2(length)).append('B');
    buf.append("</TD><TD class=\"").append(rowClass).append(" snarkFileStatus\">");
    buf.append(status);
    buf.append("</TD>");
    if (showPriority) {
      buf.append("<td class=\"priority\">");
      File f=item.getFile();
      if ((!complete) && (!item.isDirectory()) && f != null) {
        int pri=snark.getStorage().getPriority(f.getCanonicalPath());
        buf.append("<input type=\"radio\" value=\"5\" name=\"pri.").append(f.getCanonicalPath()).append("\" ");
        if (pri > 0)         buf.append("checked=\"true\"");
        buf.append('>').append(_("High"));
        buf.append("<input type=\"radio\" value=\"0\" name=\"pri.").append(f.getCanonicalPath()).append("\" ");
        if (pri == 0)         buf.append("checked=\"true\"");
        buf.append('>').append(_("Normal"));
        buf.append("<input type=\"radio\" value=\"-9\" name=\"pri.").append(f.getCanonicalPath()).append("\" ");
        if (pri < 0)         buf.append("checked=\"true\"");
        buf.append('>').append(_("Skip"));
        showSaveButton=true;
      }
      buf.append("</td>");
    }
    buf.append("</TR>\n");
  }
  if (showSaveButton) {
    buf.append("<thead><tr><th colspan=\"4\">&nbsp;</th><th class=\"headerpriority\"><input type=\"submit\" value=\"");
    buf.append(_("Save priorities"));
    buf.append("\" name=\"foo\" ></th></tr></thead>\n");
  }
  buf.append("</table>\n");
  if (showPriority)   buf.append("</form>");
  buf.append("</div></div></BODY></HTML>\n");
  return buf.toString();
}
