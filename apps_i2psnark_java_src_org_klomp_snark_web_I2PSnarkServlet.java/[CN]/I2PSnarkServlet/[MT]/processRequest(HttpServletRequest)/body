{
  String action=req.getParameter("action");
  if (action == null) {
    Map params=req.getParameterMap();
    for (    Object o : params.keySet()) {
      String key=(String)o;
      if (key.startsWith("action_") && key.endsWith(".x")) {
        action=key.substring(0,key.length() - 2).substring(7);
        break;
      }
    }
    if (action == null) {
      _manager.addMessage("No action specified");
      return;
    }
  }
  if ("Add".equals(action)) {
    String newURL=req.getParameter("newURL");
    if (newURL != null) {
      if (newURL.startsWith("http://")) {
        FetchAndAdd fetch=new FetchAndAdd(_context,_manager,newURL);
        _manager.addDownloader(fetch);
      }
 else       if (newURL.startsWith(MagnetURI.MAGNET) || newURL.startsWith(MagnetURI.MAGGOT)) {
        addMagnet(newURL);
      }
 else       if (newURL.length() == 40 && newURL.replaceAll("[a-fA-F0-9]","").length() == 0) {
        addMagnet(MagnetURI.MAGNET_FULL + newURL);
      }
 else {
        _manager.addMessage(_("Invalid URL: Must start with \"http://\", \"{0}\", or \"{1}\"",MagnetURI.MAGNET,MagnetURI.MAGGOT));
      }
    }
 else {
    }
  }
 else   if (action.startsWith("Stop_")) {
    String torrent=action.substring(5);
    if (torrent != null) {
      byte infoHash[]=Base64.decode(torrent);
      if ((infoHash != null) && (infoHash.length == 20)) {
        for (Iterator iter=_manager.listTorrentFiles().iterator(); iter.hasNext(); ) {
          String name=(String)iter.next();
          Snark snark=_manager.getTorrent(name);
          if ((snark != null) && (DataHelper.eq(infoHash,snark.getInfoHash()))) {
            _manager.stopTorrent(snark,false);
            break;
          }
        }
      }
    }
  }
 else   if (action.startsWith("Start_")) {
    String torrent=action.substring(6);
    if (torrent != null) {
      byte infoHash[]=Base64.decode(torrent);
      if ((infoHash != null) && (infoHash.length == 20)) {
        _manager.startTorrent(infoHash);
      }
    }
  }
 else   if (action.startsWith("Remove_")) {
    String torrent=action.substring(7);
    if (torrent != null) {
      byte infoHash[]=Base64.decode(torrent);
      if ((infoHash != null) && (infoHash.length == 20)) {
        for (Iterator iter=_manager.listTorrentFiles().iterator(); iter.hasNext(); ) {
          String name=(String)iter.next();
          Snark snark=_manager.getTorrent(name);
          if ((snark != null) && (DataHelper.eq(infoHash,snark.getInfoHash()))) {
            MetaInfo meta=snark.getMetaInfo();
            if (meta == null) {
              _manager.deleteMagnet(snark);
              _manager.addMessage(_("Magnet deleted: {0}",name));
              return;
            }
            _manager.stopTorrent(snark,true);
            File f=new File(name);
            f.delete();
            _manager.addMessage(_("Torrent file deleted: {0}",f.getAbsolutePath()));
            break;
          }
        }
      }
    }
  }
 else   if (action.startsWith("Delete_")) {
    String torrent=action.substring(7);
    if (torrent != null) {
      byte infoHash[]=Base64.decode(torrent);
      if ((infoHash != null) && (infoHash.length == 20)) {
        for (Iterator iter=_manager.listTorrentFiles().iterator(); iter.hasNext(); ) {
          String name=(String)iter.next();
          Snark snark=_manager.getTorrent(name);
          if ((snark != null) && (DataHelper.eq(infoHash,snark.getInfoHash()))) {
            MetaInfo meta=snark.getMetaInfo();
            if (meta == null) {
              _manager.deleteMagnet(snark);
              if (snark instanceof FetchAndAdd)               _manager.addMessage(_("Download deleted: {0}",name));
 else               _manager.addMessage(_("Magnet deleted: {0}",name));
              return;
            }
            _manager.stopTorrent(snark,true);
            File f=new File(name);
            f.delete();
            _manager.addMessage(_("Torrent file deleted: {0}",f.getAbsolutePath()));
            List<List<String>> files=meta.getFiles();
            String dataFile=snark.getBaseName();
            f=new File(_manager.getDataDir(),dataFile);
            if (files == null) {
              if (f.delete())               _manager.addMessage(_("Data file deleted: {0}",f.getAbsolutePath()));
 else               _manager.addMessage(_("Data file could not be deleted: {0}",f.getAbsolutePath()));
              break;
            }
            for (int i=0; i < files.size(); i++) {
              File df=Storage.getFileFromNames(f,files.get(i));
              if (df.delete()) {
              }
 else {
                _manager.addMessage(_("Data file could not be deleted: {0}",df.getAbsolutePath()));
              }
            }
            Set<File> dirs=new TreeSet(Collections.reverseOrder());
            for (            List<String> list : files) {
              for (int i=1; i < list.size(); i++) {
                dirs.add(Storage.getFileFromNames(f,list.subList(0,i)));
              }
            }
            for (            File df : dirs) {
              if (df.delete()) {
              }
 else {
                _manager.addMessage(_("Directory could not be deleted: {0}",df.getAbsolutePath()));
                if (_log.shouldLog(Log.WARN))                 _log.warn("Could not delete dir " + df);
              }
            }
            if (f.delete()) {
              _manager.addMessage(_("Directory deleted: {0}",f.getAbsolutePath()));
            }
 else {
              _manager.addMessage(_("Directory could not be deleted: {0}",f.getAbsolutePath()));
              if (_log.shouldLog(Log.WARN))               _log.warn("Could not delete dir " + f);
            }
            break;
          }
        }
      }
    }
  }
 else   if ("Save".equals(action)) {
    String dataDir=req.getParameter("dataDir");
    boolean filesPublic=req.getParameter("filesPublic") != null;
    boolean autoStart=req.getParameter("autoStart") != null;
    String seedPct=req.getParameter("seedPct");
    String eepHost=req.getParameter("eepHost");
    String eepPort=req.getParameter("eepPort");
    String i2cpHost=req.getParameter("i2cpHost");
    String i2cpPort=req.getParameter("i2cpPort");
    String i2cpOpts=buildI2CPOpts(req);
    String upLimit=req.getParameter("upLimit");
    String upBW=req.getParameter("upBW");
    String refreshDel=req.getParameter("refreshDelay");
    String startupDel=req.getParameter("startupDelay");
    String pageSize=req.getParameter("pageSize");
    boolean useOpenTrackers=req.getParameter("useOpenTrackers") != null;
    boolean useDHT=req.getParameter("useDHT") != null;
    String theme=req.getParameter("theme");
    _manager.updateConfig(dataDir,filesPublic,autoStart,refreshDel,startupDel,pageSize,seedPct,eepHost,eepPort,i2cpHost,i2cpPort,i2cpOpts,upLimit,upBW,useOpenTrackers,useDHT,theme);
    try {
      setResourceBase(_manager.getDataDir());
    }
 catch (    ServletException se) {
    }
  }
 else   if ("Save2".equals(action)) {
    String taction=req.getParameter("taction");
    if (taction != null)     processTrackerForm(taction,req);
  }
 else   if ("Create".equals(action)) {
    String baseData=req.getParameter("baseFile");
    if (baseData != null && baseData.trim().length() > 0) {
      File baseFile=new File(_manager.getDataDir(),baseData);
      String announceURL=req.getParameter("announceURL");
      if (baseFile.exists()) {
        if (announceURL.equals("none"))         announceURL=null;
        _lastAnnounceURL=announceURL;
        List<String> backupURLs=new ArrayList();
        Enumeration e=req.getParameterNames();
        while (e.hasMoreElements()) {
          Object o=e.nextElement();
          if (!(o instanceof String))           continue;
          String k=(String)o;
          if (k.startsWith("backup_")) {
            String url=k.substring(7);
            if (!url.equals(announceURL))             backupURLs.add(url);
          }
        }
        List<List<String>> announceList=null;
        if (!backupURLs.isEmpty()) {
          if (announceURL == null) {
            _manager.addMessage(_("Error - Cannot include alternate trackers without a primary tracker"));
            return;
          }
          backupURLs.add(0,announceURL);
          boolean hasPrivate=false;
          boolean hasPublic=false;
          for (          String url : backupURLs) {
            if (_manager.getPrivateTrackers().contains(announceURL))             hasPrivate=true;
 else             hasPublic=true;
          }
          if (hasPrivate && hasPublic) {
            _manager.addMessage(_("Error - Cannot mix private and public trackers in a torrent"));
            return;
          }
          announceList=new ArrayList(backupURLs.size());
          for (          String url : backupURLs) {
            announceList.add(Collections.singletonList(url));
          }
        }
        try {
          boolean isPrivate=_manager.getPrivateTrackers().contains(announceURL);
          Storage s=new Storage(_manager.util(),baseFile,announceURL,announceList,isPrivate,null);
          s.close();
          MetaInfo info=s.getMetaInfo();
          File torrentFile=new File(_manager.getDataDir(),s.getBaseName() + ".torrent");
          _manager.addTorrent(info,s.getBitField(),torrentFile.getAbsolutePath(),true);
          _manager.addMessage(_("Torrent created for \"{0}\"",baseFile.getName()) + ": " + torrentFile.getAbsolutePath());
          if (announceURL != null && !_manager.util().getOpenTrackers().contains(announceURL))           _manager.addMessage(_("Many I2P trackers require you to register new torrents before seeding - please do so before starting \"{0}\"",baseFile.getName()));
        }
 catch (        IOException ioe) {
          _manager.addMessage(_("Error creating a torrent for \"{0}\"",baseFile.getAbsolutePath()) + ": " + ioe);
          _log.error("Error creating a torrent",ioe);
        }
      }
 else {
        _manager.addMessage(_("Cannot create a torrent for the nonexistent data: {0}",baseFile.getAbsolutePath()));
      }
    }
 else {
      _manager.addMessage(_("Error creating torrent - you must enter a file or directory"));
    }
  }
 else   if ("StopAll".equals(action)) {
    _manager.stopAllTorrents(false);
  }
 else   if ("StartAll".equals(action)) {
    _manager.startAllTorrents();
  }
 else   if ("Clear".equals(action)) {
    _manager.clearMessages();
  }
 else {
    _manager.addMessage("Unknown POST action: \"" + action + '\"');
  }
}
