{
  InputStream in=null;
  OutputStream out=null;
  String targetRequest=null;
  boolean usingWWWProxy=false;
  String currentProxy=null;
  long requestId=++__requestId;
  try {
    out=s.getOutputStream();
    in=s.getInputStream();
    String line, method=null, host=null, destination=null, restofline=null;
    StringBuilder newRequest=new StringBuilder();
    int ahelper=0;
    while (true) {
      line=DataHelper.readLine(in);
      line=line.trim();
      if (_log.shouldLog(Log.DEBUG))       _log.debug(getPrefix(requestId) + "Line=[" + line+ "]");
      if (method == null) {
        int pos=line.indexOf(" ");
        if (pos == -1)         break;
        method=line.substring(0,pos);
        String request=line.substring(pos + 1);
        pos=request.indexOf(":");
        if (pos == -1)         pos=request.indexOf(" ");
        if (pos == -1) {
          host=request;
          restofline="";
        }
 else {
          host=request.substring(0,pos);
          restofline=request.substring(pos);
        }
        if (host.toLowerCase().endsWith(".i2p")) {
          destination=host;
        }
 else         if (host.indexOf(".") != -1) {
          currentProxy=selectProxy();
          if (currentProxy == null) {
            if (_log.shouldLog(Log.WARN))             _log.warn(getPrefix(requestId) + "Host wants to be outproxied, but we dont have any!");
            writeErrorMessage(ERR_NO_OUTPROXY,out);
            s.close();
            return;
          }
          destination=currentProxy;
          usingWWWProxy=true;
          newRequest.append("CONNECT ").append(host).append(restofline).append("\r\n\r\n");
        }
 else         if (host.toLowerCase().equals("localhost")) {
          writeErrorMessage(ERR_LOCALHOST,out);
          s.close();
          return;
        }
 else {
          destination=host;
        }
        targetRequest=host;
        if (_log.shouldLog(Log.DEBUG)) {
          _log.debug(getPrefix(requestId) + "METHOD:" + method+ ":");
          _log.debug(getPrefix(requestId) + "HOST  :" + host+ ":");
          _log.debug(getPrefix(requestId) + "REST  :" + restofline+ ":");
          _log.debug(getPrefix(requestId) + "DEST  :" + destination+ ":");
        }
      }
 else       if (line.length() > 0) {
        line=null;
      }
 else {
        break;
      }
    }
    if (destination == null || !"CONNECT".equalsIgnoreCase(method)) {
      writeErrorMessage(ERR_BAD_PROTOCOL,out);
      s.close();
      return;
    }
    Destination dest=I2PTunnel.destFromName(destination);
    if (dest == null) {
      String str;
      byte[] header;
      if (usingWWWProxy)       str=FileUtil.readTextFile((new File(_errorDir,"dnfp-header.ht")).getAbsolutePath(),100,true);
 else       str=FileUtil.readTextFile((new File(_errorDir,"dnfh-header.ht")).getAbsolutePath(),100,true);
      if (str != null)       header=str.getBytes();
 else       header=ERR_DESTINATION_UNKNOWN;
      writeErrorMessage(header,out,targetRequest,usingWWWProxy,destination);
      s.close();
      return;
    }
    I2PSocket i2ps=createI2PSocket(dest,getDefaultOptions());
    byte[] data=null;
    byte[] response=null;
    if (usingWWWProxy)     data=newRequest.toString().getBytes("ISO-8859-1");
 else     response=SUCCESS_RESPONSE;
    Runnable onTimeout=new OnTimeout(s,s.getOutputStream(),targetRequest,usingWWWProxy,currentProxy,requestId);
    I2PTunnelRunner runner=new I2PTunnelRunner(s,i2ps,sockLock,data,response,mySockets,onTimeout);
  }
 catch (  SocketException ex) {
    _log.info(getPrefix(requestId) + "Error trying to connect",ex);
    handleConnectClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  IOException ex) {
    _log.info(getPrefix(requestId) + "Error trying to connect",ex);
    handleConnectClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  I2PException ex) {
    _log.info("getPrefix(requestId) + Error trying to connect",ex);
    handleConnectClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  OutOfMemoryError oom) {
    IOException ex=new IOException("OOM");
    _log.info("getPrefix(requestId) + Error trying to connect",ex);
    handleConnectClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
}
