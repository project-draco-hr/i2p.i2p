{
  InputStream in=null;
  OutputStream out=null;
  String targetRequest=null;
  boolean usingWWWProxy=false;
  boolean usingInternalServer=false;
  String currentProxy=null;
  long requestId=++__requestId;
  try {
    out=s.getOutputStream();
    InputReader reader=new InputReader(s.getInputStream());
    String line, method=null, protocol=null, host=null, destination=null;
    StringBuilder newRequest=new StringBuilder();
    int ahelper=0;
    while ((line=reader.readLine(method)) != null) {
      line=line.trim();
      if (_log.shouldLog(Log.DEBUG))       _log.debug(getPrefix(requestId) + "Line=[" + line+ "]");
      String lowercaseLine=line.toLowerCase();
      if (lowercaseLine.startsWith("connection: ") || lowercaseLine.startsWith("keep-alive: ") || lowercaseLine.startsWith("proxy-connection: "))       continue;
      if (method == null) {
        if (_log.shouldLog(Log.DEBUG))         _log.debug(getPrefix(requestId) + "Method is null for [" + line+ "]");
        int pos=line.indexOf(" ");
        if (pos == -1)         break;
        method=line.substring(0,pos);
        String request=line.substring(pos + 1);
        if (request.startsWith("/") && getTunnel().getClientOptions().getProperty("i2ptunnel.noproxy") != null) {
          request="http://i2p" + request;
        }
 else         if (request.startsWith("/eepproxy/")) {
          String subRequest=request.substring("/eepproxy/".length());
          int protopos=subRequest.indexOf(" ");
          String uri=subRequest.substring(0,protopos);
          if (uri.indexOf("/") == -1) {
            uri=uri + "/";
          }
          request="http://" + uri + subRequest.substring(protopos);
        }
        pos=request.indexOf("//");
        if (pos == -1) {
          method=null;
          break;
        }
        protocol=request.substring(0,pos + 2);
        request=request.substring(pos + 2);
        targetRequest=request;
        pos=request.indexOf("/");
        if (pos == -1) {
          method=null;
          break;
        }
        host=request.substring(0,pos);
        int posPort=host.indexOf(":");
        int port=80;
        if (posPort != -1) {
          String[] parts=host.split(":");
          host=parts[0];
          try {
            port=Integer.parseInt(parts[1]);
          }
 catch (          Exception exc) {
          }
        }
        if (host.toLowerCase().equals("proxy.i2p")) {
          destination="proxy.i2p";
          usingInternalServer=true;
        }
 else         if (host.toLowerCase().endsWith(".i2p")) {
          destination=host;
          host=getHostName(destination);
          int pos2;
          if ((pos2=request.indexOf("?")) != -1) {
            String ahelperKey=null;
            boolean ahelperConflict=false;
            String fragments=request.substring(pos2 + 1);
            String uriPath=request.substring(0,pos2);
            pos2=fragments.indexOf(" ");
            String protocolVersion=fragments.substring(pos2 + 1);
            String urlEncoding="";
            fragments=fragments.substring(0,pos2);
            String initialFragments=fragments;
            fragments=fragments + "&";
            String fragment;
            while (fragments.length() > 0) {
              pos2=fragments.indexOf("&");
              fragment=fragments.substring(0,pos2);
              fragments=fragments.substring(pos2 + 1);
              if (fragment.startsWith("i2paddresshelper=")) {
                pos2=fragment.indexOf("=");
                ahelperKey=fragment.substring(pos2 + 1);
                if (ahelperKey != null) {
                  if ((host == null) || ("i2p".equals(host))) {
                    addressHelpers.put(destination,ahelperKey);
                  }
 else {
                    if (!host.equals(ahelperKey)) {
                      ahelperConflict=true;
                      if (_log.shouldLog(Log.WARN))                       _log.warn(getPrefix(requestId) + "Addresshelper key conflict for site [" + destination+ "], trusted key ["+ host+ "], specified key ["+ ahelperKey+ "].");
                    }
                  }
                }
              }
 else {
                if ("".equals(urlEncoding)) {
                  urlEncoding="?" + fragment;
                }
 else {
                  urlEncoding=urlEncoding + "&" + fragment;
                }
              }
            }
            request=uriPath + urlEncoding + " "+ protocolVersion;
            if (ahelperConflict) {
              if (out != null) {
                long alias=I2PAppContext.getGlobalContext().random().nextLong();
                String trustedURL=protocol + uriPath + urlEncoding;
                String conflictURL=protocol + alias + ".i2p/?"+ initialFragments;
                byte[] header=getErrorPage("ahelper-conflict",ERR_AHELPER_CONFLICT);
                out.write(header);
                out.write(("To visit the destination in your host database, click <a href=\"" + trustedURL + "\">here</a>. To visit the conflicting addresshelper link by temporarily giving it a random alias, click <a href=\""+ conflictURL+ "\">here</a>.<p></div>").getBytes());
                writeFooter(out);
              }
              s.close();
              return;
            }
          }
          String addressHelper=(String)addressHelpers.get(destination);
          if (addressHelper != null) {
            destination=addressHelper;
            host=getHostName(destination);
            ahelper=1;
          }
          line=method + " " + request.substring(pos);
        }
 else         if (host.toLowerCase().equals("localhost") || host.equals("127.0.0.1")) {
          if (out != null) {
            out.write(getErrorPage("localhost",ERR_LOCALHOST));
            writeFooter(out);
          }
          s.close();
          return;
        }
 else         if (host.indexOf(".") != -1) {
          host=host + ":" + port;
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Before selecting outproxy for " + host);
          currentProxy=selectProxy();
          if (_log.shouldLog(Log.DEBUG))           _log.debug("After selecting outproxy for " + host + ": "+ currentProxy);
          if (currentProxy == null) {
            if (_log.shouldLog(Log.WARN))             _log.warn(getPrefix(requestId) + "Host wants to be outproxied, but we dont have any!");
            l.log("No HTTP outproxy found for the request.");
            if (out != null) {
              out.write(getErrorPage("noproxy",ERR_NO_OUTPROXY));
              writeFooter(out);
            }
            s.close();
            return;
          }
          destination=currentProxy;
          usingWWWProxy=true;
          if (_log.shouldLog(Log.DEBUG))           _log.debug(getPrefix(requestId) + "Host doesnt end with .i2p and it contains a period [" + host+ "]: wwwProxy!");
        }
 else {
          request=request.substring(pos + 1);
          pos=request.indexOf("/");
          if (pos < 0) {
            l.log("Invalid request url [" + request + "]");
            if (out != null) {
              out.write(getErrorPage("denied",ERR_REQUEST_DENIED));
              writeFooter(out);
            }
            s.close();
            return;
          }
          destination=request.substring(0,pos);
          line=method + " " + request.substring(pos);
        }
        boolean isValid=usingWWWProxy || usingInternalServer || isSupportedAddress(host,protocol);
        if (!isValid) {
          if (_log.shouldLog(Log.INFO))           _log.info(getPrefix(requestId) + "notValid(" + host+ ")");
          method=null;
          destination=null;
          break;
        }
 else         if ((!usingWWWProxy) && (!usingInternalServer)) {
          if (_log.shouldLog(Log.INFO))           _log.info(getPrefix(requestId) + "host=getHostName(" + destination+ ")");
          host=getHostName(destination);
        }
        if (_log.shouldLog(Log.DEBUG)) {
          _log.debug(getPrefix(requestId) + "METHOD:" + method+ ":");
          _log.debug(getPrefix(requestId) + "PROTOC:" + protocol+ ":");
          _log.debug(getPrefix(requestId) + "HOST  :" + host+ ":");
          _log.debug(getPrefix(requestId) + "DEST  :" + destination+ ":");
        }
      }
 else {
        if (lowercaseLine.startsWith("host: ") && !usingWWWProxy) {
          line="Host: " + host;
          if (_log.shouldLog(Log.INFO))           _log.info(getPrefix(requestId) + "Setting host = " + host);
        }
 else         if (lowercaseLine.startsWith("user-agent: ") && !Boolean.valueOf(getTunnel().getClientOptions().getProperty(PROP_USER_AGENT)).booleanValue()) {
          line=null;
          continue;
        }
 else         if (lowercaseLine.startsWith("accept")) {
          line=null;
          continue;
        }
 else         if (lowercaseLine.startsWith("referer: ") && !Boolean.valueOf(getTunnel().getClientOptions().getProperty(PROP_REFERER)).booleanValue()) {
          line=null;
          continue;
        }
 else         if (lowercaseLine.startsWith("via: ") && !Boolean.valueOf(getTunnel().getClientOptions().getProperty(PROP_VIA)).booleanValue()) {
          line=null;
          continue;
        }
 else         if (lowercaseLine.startsWith("from: ")) {
          line=null;
          continue;
        }
      }
      if (line.length() == 0) {
        String ok=getTunnel().getClientOptions().getProperty("i2ptunnel.gzip");
        boolean gzip=DEFAULT_GZIP;
        if (ok != null)         gzip=Boolean.valueOf(ok).booleanValue();
        if (gzip && !usingInternalServer) {
          newRequest.append("Accept-Encoding: \r\n");
          newRequest.append("X-Accept-Encoding: x-i2p-gzip;q=1.0, identity;q=0.5, deflate;q=0, gzip;q=0, *;q=0\r\n");
        }
        if (!Boolean.valueOf(getTunnel().getClientOptions().getProperty(PROP_USER_AGENT)).booleanValue())         newRequest.append("User-Agent: MYOB/6.66 (AN/ON)\r\n");
        newRequest.append("Connection: close\r\n\r\n");
        break;
      }
 else {
        newRequest.append(line).append("\r\n");
      }
    }
    if (_log.shouldLog(Log.DEBUG))     _log.debug(getPrefix(requestId) + "NewRequest header: [" + newRequest.toString()+ "]");
    if (method == null || destination == null) {
      l.log("No HTTP method found in the request.");
      if (out != null) {
        if ("http://".equalsIgnoreCase(protocol))         out.write(getErrorPage("denied",ERR_REQUEST_DENIED));
 else         out.write(getErrorPage("protocol",ERR_BAD_PROTOCOL));
        writeFooter(out);
      }
      s.close();
      return;
    }
    if (_log.shouldLog(Log.DEBUG))     _log.debug(getPrefix(requestId) + "Destination: " + destination);
    if (usingInternalServer) {
      serveLocalFile(out,method,targetRequest);
      s.close();
      return;
    }
    Destination clientDest=I2PTunnel.destFromName(destination);
    if (clientDest == null) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Unable to resolve " + destination + " (proxy? "+ usingWWWProxy+ ", request: "+ targetRequest);
      byte[] header;
      boolean showAddrHelper=false;
      if (usingWWWProxy)       header=getErrorPage("dnfp",ERR_DESTINATION_UNKNOWN);
 else       if (ahelper != 0)       header=getErrorPage("dnfb",ERR_DESTINATION_UNKNOWN);
 else       if (destination.length() == 60 && destination.endsWith(".b32.i2p"))       header=getErrorPage("dnf",ERR_DESTINATION_UNKNOWN);
 else {
        header=getErrorPage("dnfh",ERR_DESTINATION_UNKNOWN);
        showAddrHelper=true;
      }
      writeErrorMessage(header,out,targetRequest,usingWWWProxy,destination,showAddrHelper);
      s.close();
      return;
    }
    String remoteID;
    Properties opts=new Properties();
    I2PSocket i2ps=createI2PSocket(clientDest,getDefaultOptions(opts));
    byte[] data=newRequest.toString().getBytes("ISO-8859-1");
    Runnable onTimeout=new OnTimeout(s,s.getOutputStream(),targetRequest,usingWWWProxy,currentProxy,requestId);
    I2PTunnelRunner runner=new I2PTunnelHTTPClientRunner(s,i2ps,sockLock,data,mySockets,onTimeout);
  }
 catch (  SocketException ex) {
    _log.info(getPrefix(requestId) + "Error trying to connect",ex);
    l.log(ex.getMessage());
    handleHTTPClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  IOException ex) {
    _log.info(getPrefix(requestId) + "Error trying to connect",ex);
    l.log(ex.getMessage());
    handleHTTPClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  I2PException ex) {
    _log.info("getPrefix(requestId) + Error trying to connect",ex);
    l.log(ex.getMessage());
    handleHTTPClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
catch (  OutOfMemoryError oom) {
    IOException ex=new IOException("OOM");
    _log.info("getPrefix(requestId) + Error trying to connect",ex);
    l.log(ex.getMessage());
    handleHTTPClientException(ex,out,targetRequest,usingWWWProxy,currentProxy,requestId);
    closeSocket(s);
  }
}
