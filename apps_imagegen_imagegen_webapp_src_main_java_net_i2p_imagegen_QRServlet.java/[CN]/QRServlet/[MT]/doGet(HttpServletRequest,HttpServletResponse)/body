{
  String codeParam=request.getParameter(PARAM_IDENTICON_CODE_SHORT);
  boolean codeSpecified=codeParam != null && codeParam.length() > 0;
  if (!codeSpecified) {
    response.setStatus(403);
    return;
  }
  String sizeParam=request.getParameter(PARAM_IDENTICON_SIZE_SHORT);
  int size=Math.max(50,(2 * 4) + (int)(2 * 5 * Math.sqrt(codeParam.length())));
  if (sizeParam != null) {
    try {
      size=Integer.parseInt(sizeParam);
      if (size < 40)       size=40;
 else       if (size > 512)       size=512;
    }
 catch (    NumberFormatException nfe) {
    }
  }
  String identiconETag=IdenticonUtil.getIdenticonETag(codeParam.hashCode(),size,version);
  String requestETag=request.getHeader("If-None-Match");
  if (requestETag != null && requestETag.equals(identiconETag)) {
    response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
  }
 else {
    byte[] imageBytes=null;
    if (cache == null || (imageBytes=cache.get(identiconETag)) == null) {
      ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
      QRCodeWriter qrcw=new QRCodeWriter();
      BitMatrix matrix;
      try {
        matrix=qrcw.encode(codeParam,BarcodeFormat.QR_CODE,size,size);
      }
 catch (      WriterException we) {
        throw new IOException("encode failed",we);
      }
      MatrixToImageWriter.writeToStream(matrix,IDENTICON_IMAGE_FORMAT,byteOut);
      imageBytes=byteOut.toByteArray();
      if (cache != null)       cache.add(identiconETag,imageBytes);
    }
 else {
      response.setStatus(403);
      return;
    }
    response.setHeader("ETag",identiconETag);
    if (codeSpecified) {
      long expires=System.currentTimeMillis() + identiconExpiresInMillis;
      response.addDateHeader("Expires",expires);
    }
    response.setContentType(IDENTICON_IMAGE_MIMETYPE);
    response.setContentLength(imageBytes.length);
    response.getOutputStream().write(imageBytes);
  }
}
