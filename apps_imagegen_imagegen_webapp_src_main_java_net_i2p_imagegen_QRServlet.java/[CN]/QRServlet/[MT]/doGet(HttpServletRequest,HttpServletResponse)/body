{
  String codeParam=request.getParameter(PARAM_IDENTICON_CODE_SHORT);
  boolean codeSpecified=codeParam != null && codeParam.length() > 0;
  if (!codeSpecified) {
    codeParam="http://stats.i2p/?i2paddresshelper=Okd5sN9hFWx-sr0HH8EFaxkeIMi6PC5eGTcjM1KB7uQ0ffCUJ2nVKzcsKZFHQc7pLONjOs2LmG5H-2SheVH504EfLZnoB7vxoamhOMENnDABkIRGGoRisc5AcJXQ759LraLRdiGSR0WTHQ0O1TU0hAz7vAv3SOaDp9OwNDr9u902qFzzTKjUTG5vMTayjTkLo2kOwi6NVchDeEj9M7mjj5ySgySbD48QpzBgcqw1R27oIoHQmjgbtbmV2sBL-2Tpyh3lRe1Vip0-K0Sf4D-Zv78MzSh8ibdxNcZACmZiVODpgMj2ejWJHxAEz41RsfBpazPV0d38Mfg4wzaS95R5hBBo6SdAM4h5vcZ5ESRiheLxJbW0vBpLRd4mNvtKOrcEtyCvtvsP3FpA-6IKVswyZpHgr3wn6ndDHiVCiLAQZws4MsIUE1nkfxKpKtAnFZtPrrB8eh7QO9CkH2JBhj7bG0ED6mV5~X5iqi52UpsZ8gnjZTgyG5pOF8RcFrk86kHxAAAA";
  }
  String sizeParam=request.getParameter(PARAM_IDENTICON_SIZE_SHORT);
  int size=Math.max(50,(2 * 4) + (int)(2 * 5 * Math.sqrt(codeParam.length())));
  if (sizeParam != null) {
    try {
      size=Integer.parseInt(sizeParam);
      if (size < 40)       size=40;
 else       if (size > 512)       size=512;
    }
 catch (    NumberFormatException nfe) {
    }
  }
  String identiconETag=IdenticonUtil.getIdenticonETag(codeParam.hashCode(),size,version);
  String requestETag=request.getHeader("If-None-Match");
  if (requestETag != null && requestETag.equals(identiconETag)) {
    response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
  }
 else {
    byte[] imageBytes=null;
    if (cache == null || (imageBytes=cache.get(identiconETag)) == null) {
      ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
      QRCodeWriter qrcw=new QRCodeWriter();
      BitMatrix matrix;
      try {
        matrix=qrcw.encode(codeParam,BarcodeFormat.QR_CODE,size,size);
      }
 catch (      WriterException we) {
        throw new IOException("encode failed",we);
      }
      MatrixToImageWriter.writeToStream(matrix,IDENTICON_IMAGE_FORMAT,byteOut);
      imageBytes=byteOut.toByteArray();
      if (cache != null)       cache.add(identiconETag,imageBytes);
    }
 else {
      response.setStatus(403);
      return;
    }
    response.setHeader("ETag",identiconETag);
    if (codeSpecified) {
      long expires=System.currentTimeMillis() + identiconExpiresInMillis;
      response.addDateHeader("Expires",expires);
    }
    response.setContentType(IDENTICON_IMAGE_MIMETYPE);
    response.setContentLength(imageBytes.length);
    response.getOutputStream().write(imageBytes);
  }
}
