{
  if (!isStarted() || _gracefulStop)   return;
  if (_hosts != null && _hosts.size() > 0) {
    Object o=request.getHttpConnection().getConnection();
    if (o instanceof Socket) {
      Socket s=(Socket)o;
      if (!_hosts.contains(s.getLocalAddress())) {
        if (log.isDebugEnabled())         log.debug(s.getLocalAddress() + " not in " + _hosts);
        return;
      }
    }
  }
  if (_statsOn) {
synchronized (_statsLock) {
      _requests++;
      _requestsActive++;
      if (_requestsActive > _requestsActiveMax)       _requestsActiveMax=_requestsActive;
    }
  }
  String pathInContext=URI.canonicalPath(request.getPath());
  if (pathInContext == null) {
    throw new HttpException(HttpResponse.__400_Bad_Request);
  }
  if (_contextPath.length() > 1)   pathInContext=pathInContext.substring(_contextPath.length());
  if (_redirectNullPath && (pathInContext == null || pathInContext.length() == 0)) {
    StringBuffer buf=request.getRequestURL();
    buf.append("/");
    String q=request.getQuery();
    if (q != null && q.length() != 0)     buf.append("?" + q);
    response.sendRedirect(buf.toString());
    if (log.isDebugEnabled())     log.debug(this + " consumed all of path " + request.getPath()+ ", redirect to "+ buf.toString());
    return;
  }
  String pathParams=null;
  int semi=pathInContext.lastIndexOf(';');
  if (semi >= 0) {
    int pl=pathInContext.length() - semi;
    String ep=request.getEncodedPath();
    if (';' == ep.charAt(ep.length() - pl)) {
      pathParams=pathInContext.substring(semi + 1);
      pathInContext=pathInContext.substring(0,semi);
    }
  }
  try {
    handle(pathInContext,pathParams,request,response);
  }
  finally {
    if (_userRealm != null && request.hasUserPrincipal())     _userRealm.disassociate(request.getUserPrincipal());
  }
}
