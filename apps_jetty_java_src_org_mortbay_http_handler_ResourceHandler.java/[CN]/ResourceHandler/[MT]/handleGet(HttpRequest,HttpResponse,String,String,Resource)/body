{
  if (log.isDebugEnabled())   log.debug("Looking for " + resource);
  if (resource != null && resource.exists()) {
    if (resource.isDirectory()) {
      if (!pathInContext.endsWith("/") && !pathInContext.equals("/")) {
        log.debug("Redirect to directory/");
        String q=request.getQuery();
        URI urifix=new URI(request.getRequestURL().toString());
        urifix.setPath(urifix.getPath());
        StringBuffer buf=new StringBuffer(urifix.toString());
        urifix=null;
        if (q != null && q.length() != 0) {
          buf.append('?');
          buf.append(q);
        }
        response.setField(HttpFields.__Location,URI.addPaths(buf.toString(),"/"));
        response.setStatus(302);
        request.setHandled(true);
        return;
      }
      String welcome=getHttpContext().getWelcomeFile(resource);
      if (welcome != null) {
        String ipath=URI.addPaths(pathInContext,welcome);
        if (_redirectWelcomeFiles) {
          ipath=URI.addPaths(getHttpContext().getContextPath(),ipath);
          response.setContentLength(0);
          response.sendRedirect(ipath);
        }
 else {
          URI uri=request.getURI();
          uri.setPath(URI.addPaths(uri.getPath(),welcome));
          getHttpContext().handle(ipath,pathParams,request,response);
        }
        return;
      }
      if (!passConditionalHeaders(request,response,resource))       return;
      sendDirectory(request,response,resource,pathInContext.length() > 1);
    }
 else     if (resource.exists()) {
      if (!passConditionalHeaders(request,response,resource))       return;
      sendData(request,response,pathInContext,resource,true);
    }
 else     log.warn("Unknown file type");
  }
}
