{
  log("Before lock " + target);
  LockManager.lockIdent(target);
  log("Locked " + target);
  try {
    File identDir=getIdentDir(target);
    expire(identDir);
    File messageFiles[]=identDir.listFiles();
    resp.setStatus(CODE_OK);
    log("Sending back " + (messageFiles.length - 1) + " messages");
    ServletOutputStream out=resp.getOutputStream();
    DataHelper.writeDate(out,new Date(Clock.getInstance().now()));
    DataHelper.writeLong(out,2,messageFiles.length - 1);
    for (int i=0; i < messageFiles.length; i++) {
      if ("identity.dat".equals(messageFiles[i].getName())) {
      }
 else {
        log("Message file " + messageFiles[i].getName() + " is "+ messageFiles[i].length()+ " bytes");
        DataHelper.writeLong(out,4,messageFiles[i].length());
        writeFile(out,messageFiles[i]);
        boolean deleted=messageFiles[i].delete();
        if (!deleted) {
          log("!!!Error removing message file " + messageFiles[i].getAbsolutePath() + " - please delete!");
        }
      }
    }
    out.flush();
    out.close();
  }
 catch (  DataFormatException dfe) {
    log("Error sending message",dfe);
  }
 finally {
    LockManager.unlockIdent(target);
    log("Unlocked " + target);
  }
}
