{
  boolean restartRequired=false;
  if (!_ratesOnly) {
    String oldNHost=_context.router().getConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_HOSTNAME);
    if (oldNHost == null)     oldNHost="";
    String oldNPort=_context.router().getConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_PORT);
    if (oldNPort == null)     oldNPort="";
    String sAutoHost=_context.router().getConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_IP);
    String sAutoPort=_context.router().getConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_PORT);
    boolean oldAutoHost="true".equalsIgnoreCase(sAutoHost);
    boolean oldAutoPort="true".equalsIgnoreCase(sAutoPort);
    if (_ntcpHostname == null)     _ntcpHostname="";
    if (_ntcpPort == null)     _ntcpPort="";
    if (oldAutoHost != _ntcpAutoIP || !oldNHost.equalsIgnoreCase(_ntcpHostname)) {
      if (_ntcpAutoIP) {
        _context.router().setConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_IP,"true");
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_HOSTNAME);
        addFormNotice("Updating inbound TCP address to auto");
      }
 else       if (_ntcpHostname.length() > 0) {
        _context.router().setConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_HOSTNAME,_ntcpHostname);
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_IP);
        addFormNotice("Updating inbound TCP address to " + _ntcpHostname);
      }
 else {
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_HOSTNAME);
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_IP);
        addFormNotice("Disabling inbound TCP");
      }
      restartRequired=true;
    }
    if (oldAutoPort != _ntcpAutoPort || !oldNPort.equals(_ntcpPort)) {
      if (_ntcpAutoPort) {
        _context.router().setConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_PORT,"true");
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_PORT);
        addFormNotice("Updating inbound TCP port to auto");
      }
 else       if (_ntcpPort.length() > 0) {
        _context.router().setConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_PORT,_ntcpPort);
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_PORT);
        addFormNotice("Updating inbound TCP port to " + _ntcpPort);
      }
 else {
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_PORT);
        _context.router().removeConfigSetting(ConfigNetHelper.PROP_I2NP_NTCP_AUTO_PORT);
        addFormNotice("Disabling inbound TCP");
      }
      restartRequired=true;
    }
    if ((_udpPort != null) && (_udpPort.length() > 0)) {
      String oldPort=_context.router().getConfigSetting(ConfigNetHelper.PROP_I2NP_UDP_PORT);
      if ((oldPort == null) && (_udpPort.equals("8887"))) {
      }
 else       if ((oldPort == null) || (!oldPort.equalsIgnoreCase(_udpPort))) {
        _context.router().setConfigSetting(ConfigNetHelper.PROP_I2NP_UDP_PORT,_udpPort);
        addFormNotice("Updating UDP port from " + oldPort + " to "+ _udpPort);
        restartRequired=true;
      }
    }
  }
  updateRates();
  if (!_ratesOnly) {
    if (_sharePct != null) {
      String old=_context.router().getConfigSetting(Router.PROP_BANDWIDTH_SHARE_PERCENTAGE);
      if ((old == null) || (!old.equalsIgnoreCase(_sharePct))) {
        _context.router().setConfigSetting(Router.PROP_BANDWIDTH_SHARE_PERCENTAGE,_sharePct);
        addFormNotice("Updating bandwidth share percentage");
      }
    }
    if (_hiddenMode && "false".equalsIgnoreCase(_context.getProperty(Router.PROP_HIDDEN,"false"))) {
      _context.router().setConfigSetting(Router.PROP_HIDDEN,"true");
      _context.router().addCapabilities(_context.router().getRouterInfo());
      addFormNotice("Gracefully restarting into Hidden Router Mode. Make sure you have no 0-1 length " + "<a href=\"configtunnels.jsp\">tunnels!</a>");
      hiddenSwitch();
    }
    if (!_hiddenMode && "true".equalsIgnoreCase(_context.getProperty(Router.PROP_HIDDEN,"false"))) {
      _context.router().removeConfigSetting(Router.PROP_HIDDEN);
      _context.router().getRouterInfo().delCapability(RouterInfo.CAPABILITY_HIDDEN);
      addFormNotice("Gracefully restarting to exit Hidden Router Mode");
      hiddenSwitch();
    }
    if (_dynamicKeys) {
      _context.router().setConfigSetting(Router.PROP_DYNAMIC_KEYS,"true");
    }
 else {
      _context.router().removeConfigSetting(Router.PROP_DYNAMIC_KEYS);
    }
    if (_requireIntroductions) {
      _context.router().setConfigSetting(UDPTransport.PROP_FORCE_INTRODUCERS,"true");
      addFormNotice("Requiring SSU introduers");
    }
 else {
      _context.router().removeConfigSetting(UDPTransport.PROP_FORCE_INTRODUCERS);
    }
    if (true || _timeSyncEnabled) {
      _context.router().setConfigSetting(Timestamper.PROP_DISABLED,"false");
    }
 else {
      _context.router().setConfigSetting(Timestamper.PROP_DISABLED,"true");
    }
    LoadTestManager.setEnableLoadTesting(_context,_enableLoadTesting);
  }
  boolean saved=_context.router().saveConfig();
  if ((_action != null) && ("Save changes".equals(_action))) {
    if (saved)     addFormNotice("Configuration saved successfully");
 else     addFormNotice("Error saving the configuration (applied but not saved) - please see the error logs");
  }
  if (restartRequired) {
    addFormNotice("Performing a soft restart");
    _context.router().restart();
    addFormNotice("Soft restart complete");
  }
}
