{
  RouterContext ctx=ContextHelper.getContext(null);
  String systemNonce=getNonce();
  if ((nonce != null) && (systemNonce.equals(nonce)) && (action != null)) {
    if ("shutdownImmediate".equals(action) || "Shutdown immediately".equals(action)) {
      ctx.addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_HARD));
      ctx.router().shutdownGracefully(Router.EXIT_HARD);
    }
 else     if ("cancelShutdown".equals(action) || "Cancel shutdown".equals(action)) {
      ctx.router().cancelGracefulShutdown();
    }
 else     if ("restartImmediate".equals(action) || "Restart immediately".equals(action)) {
      ctx.addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_HARD_RESTART));
      ctx.router().shutdownGracefully(Router.EXIT_HARD_RESTART);
    }
 else     if ("restart".equalsIgnoreCase(action)) {
      ctx.addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_GRACEFUL_RESTART));
      ctx.router().shutdownGracefully(Router.EXIT_GRACEFUL_RESTART);
    }
 else     if ("shutdown".equalsIgnoreCase(action)) {
      ctx.addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_GRACEFUL));
      ctx.router().shutdownGracefully();
    }
  }
  boolean shuttingDown=isShuttingDown(ctx);
  boolean restarting=isRestarting(ctx);
  long timeRemaining=ctx.router().getShutdownTimeRemaining();
  if (shuttingDown) {
    if (timeRemaining <= 0) {
      return "<center><b>Shutdown imminent</b></center>";
    }
 else {
      return "<center><b>Shutdown in " + DataHelper.formatDuration(timeRemaining) + "</b></center><br>"+ buttons(urlBase,systemNonce,"shutdownImmediate,Shutdown immediately,cancelShutdown,Cancel shutdown");
    }
  }
 else   if (restarting) {
    if (timeRemaining <= 0) {
      return "<center><b>Restart imminent</b></center>";
    }
 else {
      return "<center><b>Restart in " + DataHelper.formatDuration(timeRemaining) + "</b></center><br>"+ buttons(urlBase,systemNonce,"restartImmediate,Restart immediately,cancelShutdown,Cancel restart");
    }
  }
 else {
    if (System.getProperty("wrapper.version") != null)     return buttons(urlBase,systemNonce,"restart,Restart,shutdown,Shutdown");
 else     return buttons(urlBase,systemNonce,"shutdown,Shutdown");
  }
}
