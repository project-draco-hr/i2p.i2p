{
  RouterContext ctx=ContextHelper.getContext(null);
  String systemNonce=getNonce();
  if ((nonce != null) && (systemNonce.equals(nonce)) && (action != null)) {
    if ("shutdownImmediate".equals(action)) {
      ctx.router().addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_HARD));
      ctx.router().shutdown(Router.EXIT_HARD);
    }
 else     if ("cancelShutdown".equals(action)) {
      ctx.router().cancelGracefulShutdown();
    }
 else     if ("restartImmediate".equals(action)) {
      ctx.router().addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_HARD_RESTART));
      ctx.router().shutdown(Router.EXIT_HARD_RESTART);
    }
 else     if ("restart".equals(action)) {
      ctx.router().addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_GRACEFUL_RESTART));
      ctx.router().shutdownGracefully(Router.EXIT_GRACEFUL_RESTART);
    }
 else     if ("shutdown".equals(action)) {
      ctx.router().addShutdownTask(new ConfigServiceHandler.UpdateWrapperManagerTask(Router.EXIT_GRACEFUL));
      ctx.router().shutdownGracefully();
    }
  }
  boolean shuttingDown=isShuttingDown(ctx);
  boolean restarting=isRestarting(ctx);
  long timeRemaining=ctx.router().getShutdownTimeRemaining();
  if (shuttingDown) {
    if (timeRemaining <= 0) {
      return "<b>Shutdown imminent</b>";
    }
 else {
      return "<b>Shutdown in " + DataHelper.formatDuration(timeRemaining) + "</b><br />"+ "<a href=\""+ urlBase+ "?consoleNonce="+ systemNonce+ "&amp;action=shutdownImmediate\">Shutdown immediately</a><br />"+ "<a href=\""+ urlBase+ "?consoleNonce="+ systemNonce+ "&amp;action=cancelShutdown\">Cancel shutdown</a> ";
    }
  }
 else   if (restarting) {
    if (timeRemaining <= 0) {
      return "<b>Restart imminent</b>";
    }
 else {
      return "<b>Restart in " + DataHelper.formatDuration(timeRemaining) + "</b><br />"+ "<a href=\""+ urlBase+ "?consoleNonce="+ systemNonce+ "&amp;action=restartImmediate\">Restart immediately</a><br />"+ "<a href=\""+ urlBase+ "?consoleNonce="+ systemNonce+ "&amp;action=cancelShutdown\">Cancel restart</a> ";
    }
  }
 else {
    String shutdown="<a href=\"" + urlBase + "?consoleNonce="+ systemNonce+ "&amp;action=shutdown\" title=\"Graceful shutdown\">Shutdown</a>";
    if (System.getProperty("wrapper.version") != null)     return "<a href=\"" + urlBase + "?consoleNonce="+ systemNonce+ "&amp;action=restart\" title=\"Graceful restart\">Restart</a> "+ shutdown;
 else     return shutdown;
  }
}
