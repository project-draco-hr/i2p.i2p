{
  updateStatus("<b>" + _("Plugin downloaded") + "</b>");
  File f=new File(_updateFile);
  File appDir=new File(_context.getAppDir(),PLUGIN_DIR);
  if ((!appDir.exists()) && (!appDir.mkdir())) {
    f.delete();
    statusDone("<b>" + _("Cannot create plugin directory {0}",appDir.getAbsolutePath()) + "</b>");
    return;
  }
  TrustedUpdate up=new TrustedUpdate(_context);
  File to=new File(_context.getTempDir(),"tmp" + _context.random().nextInt() + ZIP);
  String err=up.migrateFile(f,to);
  if (err != null) {
    statusDone("<b>" + err + ' '+ _("from {0}",url)+ " </b>");
    f.delete();
    to.delete();
    return;
  }
  File tempDir=new File(_context.getTempDir(),"tmp" + _context.random().nextInt() + "-unzip");
  if (!FileUtil.extractZip(to,tempDir)) {
    f.delete();
    to.delete();
    FileUtil.rmdir(tempDir,false);
    statusDone("<b>" + _("Plugin from {0} is corrupt",url) + "</b>");
    return;
  }
  File installProps=new File(tempDir,"plugin.config");
  Properties props=new OrderedProperties();
  try {
    DataHelper.loadProps(props,installProps);
  }
 catch (  IOException ioe) {
    f.delete();
    to.delete();
    FileUtil.rmdir(tempDir,false);
    statusDone("<b>" + _("Plugin from {0} does not contain the required configuration file",url) + "</b>");
    return;
  }
  FileUtil.rmdir(tempDir,false);
  String pubkey=props.getProperty("key");
  String signer=props.getProperty("signer");
  if (pubkey == null || signer == null || pubkey.length() != 172 || signer.length() <= 0) {
    f.delete();
    to.delete();
    statusDone("<b>" + _("Plugin from {0} contains an invalid key",url) + "</b>");
    return;
  }
  Map<String,String> existingKeys=PluginStarter.getPluginKeys(_context);
  for (  Map.Entry<String,String> e : existingKeys.entrySet()) {
    up.addKey(e.getKey(),e.getValue());
  }
  if (up.haveKey(pubkey)) {
    String signingKeyName=up.verifyAndGetSigner(f);
    if (!signer.equals(signingKeyName)) {
      f.delete();
      to.delete();
      statusDone("<b>" + _("Plugin signature verification of {0} failed",url) + "</b>");
      return;
    }
  }
 else {
    if (!up.addKey(pubkey,signer)) {
      f.delete();
      to.delete();
      statusDone("<b>" + _("Plugin signature verification of {0} failed",url) + "</b>");
      return;
    }
    String signingKeyName=up.verifyAndGetSigner(f);
    if (!signer.equals(signingKeyName)) {
      f.delete();
      to.delete();
      statusDone("<b>" + _("Plugin signature verification of {0} failed",url) + "</b>");
      return;
    }
  }
  String sudVersion=TrustedUpdate.getVersionString(f);
  f.delete();
  String appName=props.getProperty("name");
  String version=props.getProperty("version");
  if (appName == null || version == null || appName.length() <= 0 || version.length() <= 0 || appName.indexOf("<") >= 0 || appName.indexOf(">") >= 0 || version.indexOf("<") >= 0 || version.indexOf(">") >= 0 || appName.startsWith(".") || appName.indexOf("/") >= 0 || appName.indexOf("\\") >= 0) {
    to.delete();
    statusDone("<b>" + _("Plugin from {0} has invalid name or version",url) + "</b>");
    return;
  }
  if (!version.equals(sudVersion)) {
    to.delete();
    statusDone("<b>" + _("Plugin {0} has mismatched versions",appName) + "</b>");
    return;
  }
  String minVersion=ConfigClientsHelper.stripHTML(props,"min-i2p-version");
  if (minVersion != null && (new VersionComparator()).compare(CoreVersion.VERSION,minVersion) < 0) {
    to.delete();
    statusDone("<b>" + _("This plugin requires I2P version {0} or higher",minVersion) + "</b>");
    return;
  }
  minVersion=ConfigClientsHelper.stripHTML(props,"min-java-version");
  if (minVersion != null && (new VersionComparator()).compare(System.getProperty("java.version"),minVersion) < 0) {
    to.delete();
    statusDone("<b>" + _("This plugin requires Java version {0} or higher",minVersion) + "</b>");
    return;
  }
  File destDir=new File(appDir,appName);
  if (destDir.exists()) {
    if (Boolean.valueOf(props.getProperty("install-only")).booleanValue()) {
      to.delete();
      statusDone("<b>" + _("Downloaded plugin is for new installs only, but the plugin is already installed",url) + "</b>");
      return;
    }
    File oldPropFile=new File(destDir,"plugin.config");
    Properties oldProps=new OrderedProperties();
    try {
      DataHelper.loadProps(oldProps,oldPropFile);
    }
 catch (    IOException ioe) {
      to.delete();
      FileUtil.rmdir(tempDir,false);
      statusDone("<b>" + _("Installed plugin does not contain the required configuration file",url) + "</b>");
      return;
    }
    String oldPubkey=oldProps.getProperty("key");
    String oldKeyName=oldProps.getProperty("signer");
    String oldAppName=props.getProperty("name");
    if ((!pubkey.equals(oldPubkey)) || (!signer.equals(oldKeyName)) || (!appName.equals(oldAppName))) {
      to.delete();
      statusDone("<b>" + _("Signature of downloaded plugin does not match installed plugin") + "</b>");
      return;
    }
    String oldVersion=oldProps.getProperty("version");
    if (oldVersion == null || (new VersionComparator()).compare(oldVersion,version) >= 0) {
      to.delete();
      statusDone("<b>" + _("Downloaded plugin version {0} is not newer than installed plugin",version) + "</b>");
      return;
    }
    minVersion=ConfigClientsHelper.stripHTML(props,"min-installed-version");
    if (minVersion != null && (new VersionComparator()).compare(minVersion,oldVersion) > 0) {
      to.delete();
      statusDone("<b>" + _("Plugin update requires installed plugin version {0} or higher",minVersion) + "</b>");
      return;
    }
    String maxVersion=ConfigClientsHelper.stripHTML(props,"max-installed-version");
    if (maxVersion != null && (new VersionComparator()).compare(maxVersion,oldVersion) < 0) {
      to.delete();
      statusDone("<b>" + _("Plugin update requires installed plugin version {0} or lower",maxVersion) + "</b>");
      return;
    }
    try {
      if (!PluginStarter.stopPlugin(_context,appName)) {
      }
    }
 catch (    Throwable e) {
      _log.error("Error stopping plugin " + appName,e);
    }
  }
 else {
    if (Boolean.valueOf(props.getProperty("update-only")).booleanValue()) {
      to.delete();
      statusDone("<b>" + _("Plugin is for upgrades only, but the plugin is not installed") + "</b>");
      return;
    }
    if (!destDir.mkdir()) {
      to.delete();
      statusDone("<b>" + _("Cannot create plugin directory {0}",destDir.getAbsolutePath()) + "</b>");
      return;
    }
  }
  if (!FileUtil.extractZip(to,destDir)) {
    to.delete();
    statusDone("<b>" + _("Failed to install plugin in {0}",destDir.getAbsolutePath()) + "</b>");
    return;
  }
  to.delete();
  if (Boolean.valueOf(props.getProperty("dont-start-at-install")).booleanValue()) {
    if (Boolean.valueOf(props.getProperty("router-restart-required")).booleanValue())     statusDone("<b>" + _("Plugin {0} installed, router restart required",appName) + "</b>");
 else {
      statusDone("<b>" + _("Plugin {0} installed",appName) + "</b>");
      Properties pluginProps=PluginStarter.pluginProperties();
      pluginProps.setProperty(PluginStarter.PREFIX + appName + PluginStarter.ENABLED,"false");
      PluginStarter.storePluginProperties(pluginProps);
    }
  }
 else {
    try {
      if (PluginStarter.startPlugin(_context,appName))       statusDone("<b>" + _("Plugin {0} installed and started",appName) + "</b>");
 else       statusDone("<b>" + _("Plugin {0} installed but failed to start, check logs",appName) + "</b>");
    }
 catch (    Throwable e) {
      statusDone("<b>" + _("Plugin {0} installed but failed to start",appName) + ": "+ e+ "</b>");
      _log.error("Error starting plugin " + appName,e);
    }
  }
}
