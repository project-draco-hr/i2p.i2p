{
  long end=_listener.now() - 60 * 1000;
  if (periodCount <= 0)   periodCount=SummaryListener.PERIODS;
  if (periodCount > SummaryListener.PERIODS)   periodCount=SummaryListener.PERIODS;
  long start=end - _listener.getRate().getPeriod() * periodCount;
  try {
    RrdGraphDef def=new RrdGraphDef();
    def.setTimeSpan(start / 1000,end / 1000);
    def.setMinValue(0d);
    String name=_listener.getRate().getRateStat().getName();
    if ((name.startsWith("bw.") || name.indexOf("Size") >= 0 || name.indexOf("Bps") >= 0 || name.indexOf("memory") >= 0) && !showEvents)     def.setBase(1024);
    if (!hideTitle) {
      String title;
      String p;
      if ("zh".equals(Messages.getLanguage(_context)))       p=DataHelper.formatDuration(_listener.getRate().getPeriod());
 else       p=DataHelper.formatDuration2(_listener.getRate().getPeriod()).replace("&nbsp;"," ");
      if (showEvents)       title=name + ' ' + _("events in {0}",p);
 else       title=name + ' ' + _("averaged for {0}",p);
      def.setTitle(title);
    }
    String path=_listener.getData().getPath();
    String dsNames[]=_listener.getData().getDsNames();
    String plotName=null;
    String descr=null;
    if (showEvents) {
      plotName=dsNames[1];
      descr=_("Events per period");
    }
 else {
      plotName=dsNames[0];
      descr=_(_listener.getRate().getRateStat().getDescription());
    }
    long started=((RouterContext)_context).router().getWhenStarted();
    if (started > start && started < end)     def.vrule(started / 1000,Color.BLACK,_("Restart"),4.0f);
    def.datasource(plotName,path,plotName,"AVERAGE",_listener.getBackendName());
    def.area(plotName,Color.BLUE,descr + "\\r");
    if (!hideLegend) {
      def.gprint(plotName,"AVERAGE",_("avg") + ": %.2f %s");
      def.gprint(plotName,"MAX",' ' + _("max") + ": %.2f %S");
      def.gprint(plotName,"LAST",' ' + _("now") + ": %.2f %S\\r");
    }
    if (!showCredit)     def.setShowSignature(false);
    if (hideLegend)     def.setNoLegend(true);
    if (hideGrid) {
      def.setDrawXGrid(false);
      def.setDrawYGrid(false);
    }
    def.setAntiAliasing(false);
    def.setWidth(width);
    def.setHeight(height);
    RrdGraph graph=new RrdGraph(def);
    int totalWidth=graph.getRrdGraphInfo().getWidth();
    int totalHeight=graph.getRrdGraphInfo().getHeight();
    BufferedImage img=new BufferedImage(totalWidth,totalHeight,BufferedImage.TYPE_USHORT_565_RGB);
    Graphics gfx=img.getGraphics();
    graph.render(gfx);
    ImageOutputStream ios=new MemoryCacheImageOutputStream(out);
    ImageIO.write(img,"png",ios);
  }
 catch (  RrdException re) {
    _log.error("Error rendering",re);
    throw new IOException("Error plotting: " + re.getMessage());
  }
catch (  IOException ioe) {
    _log.error("Error rendering",ioe);
    throw ioe;
  }
catch (  OutOfMemoryError oom) {
    _log.error("Error rendering",oom);
    throw new IOException("Error plotting: " + oom.getMessage());
  }
}
