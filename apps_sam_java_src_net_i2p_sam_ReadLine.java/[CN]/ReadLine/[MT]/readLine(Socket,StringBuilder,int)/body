{
  if (timeout <= 0)   throw new SocketTimeoutException();
  long expires=System.currentTimeMillis() + timeout;
  InputStream in=socket.getInputStream();
  int c;
  int i=0;
  socket.setSoTimeout(timeout);
  while ((c=in.read()) != -1) {
    if (++i > MAX_LINE_LENGTH)     throw new LineTooLongException("Line too long - max " + MAX_LINE_LENGTH);
    if (c == '\n')     break;
    int newTimeout=(int)(expires - System.currentTimeMillis());
    if (newTimeout <= 0)     throw new SocketTimeoutException();
    buf.append((char)c);
    if (newTimeout != timeout) {
      timeout=newTimeout;
      socket.setSoTimeout(timeout);
    }
  }
  if (c == -1) {
    if (System.currentTimeMillis() >= expires)     throw new SocketTimeoutException();
 else     throw new EOFException();
  }
}
