{
  BufferedReader br;
  StringTokenizer tok;
  try {
    br=new BufferedReader(new InputStreamReader(s.getInputStream(),"ISO-8859-1"));
    tok=new StringTokenizer(br.readLine()," ");
  }
 catch (  IOException e) {
    throw new SAMException("Error reading from socket: " + e.getMessage());
  }
catch (  Exception e) {
    throw new SAMException("Unexpected error: " + e.getMessage());
  }
  if (tok.countTokens() != 4) {
    throw new SAMException("Bad format in HELLO message");
  }
  if (!tok.nextToken().equals("HELLO")) {
    throw new SAMException("Bad domain in HELLO message");
  }
{
    String opcode;
    if (!(opcode=tok.nextToken()).equals("VERSION")) {
      throw new SAMException("Unrecognized HELLO message opcode: \"" + opcode + "\"");
    }
  }
  Properties props;
  props=SAMUtils.parseParams(tok);
  if (props == null) {
    throw new SAMException("No parameters in HELLO VERSION message");
  }
  String minVer=props.getProperty("MIN");
  if (minVer == null) {
    throw new SAMException("Missing MIN parameter in HELLO VERSION message");
  }
  String maxVer=props.getProperty("MAX");
  if (maxVer == null) {
    throw new SAMException("Missing MAX parameter in HELLO VERSION message");
  }
  String ver=chooseBestVersion(minVer,maxVer);
  if (ver == null) {
    try {
      OutputStream out=s.getOutputStream();
      out.write("HELLO REPLY RESULT=NOVERSION\n".getBytes("ISO-8859-1"));
      return null;
    }
 catch (    UnsupportedEncodingException e) {
      _log.error("Caught UnsupportedEncodingException (" + e.getMessage() + ")");
      throw new SAMException("Character encoding error: " + e.getMessage());
    }
catch (    IOException e) {
      throw new SAMException("Error reading from socket: " + e.getMessage());
    }
  }
  try {
    OutputStream out=s.getOutputStream();
    out.write(("HELLO REPLY RESULT=OK VERSION=" + ver + "\n").getBytes("ISO-8859-1"));
  }
 catch (  UnsupportedEncodingException e) {
    _log.error("Caught UnsupportedEncodingException (" + e.getMessage() + ")");
    throw new SAMException("Character encoding error: " + e.getMessage());
  }
catch (  IOException e) {
    throw new SAMException("Error writing to socket: " + e.getMessage());
  }
  int verMajor=getMajor(ver);
  int verMinor=getMinor(ver);
  SAMHandler handler;
switch (verMajor) {
case 1:
    handler=new SAMv1Handler(s,verMajor,verMinor);
  break;
default :
_log.error("BUG! Trying to initialize the wrong SAM version!");
throw new SAMException("BUG triggered! (handler instantiation)");
}
return handler;
}
