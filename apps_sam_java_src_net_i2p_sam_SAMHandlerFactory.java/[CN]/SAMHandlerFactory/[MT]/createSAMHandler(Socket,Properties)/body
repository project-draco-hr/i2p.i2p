{
  BufferedReader br;
  String line;
  StringTokenizer tok;
  try {
    br=new BufferedReader(new InputStreamReader(s.getInputStream(),"ISO-8859-1"));
    line=br.readLine();
    if (line == null) {
      _log.debug("Connection closed by client");
      return null;
    }
    tok=new StringTokenizer(line," ");
  }
 catch (  IOException e) {
    throw new SAMException("Error reading from socket: " + e.getMessage());
  }
catch (  Exception e) {
    throw new SAMException("Unexpected error: " + e.getMessage());
  }
  if (tok.countTokens() != 4) {
    throw new SAMException("Bad format in HELLO message");
  }
  if (!tok.nextToken().equals("HELLO")) {
    throw new SAMException("Bad domain in HELLO message");
  }
{
    String opcode;
    if (!(opcode=tok.nextToken()).equals("VERSION")) {
      throw new SAMException("Unrecognized HELLO message opcode: '" + opcode + "'");
    }
  }
  Properties props;
  props=SAMUtils.parseParams(tok);
  if (props == null) {
    throw new SAMException("No parameters in HELLO VERSION message");
  }
  String minVer=props.getProperty("MIN");
  if (minVer == null) {
    throw new SAMException("Missing MIN parameter in HELLO VERSION message");
  }
  String maxVer=props.getProperty("MAX");
  if (maxVer == null) {
    throw new SAMException("Missing MAX parameter in HELLO VERSION message");
  }
  String ver=chooseBestVersion(minVer,maxVer);
  if (ver == null)   throw new SAMException("No version specified");
  try {
    OutputStream out=s.getOutputStream();
    out.write(("HELLO REPLY RESULT=OK VERSION=" + ver + "\n").getBytes("ISO-8859-1"));
  }
 catch (  UnsupportedEncodingException e) {
    _log.error("Caught UnsupportedEncodingException (" + e.getMessage() + ")");
    throw new SAMException("Character encoding error: " + e.getMessage());
  }
catch (  IOException e) {
    throw new SAMException("Error writing to socket: " + e.getMessage());
  }
  int verMajor=getMajor(ver);
  int verMinor=getMinor(ver);
  SAMHandler handler;
  try {
switch (verMajor) {
case 1:
      handler=new SAMv1Handler(s,verMajor,verMinor,i2cpProps);
    break;
default :
  _log.error("BUG! Trying to initialize the wrong SAM version!");
throw new SAMException("BUG! (in handler instantiation)");
}
}
 catch (IOException e) {
_log.error("Error creating the v1 handler",e);
throw new SAMException("IOException caught during SAM handler instantiation");
}
return handler;
}
