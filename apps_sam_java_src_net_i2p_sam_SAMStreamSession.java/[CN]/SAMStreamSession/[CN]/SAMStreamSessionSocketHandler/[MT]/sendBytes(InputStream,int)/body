{
  if (_log.shouldLog(Log.DEBUG)) {
    _log.debug("Handler " + id + ": sending "+ size+ " bytes");
  }
  ByteCache cache=ByteCache.getInstance(1024,4);
  ByteArray ba=cache.acquire();
  int remaining=size;
  try {
    byte buf[]=ba.getData();
    while (remaining > 0) {
      int read=in.read(buf,0,remaining > buf.length ? buf.length : remaining);
      if (read == -1) {
        throw new IOException("Insufficient data from the SAM client (" + remaining + "/"+ size+ ")");
      }
 else       if (read > 0) {
        remaining-=read;
        try {
          i2pSocketOS.write(buf,0,read);
        }
 catch (        IOException ioe) {
          if (_log.shouldLog(Log.WARN))           _log.warn("Stream failed",ioe);
          removeSocketHandler(id);
          for (int i=remaining; i > 0; i--) {
            int c=in.read();
            if (c == -1)             throw new IOException("Stream closed, but the SAM client didn't send enough anyway (" + i + " remaining)");
          }
          return false;
        }
      }
    }
  }
  finally {
    cache.release(ba);
  }
  return true;
}
