{
  _context=ctx;
  _connectionManager=manager;
  _chooser=chooser;
  _outboundQueue=queue;
  _handler=handler;
  _log=_context.logManager().getLog(Connection.class);
  _receiver=new ConnectionDataReceiver(_context,this);
  _inputStream=new MessageInputStream(_context);
  _outputStream=new MessageOutputStream(_context,_receiver,(opts == null ? Packet.MAX_PAYLOAD_SIZE : opts.getMaxMessageSize()));
  _outboundPackets=new TreeMap();
  if (opts != null) {
    _localPort=opts.getLocalPort();
    _remotePort=opts.getPort();
  }
  _options=(opts != null ? opts : new ConnectionOptions());
  _outputStream.setWriteTimeout((int)_options.getWriteTimeout());
  _inputStream.setReadTimeout((int)_options.getReadTimeout());
  _lastSendId=new AtomicLong(-1);
  _nextSendTime=-1;
  _createdOn=_context.clock().now();
  _closeSentOn=-1;
  _closeReceivedOn=-1;
  _congestionWindowEnd=_options.getWindowSize() - 1;
  _highestAckedThrough=-1;
  _lastCongestionSeenAt=MAX_WINDOW_SIZE * 2;
  _lastCongestionTime=-1;
  _lastCongestionHighestUnacked=-1;
  _connected=true;
  _disconnectScheduledOn=-1;
  _lastReceivedOn=-1;
  _activityTimer=new ActivityTimer();
  _ackSinceCongestion=true;
  _connectLock=new Object();
  _resetSentOn=-1;
  _connectionEvent=new ConEvent();
  _randomWait=_context.random().nextInt(10 * 1000);
  _context.statManager().createRateStat("stream.con.windowSizeAtCongestion","How large was our send window when we send a dup?","Stream",new long[]{60 * 1000,10 * 60 * 1000,60 * 60 * 1000});
  _context.statManager().createRateStat("stream.chokeSizeBegin","How many messages were outstanding when we started to choke?","Stream",new long[]{60 * 1000,10 * 60 * 1000,60 * 60 * 1000});
  _context.statManager().createRateStat("stream.chokeSizeEnd","How many messages were outstanding when we stopped being choked?","Stream",new long[]{60 * 1000,10 * 60 * 1000,60 * 60 * 1000});
  _context.statManager().createRateStat("stream.fastRetransmit","How long a packet has been around for if it has been resent per the fast retransmit timer?","Stream",new long[]{60 * 1000,10 * 60 * 1000});
  if (_log.shouldLog(Log.INFO))   _log.info("New connection created with options: " + _options);
}
