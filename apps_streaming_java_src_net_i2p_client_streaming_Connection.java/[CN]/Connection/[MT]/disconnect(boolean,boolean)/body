{
  if (!_connected)   return;
  _connected=false;
synchronized (_connectLock) {
    _connectLock.notifyAll();
  }
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Disconnecting " + toString(),new Exception("discon"));
  if (cleanDisconnect) {
    _outputStream.closeInternal();
    _inputStream.close();
  }
 else {
    doClose();
    boolean tagsCancelled=false;
synchronized (_outboundPackets) {
      for (Iterator iter=_outboundPackets.values().iterator(); iter.hasNext(); ) {
        PacketLocal pl=(PacketLocal)iter.next();
        if ((pl.getTagsSent() != null) && (pl.getTagsSent().size() > 0))         tagsCancelled=true;
        pl.cancelled();
      }
      _outboundPackets.clear();
      _outboundPackets.notifyAll();
    }
    if (tagsCancelled)     _context.sessionKeyManager().failTags(_remotePeer.getPublicKey());
  }
  if (removeFromConMgr) {
    if (!_disconnectScheduled) {
      _disconnectScheduled=true;
      SimpleTimer.getInstance().addEvent(new DisconnectEvent(),DISCONNECT_TIMEOUT);
    }
  }
}
