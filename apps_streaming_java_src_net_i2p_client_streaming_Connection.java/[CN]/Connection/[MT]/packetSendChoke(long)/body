{
  if (false)   return true;
  long start=_context.clock().now();
  long writeExpire=start + timeoutMs;
  boolean started=false;
  while (true) {
    long timeLeft=writeExpire - _context.clock().now();
synchronized (_outboundPackets) {
      if (!started)       _context.statManager().addRateData("stream.chokeSizeBegin",_outboundPackets.size(),timeoutMs);
      started=true;
      if ((_outboundPackets.size() >= _options.getWindowSize()) || (_activeResends > 0) || (_lastSendId - _highestAckedThrough > _options.getWindowSize())) {
        if (timeoutMs > 0) {
          if (timeLeft <= 0) {
            if (_log.shouldLog(Log.INFO))             _log.info("Outbound window is full of " + _outboundPackets.size() + " with "+ _activeResends+ " active resends"+ " and we've waited too long ("+ (0 - (timeLeft - timeoutMs))+ "ms): "+ toString());
            return false;
          }
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Outbound window is full (" + _outboundPackets.size() + "/"+ _options.getWindowSize()+ "/"+ _activeResends+ "), waiting "+ timeLeft);
          try {
            _outboundPackets.wait(timeLeft);
          }
 catch (          InterruptedException ie) {
          }
        }
 else {
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Outbound window is full (" + _outboundPackets.size() + "/"+ _activeResends+ "), waiting indefinitely");
          try {
            _outboundPackets.wait();
          }
 catch (          InterruptedException ie) {
          }
        }
      }
 else {
        _context.statManager().addRateData("stream.chokeSizeEnd",_outboundPackets.size(),_context.clock().now() - start);
        return true;
      }
    }
  }
}
