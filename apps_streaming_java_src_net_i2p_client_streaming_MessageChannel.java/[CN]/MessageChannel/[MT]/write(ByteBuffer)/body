{
  int written=0;
  for (; ; ) {
    if (buf.remaining() == 0)     return written;
    byte[] lbuf=new byte[Math.min(buf.remaining(),0x1000)];
    buf.get(lbuf);
    try {
      out.write(lbuf,0,lbuf.length);
      written+=lbuf.length;
    }
 catch (    InterruptedIOException ex) {
      buf.put(lbuf);
      return written;
    }
  }
}
