{
  int size=0;
  if (packet.shouldSign())   size=packet.writeSignedPacket(_buf,0,_context,_session.getPrivateKey());
 else   size=packet.writePacket(_buf,0);
  SessionKey keyUsed=packet.getKeyUsed();
  if (keyUsed == null)   keyUsed=new SessionKey();
  Set tagsSent=packet.getTagsSent();
  if (tagsSent == null)   tagsSent=new HashSet();
  try {
    boolean sent=_session.sendMessage(packet.getTo(),_buf,0,size,keyUsed,tagsSent);
    if (!sent) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Send failed for " + packet);
    }
 else {
      packet.setKeyUsed(keyUsed);
      packet.setTagsSent(tagsSent);
      packet.incrementSends();
      if (_log.shouldLog(Log.DEBUG)) {
        String msg=packet + " sent" + (tagsSent.size() > 0 ? " with " + tagsSent.size() + " tags" : "")+ " send # "+ packet.getNumSends();
        _log.debug(msg);
      }
    }
  }
 catch (  I2PSessionException ise) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Unable to send the packet " + packet,ise);
  }
}
