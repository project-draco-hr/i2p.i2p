{
  List<POP3Request> fetches=new ArrayList<POP3Request>();
  for (  MailRequest mr : requests) {
    Mail mail=null, newMail=null;
    String uidl=mr.getUIDL();
    boolean headerOnly=mr.getHeaderOnly();
synchronized (mails) {
      mail=mails.get(uidl);
      if (mail == null) {
        newMail=new Mail(uidl);
        mails.put(uidl,newMail);
      }
    }
    if (mail == null) {
      mail=newMail;
      mail.setSize(mailbox.getSize(uidl));
    }
    if (mail.markForDeletion)     continue;
    mr.setMail(mail);
    int sz=mail.getSize();
    if (sz > 0 && sz <= FETCH_ALL_SIZE)     headerOnly=false;
    if (headerOnly) {
      if (!mail.hasHeader()) {
        if (disk != null) {
          if (disk.getMail(mail,true)) {
            Debug.debug(Debug.DEBUG,"Loaded header from disk cache: " + uidl);
            continue;
          }
        }
        POP3Request pr=new POP3Request(mr,mail,true);
        fetches.add(pr);
      }
    }
 else {
      if (!mail.hasBody()) {
        if (disk != null) {
          if (disk.getMail(mail,false)) {
            Debug.debug(Debug.DEBUG,"Loaded body from disk cache: " + uidl);
            continue;
          }
        }
        POP3Request pr=new POP3Request(mr,mail,false);
        fetches.add(pr);
      }
    }
  }
  if (!fetches.isEmpty()) {
    List foo=fetches;
    List<FetchRequest> bar=foo;
    mailbox.getBodies(bar);
    for (    POP3Request pr : fetches) {
      ReadBuffer rb=pr.buf;
      if (rb != null) {
        Mail mail=pr.mail;
        if (pr.getHeaderOnly()) {
          mail.setHeader(rb);
        }
 else {
          mail.setBody(rb);
        }
        if (disk != null) {
          if (disk.saveMail(mail) && mail.hasBody()) {
          }
        }
      }
    }
  }
}
