{
  List<POP3Request> fetches=new ArrayList<POP3Request>();
  for (  MailRequest mr : requests) {
    Mail mail=null, newMail=null;
    String uidl=mr.getUIDL();
    boolean headerOnly=mr.getHeaderOnly();
synchronized (mails) {
      mail=mails.get(uidl);
      if (mail == null) {
        newMail=new Mail();
        mails.put(uidl,newMail);
      }
    }
    if (mail == null) {
      mail=newMail;
      mail.uidl=uidl;
      mail.size=mailbox.getSize(uidl);
    }
    if (!mail.deleted) {
      mr.setMail(mail);
      if (mail.size <= FETCH_ALL_SIZE)       headerOnly=false;
      if (headerOnly) {
        if (mail.header == null) {
          POP3Request pr=new POP3Request(mr,mail,true);
          fetches.add(pr);
        }
      }
 else {
        if (mail.body == null) {
          POP3Request pr=new POP3Request(mr,mail,false);
          fetches.add(pr);
        }
      }
    }
  }
  if (!fetches.isEmpty()) {
    List foo=fetches;
    List<FetchRequest> bar=foo;
    mailbox.getBodies(bar);
    for (    POP3Request pr : fetches) {
      ReadBuffer rb=pr.buf;
      if (rb != null) {
        Mail mail=pr.mail;
        boolean parseHeaders=mail.header == null;
        if (pr.getHeaderOnly()) {
          mail.header=rb;
        }
 else {
          mail.header=rb;
          mail.body=rb;
          MailPart.parse(mail);
        }
        if (parseHeaders)         mail.parseHeaders();
      }
    }
  }
}
