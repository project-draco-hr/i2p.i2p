{
  String theme=Config.getProperty(CONFIG_THEME,DEFAULT_THEME);
  I2PAppContext ctx=I2PAppContext.getGlobalContext();
  boolean universalTheming=ctx.getBooleanProperty(RC_PROP_UNIVERSAL_THEMING);
  if (universalTheming) {
    theme=ctx.getProperty(RC_PROP_THEME,DEFAULT_THEME);
    String[] themes=getThemes();
    boolean themeExists=false;
    for (int i=0; i < themes.length; i++) {
      if (themes[i].equals(theme))       themeExists=true;
    }
    if (!themeExists) {
      theme=DEFAULT_THEME;
    }
  }
  httpRequest.setCharacterEncoding("UTF-8");
  response.setCharacterEncoding("UTF-8");
  response.setHeader("X-Frame-Options","SAMEORIGIN");
  RequestWrapper request=new RequestWrapper(httpRequest);
  SessionObject sessionObject=null;
  String subtitle="";
  HttpSession httpSession=request.getSession(true);
  sessionObject=getSessionObject(httpSession);
synchronized (sessionObject) {
    sessionObject.error="";
    sessionObject.info="";
    sessionObject.pageChanged=false;
    sessionObject.showAttachment=null;
    sessionObject.themePath="/themes/susimail/" + theme + '/';
    sessionObject.imgPath=sessionObject.themePath + "images/";
    processStateChangeButtons(sessionObject,request);
    if (sessionObject.state != STATE_AUTH)     processGenericButtons(sessionObject,request);
    if (sessionObject.state == STATE_LIST) {
      processFolderButtons(sessionObject,request);
      for (Iterator it=sessionObject.folder.currentPageIterator(); it != null && it.hasNext(); ) {
        String uidl=(String)it.next();
        Mail mail=sessionObject.mailCache.getMail(uidl,MailCache.FETCH_HEADER);
        if (mail != null && mail.error.length() > 0) {
          sessionObject.error+=mail.error;
          mail.error="";
        }
      }
    }
    if (sessionObject.state == STATE_SHOW) {
      processMessageButtons(sessionObject,request);
      Mail mail=sessionObject.mailCache.getMail(sessionObject.showUIDL,MailCache.FETCH_ALL);
      if (mail != null && mail.error.length() > 0) {
        sessionObject.error+=mail.error;
        mail.error="";
      }
    }
    if (sessionObject.state == STATE_NEW)     processComposeButtons(sessionObject,request);
    if (sessionObject.state != STATE_AUTH)     sessionObject.folder.setElements(sessionObject.mailbox.getUIDLs());
    if (!sendAttachment(sessionObject,response)) {
      PrintWriter out=response.getWriter();
      if (sessionObject.state == STATE_AUTH)       subtitle=_("Login");
 else       if (sessionObject.state == STATE_LIST)       subtitle=ngettext("1 Message","{0} Messages",sessionObject.mailbox.getNumMails());
 else       if (sessionObject.state == STATE_SHOW)       subtitle=_("Show Message");
      response.setContentType("text/html");
      out.println("<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n<html>\n" + "<head>\n" + "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n"+ "<title>susimail - " + subtitle + "</title>\n"+ "<link rel=\"stylesheet\" type=\"text/css\" href=\""+ sessionObject.themePath+ "susimail.css\">\n"+ "</head>\n<body>\n"+ "<div class=\"page\"><p><img src=\""+ sessionObject.imgPath+ "susimail.png\" alt=\"Susimail\"><br>&nbsp;</p>\n"+ "<form method=\"POST\" enctype=\"multipart/form-data\" action=\""+ myself+ "\">");
      if (sessionObject.error != null && sessionObject.error.length() > 0) {
        out.println("<p class=\"error\">" + sessionObject.error + "</p>");
      }
      if (sessionObject.info != null && sessionObject.info.length() > 0) {
        out.println("<p class=\"info\">" + sessionObject.info + "</p>");
      }
      if (sessionObject.state == STATE_AUTH)       showLogin(out);
 else       if (sessionObject.state == STATE_LIST)       showFolder(out,sessionObject,request);
 else       if (sessionObject.state == STATE_SHOW)       showMessage(out,sessionObject);
 else       if (sessionObject.state == STATE_NEW)       showCompose(out,sessionObject,request);
      out.println("</form><div id=\"footer\"><hr><p class=\"footer\">susimail v0." + version + " "+ (RELEASE ? "release" : "development")+ " &copy; 2004-2005 <a href=\"mailto:susi23@mail.i2p\">susi</a></div></div></body>\n</html>");
      out.flush();
    }
  }
}
