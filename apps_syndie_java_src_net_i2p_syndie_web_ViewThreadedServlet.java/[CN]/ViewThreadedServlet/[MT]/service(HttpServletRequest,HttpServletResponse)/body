{
  req.setCharacterEncoding("UTF-8");
  resp.setCharacterEncoding("UTF-8");
  resp.setContentType("text/html");
  User user=(User)req.getSession().getAttribute("user");
  String login=req.getParameter("login");
  String pass=req.getParameter("password");
  String action=req.getParameter("action");
  boolean forceNewIndex=false;
  if (req.getParameter("regenerateIndex") != null)   forceNewIndex=true;
  if (user == null) {
    if ("Login".equals(action)) {
      user=BlogManager.instance().login(login,pass);
      if (!user.getAuthenticated())       user.invalidate();
    }
 else {
      user=new User();
    }
    forceNewIndex=true;
  }
 else   if ("Login".equals(action)) {
    user=BlogManager.instance().login(login,pass);
    forceNewIndex=true;
  }
 else   if ("Logout".equals(action)) {
    user=new User();
    forceNewIndex=true;
  }
  req.getSession().setAttribute("user",user);
  if (user.getAuthenticated()) {
    String loc=req.getParameter(ThreadedHTMLRenderer.PARAM_ADD_TO_GROUP_LOCATION);
    String group=req.getParameter(ThreadedHTMLRenderer.PARAM_ADD_TO_GROUP_NAME);
    if ((loc != null) && (group != null) && (group.trim().length() > 0)) {
      try {
        Hash key=new Hash();
        key.fromBase64(loc);
        PetNameDB db=user.getPetNameDB();
        PetName pn=db.getByLocation(loc);
        boolean isNew=false;
        if (pn == null) {
          isNew=true;
          BlogInfo info=BlogManager.instance().getArchive().getBlogInfo(key);
          String name=null;
          if (info != null)           name=info.getProperty(BlogInfo.NAME);
 else           name=loc.substring(0,6);
          if (db.containsName(name)) {
            int i=0;
            while (db.containsName(name + i))             i++;
            name=name + i;
          }
          pn=new PetName(name,"syndie","syndieblog",loc);
        }
        pn.addGroup(group);
        if (isNew)         db.add(pn);
        BlogManager.instance().saveUser(user);
        if (FilteredThreadIndex.GROUP_IGNORE.equals(group))         forceNewIndex=true;
      }
 catch (      DataFormatException dfe) {
      }
    }
  }
  FilteredThreadIndex index=(FilteredThreadIndex)req.getSession().getAttribute("threadIndex");
  Collection tags=getFilteredTags(req);
  if (forceNewIndex || (index == null) || (!index.getFilteredTags().equals(tags))) {
    index=new FilteredThreadIndex(user,BlogManager.instance().getArchive(),getFilteredTags(req));
    req.getSession().setAttribute("threadIndex",index);
  }
  render(user,req,resp.getWriter(),index);
}
