{
  if (props != null) {
    OrderedProperties p=new OrderedProperties();
    p.putAll(props);
    ByteArrayOutputStream baos=new ByteArrayOutputStream(p.size() * 64);
    for (Iterator iter=p.keySet().iterator(); iter.hasNext(); ) {
      String key=(String)iter.next();
      String val=p.getProperty(key);
      if (utf8)       writeStringUTF8(baos,key);
 else       writeString(baos,key);
      baos.write(EQUAL_BYTES);
      if (utf8)       writeStringUTF8(baos,val);
 else       writeString(baos,val);
      baos.write(SEMICOLON_BYTES);
    }
    baos.close();
    byte propBytes[]=baos.toByteArray();
    if (propBytes.length > 65535)     throw new DataFormatException("Properties too big (65535 max): " + propBytes.length);
    writeLong(rawStream,2,propBytes.length);
    rawStream.write(propBytes);
  }
 else {
    writeLong(rawStream,2,0);
  }
}
