{
  if (props != null) {
    Properties p;
    if (sort) {
      p=new OrderedProperties();
      p.putAll(props);
    }
 else {
      p=props;
    }
    ByteArrayOutputStream baos=new ByteArrayOutputStream(p.size() * 64);
    for (    Map.Entry entry : p.entrySet()) {
      String key=(String)entry.getKey();
      String val=(String)entry.getValue();
      if (utf8)       writeStringUTF8(baos,key);
 else       writeString(baos,key);
      baos.write(EQUAL_BYTES);
      if (utf8)       writeStringUTF8(baos,val);
 else       writeString(baos,val);
      baos.write(SEMICOLON_BYTES);
    }
    baos.close();
    byte propBytes[]=baos.toByteArray();
    if (propBytes.length > 65535)     throw new DataFormatException("Properties too big (65535 max): " + propBytes.length);
    writeLong(rawStream,2,propBytes.length);
    rawStream.write(propBytes);
  }
 else {
    writeLong(rawStream,2,0);
  }
}
