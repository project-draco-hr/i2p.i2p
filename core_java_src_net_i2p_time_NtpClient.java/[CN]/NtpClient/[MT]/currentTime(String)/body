{
  try {
    DatagramSocket socket=new DatagramSocket();
    InetAddress address=InetAddress.getByName(serverName);
    byte[] buf=new NtpMessage().toByteArray();
    DatagramPacket packet=new DatagramPacket(buf,buf.length,address,NTP_PORT);
    NtpMessage.encodeTimestamp(packet.getData(),40,(System.currentTimeMillis() / 1000.0) + SECONDS_1900_TO_EPOCH);
    socket.send(packet);
    packet=new DatagramPacket(buf,buf.length);
    socket.setSoTimeout(10 * 1000);
    try {
      socket.receive(packet);
    }
 catch (    InterruptedIOException iie) {
      socket.close();
      return -1;
    }
    double destinationTimestamp=(System.currentTimeMillis() / 1000.0) + SECONDS_1900_TO_EPOCH;
    NtpMessage msg=new NtpMessage(packet.getData());
    double roundTripDelay=(destinationTimestamp - msg.originateTimestamp) - (msg.receiveTimestamp - msg.transmitTimestamp);
    double localClockOffset=((msg.receiveTimestamp - msg.originateTimestamp) + (msg.transmitTimestamp - destinationTimestamp)) / 2;
    socket.close();
    long rv=(long)(System.currentTimeMillis() + localClockOffset * 1000);
    return rv;
  }
 catch (  IOException ioe) {
    return -1;
  }
}
