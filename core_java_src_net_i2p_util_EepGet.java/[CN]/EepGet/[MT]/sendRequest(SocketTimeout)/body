{
  if (_outputStream != null) {
  }
 else {
    File outFile=new File(_outputFile);
    if (outFile.exists())     _alreadyTransferred=outFile.length();
  }
  String req=getRequest();
  if (_proxyIn != null)   try {
    _proxyIn.close();
  }
 catch (  IOException ioe) {
  }
  if (_proxyOut != null)   try {
    _proxyOut.close();
  }
 catch (  IOException ioe) {
  }
  if (_proxy != null)   try {
    _proxy.close();
  }
 catch (  IOException ioe) {
  }
  if (_shouldProxy) {
    _proxy=InternalSocket.getSocket(_proxyHost,_proxyPort);
  }
 else {
    try {
      URL url=new URL(_actualURL);
      if ("http".equals(url.getProtocol())) {
        String host=url.getHost();
        int port=url.getPort();
        if (port == -1)         port=80;
        _proxy=new Socket(host,port);
      }
 else {
        throw new IOException("URL is not supported:" + _actualURL);
      }
    }
 catch (    MalformedURLException mue) {
      throw new IOException("Request URL is invalid");
    }
  }
  _proxyIn=_proxy.getInputStream();
  _proxyOut=_proxy.getOutputStream();
  timeout.setSocket(_proxy);
  _proxyOut.write(DataHelper.getUTF8(req));
  _proxyOut.flush();
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Request flushed");
}
