{
  KeyStore ks=KeyStoreUtil.loadSystemKeyStore();
  if (ks == null) {
    _log.error("Key Store init error");
    return null;
  }
  if (_log.shouldLog(Log.INFO)) {
    int count=KeyStoreUtil.countCerts(ks);
    _log.info("Loaded " + count + " default trusted certificates");
  }
  File dir=new File(_context.getBaseDir(),"certificates");
  int adds=KeyStoreUtil.addCerts(dir,ks);
  int totalAdds=adds;
  if (adds > 0 && _log.shouldLog(Log.INFO))   _log.info("Loaded " + adds + " trusted certificates from "+ dir.getAbsolutePath());
  if (!_context.getBaseDir().getAbsolutePath().equals(_context.getConfigDir().getAbsolutePath())) {
    dir=new File(_context.getConfigDir(),"certificates");
    adds=KeyStoreUtil.addCerts(dir,ks);
    totalAdds+=adds;
    if (adds > 0 && _log.shouldLog(Log.INFO))     _log.info("Loaded " + adds + " trusted certificates from "+ dir.getAbsolutePath());
  }
  dir=new File(System.getProperty("user.dir"));
  if (!_context.getBaseDir().getAbsolutePath().equals(dir.getAbsolutePath())) {
    dir=new File(_context.getConfigDir(),"certificates");
    adds=KeyStoreUtil.addCerts(dir,ks);
    totalAdds+=adds;
    if (adds > 0 && _log.shouldLog(Log.INFO))     _log.info("Loaded " + adds + " trusted certificates from "+ dir.getAbsolutePath());
  }
  if (_log.shouldLog(Log.INFO))   _log.info("Loaded total of " + totalAdds + " new trusted certificates");
  try {
    SSLContext sslc=SSLContext.getInstance("TLS");
    TrustManagerFactory tmf=TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());
    tmf.init(ks);
    X509TrustManager defaultTrustManager=(X509TrustManager)tmf.getTrustManagers()[0];
    _stm=new SavingTrustManager(defaultTrustManager);
    sslc.init(null,new TrustManager[]{_stm},null);
    return sslc;
  }
 catch (  GeneralSecurityException gse) {
    _log.error("Key Store update error",gse);
  }
  return null;
}
