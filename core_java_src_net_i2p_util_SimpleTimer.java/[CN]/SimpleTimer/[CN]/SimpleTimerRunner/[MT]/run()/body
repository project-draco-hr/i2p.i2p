{
  List eventsToFire=new ArrayList(1);
  while (true) {
    try {
synchronized (_events) {
        if (_events.size() <= 0)         _events.wait();
        long now=System.currentTimeMillis();
        long nextEventDelay=-1;
        Object nextEvent=null;
        while (true) {
          if (_events.size() <= 0)           break;
          Long when=(Long)_events.firstKey();
          if (when.longValue() <= now) {
            TimedEvent evt=(TimedEvent)_events.remove(when);
            if (evt != null) {
              _eventTimes.remove(evt);
              eventsToFire.add(evt);
            }
          }
 else {
            nextEventDelay=when.longValue() - now;
            nextEvent=_events.get(when);
            break;
          }
        }
        if (eventsToFire.size() <= 0) {
          if (nextEventDelay != -1) {
            if (_log.shouldLog(Log.DEBUG))             _log.debug("Next event in " + nextEventDelay + ": "+ nextEvent);
            _events.wait(nextEventDelay);
          }
 else {
            _events.wait();
          }
        }
      }
    }
 catch (    InterruptedException ie) {
    }
catch (    Throwable t) {
      if (_log != null) {
        _log.log(Log.CRIT,"Uncaught exception in the SimpleTimer!",t);
      }
 else {
        System.err.println("Uncaught exception in SimpleTimer");
        t.printStackTrace();
      }
    }
    long now=System.currentTimeMillis();
    now=now - (now % 1000);
    for (int i=0; i < eventsToFire.size(); i++) {
      TimedEvent evt=(TimedEvent)eventsToFire.get(i);
      try {
        evt.timeReached();
      }
 catch (      Throwable t) {
        log("wtf, event borked: " + evt,t);
      }
      _recentEvents[4]=_recentEvents[3];
      _recentEvents[3]=_recentEvents[2];
      _recentEvents[2]=_recentEvents[1];
      _recentEvents[1]=_recentEvents[0];
      _recentEvents[0]=evt;
    }
    if (_occurredTime == now) {
      _occurredEventCount+=eventsToFire.size();
    }
 else {
      _occurredTime=now;
      if (_occurredEventCount > 100) {
        StringBuffer buf=new StringBuffer(256);
        buf.append("Too many simpleTimerJobs (").append(_occurredEventCount);
        buf.append(") in a second!  Last 5: \n");
        for (int i=0; i < _recentEvents.length; i++) {
          if (_recentEvents[i] != null)           buf.append(_recentEvents[i]).append('\n');
        }
        _log.log(Log.CRIT,buf.toString());
      }
      _occurredEventCount=0;
    }
    eventsToFire.clear();
  }
}
