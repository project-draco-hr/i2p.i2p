{
  while (true) {
    try {
synchronized (_events) {
        if (_events.size() <= 0)         _events.wait();
        long now=System.currentTimeMillis();
        long nextEventDelay=-1;
        List removed=null;
        for (Iterator iter=_events.keySet().iterator(); iter.hasNext(); ) {
          Long when=(Long)iter.next();
          if (when.longValue() <= now) {
            TimedEvent evt=(TimedEvent)_events.get(when);
            try {
              evt.timeReached();
            }
 catch (            Throwable t) {
              log("wtf, event borked: " + evt,t);
            }
            if (removed == null)             removed=new ArrayList(1);
            removed.add(when);
          }
 else {
            nextEventDelay=when.longValue() - now;
            break;
          }
        }
        if (removed != null) {
          for (int i=0; i < removed.size(); i++)           _events.remove(removed.get(i));
        }
        if (nextEventDelay != -1)         _events.wait(nextEventDelay);
 else         _events.wait();
      }
    }
 catch (    InterruptedException ie) {
    }
  }
}
