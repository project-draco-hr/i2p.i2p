{
  String dir=System.getProperty(PROP_WORKING_DIR);
  boolean isWindows=System.getProperty("os.name").startsWith("Win");
  File dirf=null;
  if (dir != null) {
    dirf=new File(dir);
  }
 else {
    String home=System.getProperty("user.home");
    if (isWindows) {
      String appdata=System.getenv("APPDATA");
      if (appdata != null)       home=appdata;
      dirf=new File(home,WORKING_DIR_DEFAULT_WINDOWS);
    }
 else {
      dirf=new File(home,WORKING_DIR_DEFAULT);
    }
  }
  String cwd=System.getProperty(PROP_BASE_DIR);
  if (cwd == null)   cwd=System.getProperty("user.dir");
  File oldDirf=new File(cwd);
  File test=new File(oldDirf,"hosts.txt");
  if (!test.exists()) {
    System.err.println("ERROR - Cannot find I2P installation in " + cwd + " - Will probably be just a router with no apps or console at all!");
    return cwd;
  }
  String rv=dirf.getAbsolutePath();
  if (dirf.exists()) {
    if (dirf.isDirectory())     return rv;
    System.err.println("Wanted to use " + rv + " for a working directory but it is not a directory");
    return cwd;
  }
  if (!dirf.mkdir()) {
    System.err.println("Wanted to use " + rv + " for a working directory but could not create it");
    return cwd;
  }
  test=new File(oldDirf,"router.keys");
  boolean oldInstall=test.exists();
  if (!oldInstall) {
    test=new File(oldDirf,"logs");
    oldInstall=test.exists();
  }
  if (oldInstall && !migrateOldConfig)   return cwd;
  boolean migrateOldData=false;
  if (migrateOldData)   System.err.println("Migrating data files to new user directory " + rv);
 else   System.err.println("Setting up new user directory " + rv);
  boolean success=migrate(MIGRATE_BASE,oldDirf,dirf);
  success&=migrateJettyXml(oldDirf,dirf);
  success&=migrateWrapperConfig(oldDirf,dirf);
  if (migrateOldData) {
    success&=migrate(MIGRATE_DATA,oldDirf,dirf);
    success&=migrateI2PTunnelKeys(oldDirf,dirf);
    success&=migrateSnark(oldDirf,dirf);
    if (!isWindows)     success&=migrateI2prouter(oldDirf,dirf);
  }
 else   if (!oldInstall) {
    success&=migrate("i2psnark.config",oldDirf,dirf);
  }
  if (success) {
    System.err.println("Successfully copied data files to new user directory " + rv);
    if (migrateOldData) {
      System.err.println("Libraries and other files remain in the old directory " + cwd + ", do not remove them.");
      System.err.println("You should manually move any non-standard files, such as additional eepsite directories and key files");
      System.err.println("After verifying that all is working, you may delete the following data files and directories in " + cwd + ": "+ MIGRATE_DATA.replace(',',' ')+ " i2psnark.config tmp work");
      if (System.getProperty("wrapper.version") != null)       System.err.println("Note that until you shutdown your router completely and restart, the wrapper will continue" + " to log to the old wrapper logs in " + cwd);
      if (!isWindows)       System.err.println("From now on, you should now use the i2prouter" + " script in the " + rv + " directory to start i2p."+ " You may copy or move this script elsewhere, you need not run it from that directory.");
    }
    return rv;
  }
 else {
    System.err.println("FAILED copy of some or all data files to new directory " + rv);
    System.err.println("Check logs for details");
    System.err.println("Continung to use data files in old directory " + cwd);
    return cwd;
  }
}
