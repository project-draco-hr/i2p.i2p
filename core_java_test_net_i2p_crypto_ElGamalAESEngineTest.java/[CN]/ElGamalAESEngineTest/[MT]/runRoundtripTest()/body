{
  try {
    Object keys[]=KeyGenerator.getInstance().generatePKIKeypair();
    PublicKey pubKey=(PublicKey)keys[0];
    PrivateKey privKey=(PrivateKey)keys[1];
    String msg="Hello world";
    Set toBeDelivered=new HashSet();
    SessionKey key=_context.sessionKeyManager().getCurrentKey(pubKey);
    if (key == null)     key=_context.sessionKeyManager().createSession(pubKey);
    byte[] encrypted=_context.elGamalAESEngine().encrypt(msg.getBytes(),pubKey,key,64);
    byte[] decrypted=_context.elGamalAESEngine().decrypt(encrypted,privKey);
    if (decrypted == null)     throw new Exception("Failed to decrypt");
    String read=new String(decrypted);
    _log.debug("read: " + read);
    _log.debug("Match? " + msg.equals(read));
  }
 catch (  Exception e) {
    _log.error("Error",e);
    try {
      Thread.sleep(5000);
    }
 catch (    InterruptedException ie) {
    }
    System.exit(0);
  }
}
