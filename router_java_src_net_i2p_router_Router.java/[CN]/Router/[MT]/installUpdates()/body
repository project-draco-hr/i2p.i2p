{
  File updateFile=new File(_context.getRouterDir(),UPDATE_FILE);
  boolean exists=updateFile.exists();
  if (!exists) {
    updateFile=new File(_context.getBaseDir(),UPDATE_FILE);
    exists=updateFile.exists();
  }
  if (exists) {
    File test=new File(_context.getBaseDir(),"history.txt");
    if ((test.exists() && !test.canWrite()) || (!_context.getBaseDir().canWrite())) {
      System.out.println("ERROR: No write permissions on " + _context.getBaseDir() + " to extract software update file");
      return;
    }
    System.out.println("INFO: Update file exists [" + UPDATE_FILE + "] - installing");
    boolean ok=FileUtil.verifyZip(updateFile);
    if (ok) {
      _config.put("router.updateLastInstalled","" + System.currentTimeMillis());
      saveConfig();
      ok=FileUtil.extractZip(updateFile,_context.getBaseDir());
    }
    try {
      if (ok)       System.out.println("INFO: Update installed");
 else       System.out.println("ERROR: Update failed!");
      if (!ok) {
        File bad=new File(_context.getRouterDir(),"BAD-" + UPDATE_FILE);
        boolean renamed=updateFile.renameTo(bad);
        if (renamed) {
          System.out.println("Moved update file to " + bad.getAbsolutePath());
        }
 else {
          System.out.println("Deleting file " + updateFile.getAbsolutePath());
          ok=true;
        }
      }
      if (ok) {
        boolean deleted=updateFile.delete();
        if (!deleted) {
          System.out.println("ERROR: Unable to delete the update file!");
          updateFile.deleteOnExit();
        }
      }
      if (_context.hasWrapper())       System.out.println("INFO: Restarting after update");
 else       System.out.println("WARNING: Exiting after update, restart I2P");
    }
 catch (    Throwable t) {
    }
    System.exit(EXIT_HARD_RESTART);
  }
 else {
    String osArch=System.getProperty("os.arch");
    boolean isX86=osArch.contains("86") || osArch.equals("amd64");
    String osName=System.getProperty("os.name").toLowerCase();
    boolean isWin=osName.startsWith("win");
    boolean isMac=osName.startsWith("mac");
    boolean goodOS=isWin || isMac || osName.contains("linux")|| osName.contains("freebsd");
    File jbigiJar=new File(_context.getBaseDir(),"lib/jbigi.jar");
    if (isX86 && goodOS && jbigiJar.exists()) {
      String libPrefix=(isWin ? "" : "lib");
      String libSuffix=(isWin ? ".dll" : isMac ? ".jnilib" : ".so");
      File jcpuidLib=new File(_context.getBaseDir(),libPrefix + "jcpuid" + libSuffix);
      if (jcpuidLib.canWrite() && jbigiJar.lastModified() > jcpuidLib.lastModified()) {
        String path=jcpuidLib.getAbsolutePath();
        boolean success=FileUtil.copy(path,path + ".bak",true,true);
        if (success) {
          boolean success2=jcpuidLib.delete();
          if (success2) {
            System.out.println("New jbigi.jar detected, moved jcpuid library to " + path + ".bak");
            System.out.println("Check logs for successful installation of new library");
          }
        }
      }
      File jbigiLib=new File(_context.getBaseDir(),libPrefix + "jbigi" + libSuffix);
      if (jbigiLib.canWrite() && jbigiJar.lastModified() > jbigiLib.lastModified()) {
        String path=jbigiLib.getAbsolutePath();
        boolean success=FileUtil.copy(path,path + ".bak",true,true);
        if (success) {
          boolean success2=jbigiLib.delete();
          if (success2) {
            System.out.println("New jbigi.jar detected, moved jbigi library to " + path + ".bak");
            System.out.println("Check logs for successful installation of new library");
          }
        }
      }
    }
  }
}
