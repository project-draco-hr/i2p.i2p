{
  if (peer == null) {
    _log.error("wtf, why did we try to shitlist null?",new Exception("shitfaced"));
    return false;
  }
  if (_context.routerHash().equals(peer)) {
    _log.error("wtf, why did we try to shitlist ourselves?",new Exception("shitfaced"));
    return false;
  }
  boolean wasAlready=false;
  if (_log.shouldLog(Log.INFO))   _log.info("Shitlisting router " + peer.toBase64() + ((transport != null) ? " on transport " + transport : ""),new Exception("Shitlist cause: " + reason));
  Entry e=new Entry();
  if (forever) {
    e.expireOn=_context.clock().now() + SHITLIST_DURATION_FOREVER;
  }
 else   if (transport != null) {
    e.expireOn=_context.clock().now() + SHITLIST_DURATION_PARTIAL;
  }
 else {
    long period=SHITLIST_DURATION_MS + _context.random().nextLong(SHITLIST_DURATION_MS / 4);
    PeerProfile prof=_context.profileOrganizer().getProfile(peer);
    if (prof != null) {
      period=SHITLIST_DURATION_MS << prof.incrementShitlists();
      period+=_context.random().nextLong(period);
    }
    if (period > SHITLIST_DURATION_MAX)     period=SHITLIST_DURATION_MAX;
    e.expireOn=_context.clock().now() + period;
  }
  e.cause=reason;
  e.causeCode=reasonCode;
  e.transports=null;
  if (transport != null) {
    e.transports=new ConcurrentHashSet(2);
    e.transports.add(transport);
  }
  Entry old=_entries.get(peer);
  if (old != null) {
    wasAlready=true;
    if (old.expireOn > e.expireOn) {
      e.expireOn=old.expireOn;
      e.cause=old.cause;
      e.causeCode=old.causeCode;
    }
    if (e.transports != null) {
      if (old.transports != null)       e.transports.addAll(old.transports);
 else {
        e.transports=null;
        e.cause=reason;
        e.causeCode=reasonCode;
      }
    }
  }
  _entries.put(peer,e);
  if (transport == null) {
    _context.netDb().fail(peer);
  }
  if (!wasAlready)   _context.messageHistory().shitlist(peer,reason);
  return wasAlready;
}
