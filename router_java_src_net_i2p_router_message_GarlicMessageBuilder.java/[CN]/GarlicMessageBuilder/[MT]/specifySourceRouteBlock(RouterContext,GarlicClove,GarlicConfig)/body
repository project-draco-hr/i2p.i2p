{
  Log log=ctx.logManager().getLog(GarlicMessageBuilder.class);
  boolean includeBlock=false;
  if (config.getRequestAck()) {
    clove.setSourceRouteBlockAction(GarlicClove.ACTION_STATUS);
    includeBlock=true;
  }
 else   if (config.getReplyInstructions() != null) {
    clove.setSourceRouteBlockAction(GarlicClove.ACTION_MESSAGE_SPECIFIC);
    includeBlock=true;
  }
 else {
    clove.setSourceRouteBlockAction(GarlicClove.ACTION_NONE);
  }
  if (includeBlock) {
    log.debug("Specifying source route block");
    SessionKey replySessionKey=ctx.keyGenerator().generateSessionKey();
    SessionTag tag=new SessionTag(true);
    HashSet tags=new HashSet(1);
    tags.add(tag);
    ctx.sessionKeyManager().tagsReceived(replySessionKey,tags);
    SourceRouteBlock block=new SourceRouteBlock();
    PublicKey pk=config.getReplyThroughRouter().getIdentity().getPublicKey();
    block.setData(ctx,config.getReplyInstructions(),config.getReplyBlockMessageId(),config.getReplyBlockCertificate(),config.getReplyBlockExpiration(),pk);
    block.setRouter(config.getReplyThroughRouter().getIdentity().getHash());
    block.setKey(replySessionKey);
    block.setTag(tag);
    clove.setSourceRouteBlock(block);
  }
 else {
    clove.setSourceRouteBlock(null);
  }
}
