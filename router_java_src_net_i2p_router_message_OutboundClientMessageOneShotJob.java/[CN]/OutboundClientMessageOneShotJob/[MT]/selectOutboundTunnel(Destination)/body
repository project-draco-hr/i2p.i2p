{
  TunnelInfo tunnel;
  long now=getContext().clock().now();
synchronized (_tunnelCache) {
    tunnel=_backloggedTunnelCache.get(hashPair());
    if (tunnel != null) {
      if (getContext().tunnelManager().isValidTunnel(_from.calculateHash(),tunnel)) {
        if (!getContext().commSystem().isBacklogged(tunnel.getPeer(1))) {
          if (_log.shouldLog(Log.WARN))           _log.warn("Switching back to tunnel " + tunnel + " for "+ _toString);
          _backloggedTunnelCache.remove(hashPair());
          _tunnelCache.put(hashPair(),tunnel);
          _wantACK=true;
          return tunnel;
        }
      }
 else       _backloggedTunnelCache.remove(hashPair());
    }
    tunnel=_tunnelCache.get(hashPair());
    if (tunnel != null) {
      if (getContext().tunnelManager().isValidTunnel(_from.calculateHash(),tunnel)) {
        if (tunnel.getLength() <= 1 || !getContext().commSystem().isBacklogged(tunnel.getPeer(1)))         return tunnel;
        if (_log.shouldLog(Log.WARN))         _log.warn("Switching from backlogged " + tunnel + " for "+ _toString);
        _backloggedTunnelCache.put(hashPair(),tunnel);
      }
      _tunnelCache.remove(hashPair());
    }
    tunnel=selectOutboundTunnel();
    if (tunnel != null)     _tunnelCache.put(hashPair(),tunnel);
    _wantACK=true;
  }
  return tunnel;
}
