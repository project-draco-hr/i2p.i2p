{
  _state=3;
  TunnelInfo info=getContext().tunnelManager().getTunnelInfo(_tunnelId);
  if (info == null) {
    if (_log.shouldLog(Log.DEBUG))     _log.debug("Message for unknown tunnel [" + _tunnelId + "] received, forward to "+ _destRouter);
    if ((_tunnelId == null) || (_destRouter == null)) {
      if (_log.shouldLog(Log.ERROR))       _log.error("Someone br0ke us.  where is this message supposed to go again?",getAddedBy());
      if (_onFailure != null)       getContext().jobQueue().addJob(_onFailure);
      return;
    }
 else {
      _state=4;
      forwardToGateway();
      _state=0;
      return;
    }
  }
  info.messageProcessed();
  if (isEndpoint(info)) {
    if (_log.shouldLog(Log.INFO))     _log.info("Tunnel message where we're both the gateway and the endpoint - honor instructions");
    _state=5;
    honorInstructions(info);
    _state=0;
    return;
  }
 else   if (isGateway(info)) {
    _state=6;
    handleAsGateway(info);
    _state=0;
    return;
  }
 else {
    _state=7;
    handleAsParticipant(info);
    _state=0;
    return;
  }
}
