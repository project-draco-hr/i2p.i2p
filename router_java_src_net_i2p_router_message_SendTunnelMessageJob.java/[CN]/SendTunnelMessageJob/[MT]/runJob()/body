{
  TunnelInfo info=getContext().tunnelManager().getTunnelInfo(_tunnelId);
  if (info == null) {
    if (_log.shouldLog(Log.DEBUG))     _log.debug("Message for unknown tunnel [" + _tunnelId + "] received, forward to "+ _destRouter);
    if ((_tunnelId == null) || (_destRouter == null)) {
      if (_log.shouldLog(Log.ERROR))       _log.error("Someone br0ke us.  where is this message supposed to go again?",getAddedBy());
      if (_onFailure != null)       getContext().jobQueue().addJob(_onFailure);
      return;
    }
 else {
      forwardToGateway();
      return;
    }
  }
  info.messageProcessed();
  if (isEndpoint(info)) {
    if (_log.shouldLog(Log.INFO))     _log.info("Tunnel message where we're both the gateway and the endpoint - honor instructions");
    honorInstructions(info);
    return;
  }
 else   if (isGateway(info)) {
    handleAsGateway(info);
    return;
  }
 else {
    handleAsParticipant(info);
    return;
  }
}
