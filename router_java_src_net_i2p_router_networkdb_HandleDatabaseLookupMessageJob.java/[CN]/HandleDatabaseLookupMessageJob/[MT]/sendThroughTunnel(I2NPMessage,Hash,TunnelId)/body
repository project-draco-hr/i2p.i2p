{
  if (getContext().routerHash().equals(toPeer)) {
    TunnelGatewayMessage m=new TunnelGatewayMessage(getContext());
    m.setMessage(message);
    m.setTunnelId(replyTunnel);
    m.setMessageExpiration(message.getMessageExpiration());
    getContext().tunnelDispatcher().dispatch(m);
  }
 else {
    SessionKey replyKey=_message.getReplyKey();
    if (replyKey != null) {
      message=MessageWrapper.wrap(getContext(),message,replyKey,_message.getReplyTag());
      if (message == null) {
        _log.error("Encryption error");
        return;
      }
    }
    TunnelGatewayMessage m=new TunnelGatewayMessage(getContext());
    m.setMessage(message);
    m.setMessageExpiration(message.getMessageExpiration());
    m.setTunnelId(replyTunnel);
    SendMessageDirectJob j=new SendMessageDirectJob(getContext(),m,toPeer,10 * 1000,MESSAGE_PRIORITY);
    j.runJob();
  }
}
