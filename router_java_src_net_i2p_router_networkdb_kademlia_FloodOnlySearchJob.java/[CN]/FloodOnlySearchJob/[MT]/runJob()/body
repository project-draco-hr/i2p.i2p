{
  List floodfillPeers=_facade.getFloodfillPeers();
  if (floodfillPeers == null) {
    if (_log.shouldLog(Log.ERROR))     _log.error("Running netDb searches against the floodfill peers, but we don't know any");
    failed();
    return;
  }
  OutNetMessage out=getContext().messageRegistry().registerPending(_replySelector,_onReply,_onTimeout,_timeoutMs);
synchronized (_out) {
    _out.add(out);
  }
  for (int i=0; _lookupsRemaining < CONCURRENT_SEARCHES && i < floodfillPeers.size(); i++) {
    Hash peer=(Hash)floodfillPeers.get(i);
    if (peer.equals(getContext().routerHash()))     continue;
    DatabaseLookupMessage dlm=new DatabaseLookupMessage(getContext(),true);
    TunnelInfo replyTunnel=getContext().tunnelManager().selectInboundTunnel();
    TunnelInfo outTunnel=getContext().tunnelManager().selectOutboundTunnel();
    if ((replyTunnel == null) || (outTunnel == null)) {
      failed();
      return;
    }
    dlm.setFrom(replyTunnel.getPeer(0));
    dlm.setMessageExpiration(getContext().clock().now() + 10 * 1000);
    dlm.setReplyTunnel(replyTunnel.getReceiveTunnelId(0));
    dlm.setSearchKey(_key);
    if (_log.shouldLog(Log.INFO))     _log.info(getJobId() + ": Floodfill search for " + _key.toBase64()+ " to "+ peer.toBase64());
    getContext().tunnelDispatcher().dispatchOutbound(dlm,outTunnel.getSendTunnelId(0),peer);
    _lookupsRemaining++;
  }
  if (_lookupsRemaining <= 0) {
    if (_log.shouldLog(Log.INFO))     _log.info(getJobId() + ": Floodfill search for " + _key.toBase64()+ " had no peers to send to");
    failed();
  }
}
