{
  RateStat acceptStat=profile.getTunnelCreateResponseTime();
  RateStat rejectStat=profile.getTunnelHistory().getRejectionRate();
  RateStat failedStat=profile.getTunnelHistory().getFailedRate();
  double capacity10m=estimateCapacity(acceptStat,rejectStat,failedStat,10 * 60 * 1000);
  double capacity30m=estimateCapacity(acceptStat,rejectStat,failedStat,30 * 60 * 1000);
  double capacity60m=estimateCapacity(acceptStat,rejectStat,failedStat,60 * 60 * 1000);
  double capacity1d=estimateCapacity(acceptStat,rejectStat,failedStat,24 * 60 * 60* 1000);
  double capacity=capacity10m * periodWeight(10 * 60 * 1000) + capacity30m * periodWeight(30 * 60 * 1000) + capacity60m * periodWeight(60 * 60 * 1000) + capacity1d * periodWeight(24 * 60 * 60* 1000);
  if (capacity10m <= 0)   capacity=0;
  if (tooOld(profile))   capacity=1;
  long now=_context.clock().now();
  if (profile.getTunnelHistory().getLastRejectedTransient() > now - 5 * 60 * 1000)   capacity=1;
 else   if (profile.getTunnelHistory().getLastRejectedProbabalistic() > now - 5 * 60 * 1000)   capacity-=_context.random().nextInt(5);
  capacity+=profile.getCapacityBonus();
  if (capacity < 0)   capacity=0;
  return capacity;
}
