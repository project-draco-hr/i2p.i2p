{
  double totalCapacity=0;
  double totalIntegration=0;
  Set reordered=new TreeSet(_comp);
  for (Iterator iter=allPeers.iterator(); iter.hasNext(); ) {
    PeerProfile profile=(PeerProfile)iter.next();
    if (_us.equals(profile.getPeer()))     continue;
    if (profile.getIsFailing() || (!profile.getIsActive()))     continue;
    if (profile.getCapacityValue() <= CapacityCalculator.GROWTH_FACTOR)     continue;
    totalCapacity+=profile.getCapacityValue();
    totalIntegration+=profile.getIntegrationValue();
    reordered.add(profile);
  }
  locked_calculateCapacityThreshold(totalCapacity,reordered);
  locked_calculateSpeedThreshold(reordered);
  _thresholdIntegrationValue=1.0d * avg(totalIntegration,reordered.size());
}
