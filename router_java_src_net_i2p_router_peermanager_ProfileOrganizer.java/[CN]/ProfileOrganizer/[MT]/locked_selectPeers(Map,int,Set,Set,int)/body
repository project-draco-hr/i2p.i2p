{
  List all=new ArrayList(peers.keySet());
  if (toExclude != null)   all.removeAll(toExclude);
  all.removeAll(matches);
  all.remove(_us);
  Collections.shuffle(all,_random);
  Set IPSet=new HashSet(8);
  for (int i=0; (matches.size() < howMany) && (i < all.size()); i++) {
    Hash peer=(Hash)all.get(i);
    boolean ok=isSelectable(peer);
    if (ok) {
      ok=mask <= 0 || notRestricted(peer,IPSet,mask);
      if ((!ok) && _log.shouldLog(Log.WARN))       _log.warn("IP restriction prevents " + peer + " from joining "+ matches);
    }
    if (ok)     matches.add(peer);
 else     matches.remove(peer);
  }
}
