{
  List<Hash> all=new ArrayList(peers.keySet());
  for (Iterator<Hash> iter=new RandomIterator(all); (matches.size() < howMany) && iter.hasNext(); ) {
    Hash peer=iter.next();
    if (toExclude != null && toExclude.contains(peer))     continue;
    if (matches.contains(peer))     continue;
    if (_us.equals(peer))     continue;
    int subTier=getSubTier(peer,randomKey);
    if (subTierMode >= 4) {
      if (subTier != (subTierMode & 0x03))       continue;
    }
 else {
      if ((subTier >> 1) != (subTierMode & 0x01))       continue;
    }
    boolean ok=isSelectable(peer);
    if (ok)     matches.add(peer);
 else     matches.remove(peer);
  }
}
