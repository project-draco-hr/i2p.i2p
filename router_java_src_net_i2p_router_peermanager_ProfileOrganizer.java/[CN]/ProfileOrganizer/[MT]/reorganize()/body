{
synchronized (_reorganizeLock) {
    Set allPeers=new HashSet(_failingPeers.size() + _notFailingPeers.size() + _reliablePeers.size()+ _fastAndReliablePeers.size());
    allPeers.addAll(_failingPeers.values());
    allPeers.addAll(_notFailingPeers.values());
    allPeers.addAll(_reliablePeers.values());
    allPeers.addAll(_fastAndReliablePeers.values());
    _failingPeers.clear();
    _notFailingPeers.clear();
    _reliablePeers.clear();
    _fastAndReliablePeers.clear();
    Set reordered=new TreeSet(_calc);
    for (Iterator iter=_strictReliabilityOrder.iterator(); iter.hasNext(); ) {
      PeerProfile prof=(PeerProfile)iter.next();
      reordered.add(prof);
    }
    _strictReliabilityOrder=reordered;
    calculateThresholds(allPeers);
    for (Iterator iter=allPeers.iterator(); iter.hasNext(); ) {
      PeerProfile profile=(PeerProfile)iter.next();
      locked_placeProfile(profile);
    }
    locked_unfailAsNecessary();
    locked_promoteFastAsNecessary();
    if (_log.shouldLog(Log.DEBUG)) {
      _log.debug("Profiles reorganized.  averages: [integration: " + _thresholdIntegrationValue + ", reliability: "+ _thresholdReliabilityValue+ ", speed: "+ _thresholdSpeedValue+ "]");
      StringBuffer buf=new StringBuffer(512);
      for (Iterator iter=_strictReliabilityOrder.iterator(); iter.hasNext(); ) {
        PeerProfile prof=(PeerProfile)iter.next();
        buf.append('[').append(prof.toString()).append('=').append(prof.getReliabilityValue()).append("] ");
      }
      _log.debug("Strictly organized (most reliable first): " + buf.toString());
      _log.debug("fast and reliable: " + _fastAndReliablePeers.values());
    }
  }
}
