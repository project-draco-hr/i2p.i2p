{
  RouterInfo info=new RouterInfo();
  FileOutputStream fos1=null;
  FileOutputStream fos2=null;
  try {
    info.setAddresses(getContext().commSystem().createAddresses());
    Properties stats=getContext().statPublisher().publishStatistics();
    stats.setProperty(RouterInfo.PROP_NETWORK_ID,Router.NETWORK_ID + "");
    if (FloodfillNetworkDatabaseFacade.floodfillEnabled(getContext()))     info.addCapability(FloodfillNetworkDatabaseFacade.CAPACITY_FLOODFILL);
    info.setOptions(stats);
    info.setPeers(new HashSet());
    info.setPublished(getCurrentPublishDate(getContext()));
    RouterIdentity ident=new RouterIdentity();
    Certificate cert=new Certificate();
    cert.setCertificateType(Certificate.CERTIFICATE_TYPE_NULL);
    cert.setPayload(null);
    ident.setCertificate(cert);
    PublicKey pubkey=null;
    PrivateKey privkey=null;
    SigningPublicKey signingPubKey=null;
    SigningPrivateKey signingPrivKey=null;
    Object keypair[]=getContext().keyGenerator().generatePKIKeypair();
    pubkey=(PublicKey)keypair[0];
    privkey=(PrivateKey)keypair[1];
    Object signingKeypair[]=getContext().keyGenerator().generateSigningKeypair();
    signingPubKey=(SigningPublicKey)signingKeypair[0];
    signingPrivKey=(SigningPrivateKey)signingKeypair[1];
    ident.setPublicKey(pubkey);
    ident.setSigningPublicKey(signingPubKey);
    info.setIdentity(ident);
    info.sign(signingPrivKey);
    String infoFilename=getContext().router().getConfigSetting(Router.PROP_INFO_FILENAME);
    if (infoFilename == null)     infoFilename=Router.PROP_INFO_FILENAME_DEFAULT;
    fos1=new FileOutputStream(infoFilename);
    info.writeBytes(fos1);
    String keyFilename=getContext().router().getConfigSetting(Router.PROP_KEYS_FILENAME);
    if (keyFilename == null)     keyFilename=Router.PROP_KEYS_FILENAME_DEFAULT;
    fos2=new FileOutputStream(keyFilename);
    privkey.writeBytes(fos2);
    signingPrivKey.writeBytes(fos2);
    pubkey.writeBytes(fos2);
    signingPubKey.writeBytes(fos2);
    getContext().keyManager().setSigningPrivateKey(signingPrivKey);
    getContext().keyManager().setSigningPublicKey(signingPubKey);
    getContext().keyManager().setPrivateKey(privkey);
    getContext().keyManager().setPublicKey(pubkey);
    _log.info("Router info created and stored at " + infoFilename + " with private keys stored at "+ keyFilename+ " ["+ info+ "]");
  }
 catch (  DataFormatException dfe) {
    _log.error("Error building the new router information",dfe);
  }
catch (  IOException ioe) {
    _log.error("Error writing out the new router information",ioe);
  }
 finally {
    if (fos1 != null)     try {
      fos1.close();
    }
 catch (    IOException ioe) {
    }
    if (fos2 != null)     try {
      fos2.close();
    }
 catch (    IOException ioe) {
    }
  }
  return info;
}
