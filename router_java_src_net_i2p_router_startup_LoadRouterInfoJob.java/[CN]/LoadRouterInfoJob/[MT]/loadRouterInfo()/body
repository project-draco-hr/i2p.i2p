{
  String routerInfoFile=getContext().getProperty(Router.PROP_INFO_FILENAME,Router.PROP_INFO_FILENAME_DEFAULT);
  RouterInfo info=null;
  String keyFilename=getContext().getProperty(Router.PROP_KEYS_FILENAME,Router.PROP_KEYS_FILENAME_DEFAULT);
  File rif=new File(getContext().getRouterDir(),routerInfoFile);
  boolean infoExists=rif.exists();
  File rkf=new File(getContext().getRouterDir(),keyFilename);
  boolean keysExist=rkf.exists();
  InputStream fis1=null;
  InputStream fis2=null;
  try {
    if (infoExists && keysExist) {
      fis1=new BufferedInputStream(new FileInputStream(rif));
      info=new RouterInfo();
      info.readBytes(fis1);
      if (!info.isValid())       throw new DataFormatException("Our RouterInfo has a bad signature");
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Reading in routerInfo from " + rif.getAbsolutePath() + " and it has "+ info.getAddresses().size()+ " addresses");
      _us=info;
    }
    if (keysExist) {
      fis2=new BufferedInputStream(new FileInputStream(rkf));
      PrivateKey privkey=new PrivateKey();
      privkey.readBytes(fis2);
      if (shouldRebuild(privkey)) {
        _us=null;
        if (fis1 != null) {
          try {
            fis1.close();
          }
 catch (          IOException ioe) {
          }
          fis1=null;
        }
        try {
          fis2.close();
        }
 catch (        IOException ioe) {
        }
        fis2=null;
        rif.delete();
        rkf.delete();
        return;
      }
      SigningPrivateKey signingPrivKey=new SigningPrivateKey();
      signingPrivKey.readBytes(fis2);
      PublicKey pubkey=new PublicKey();
      pubkey.readBytes(fis2);
      SigningPublicKey signingPubKey=new SigningPublicKey();
      signingPubKey.readBytes(fis2);
      getContext().keyManager().setKeys(pubkey,privkey,signingPubKey,signingPrivKey);
    }
  }
 catch (  IOException ioe) {
    _log.log(Log.CRIT,"Error reading the router info from " + rif.getAbsolutePath() + " and the keys from "+ rkf.getAbsolutePath(),ioe);
    _us=null;
    if (fis1 != null) {
      try {
        fis1.close();
      }
 catch (      IOException ioe2) {
      }
      fis1=null;
    }
    if (fis2 != null) {
      try {
        fis2.close();
      }
 catch (      IOException ioe2) {
      }
      fis2=null;
    }
    rif.delete();
    rkf.delete();
  }
catch (  DataFormatException dfe) {
    _log.log(Log.CRIT,"Corrupt router info or keys at " + rif.getAbsolutePath() + " / "+ rkf.getAbsolutePath(),dfe);
    _us=null;
    if (fis1 != null) {
      try {
        fis1.close();
      }
 catch (      IOException ioe) {
      }
      fis1=null;
    }
    if (fis2 != null) {
      try {
        fis2.close();
      }
 catch (      IOException ioe) {
      }
      fis2=null;
    }
    rif.delete();
    rkf.delete();
  }
 finally {
    if (fis1 != null)     try {
      fis1.close();
    }
 catch (    IOException ioe) {
    }
    if (fis2 != null)     try {
      fis2.close();
    }
 catch (    IOException ioe) {
    }
  }
}
