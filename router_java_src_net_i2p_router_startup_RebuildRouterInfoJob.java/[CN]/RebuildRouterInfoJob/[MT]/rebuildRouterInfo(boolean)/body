{
  _log.debug("Rebuilding the new router info");
  boolean fullRebuild=false;
  RouterInfo info=null;
  String infoFilename=getContext().router().getConfigSetting(Router.PROP_INFO_FILENAME);
  if (infoFilename == null)   infoFilename=Router.PROP_INFO_FILENAME_DEFAULT;
  String keyFilename=getContext().router().getConfigSetting(Router.PROP_KEYS_FILENAME);
  if (keyFilename == null)   keyFilename=Router.PROP_KEYS_FILENAME_DEFAULT;
  File keyFile=new File(keyFilename);
  if (keyFile.exists()) {
    info=getContext().router().getRouterInfo();
    if (info == null) {
      info=new RouterInfo();
      FileInputStream fis=null;
      try {
        fis=new FileInputStream(keyFile);
        PrivateKey privkey=new PrivateKey();
        privkey.readBytes(fis);
        SigningPrivateKey signingPrivKey=new SigningPrivateKey();
        signingPrivKey.readBytes(fis);
        PublicKey pubkey=new PublicKey();
        pubkey.readBytes(fis);
        SigningPublicKey signingPubKey=new SigningPublicKey();
        signingPubKey.readBytes(fis);
        RouterIdentity ident=new RouterIdentity();
        ident.setCertificate(new Certificate(Certificate.CERTIFICATE_TYPE_NULL,null));
        ident.setPublicKey(pubkey);
        ident.setSigningPublicKey(signingPubKey);
        info.setIdentity(ident);
      }
 catch (      Exception e) {
        _log.error("Error reading in the key data from " + keyFile.getAbsolutePath(),e);
        if (fis != null)         try {
          fis.close();
        }
 catch (        IOException ioe) {
        }
        fis=null;
        keyFile.delete();
        rebuildRouterInfo(alreadyRunning);
        return;
      }
 finally {
        if (fis != null)         try {
          fis.close();
        }
 catch (        IOException ioe) {
        }
      }
    }
    try {
      info.setAddresses(getContext().commSystem().createAddresses());
      Properties stats=getContext().statPublisher().publishStatistics();
      stats.setProperty(RouterInfo.PROP_NETWORK_ID,"" + Router.NETWORK_ID);
      info.setOptions(stats);
      if (FloodfillNetworkDatabaseFacade.floodfillEnabled(getContext()))       info.addCapability(FloodfillNetworkDatabaseFacade.CAPACITY_FLOODFILL);
      if ("true".equalsIgnoreCase(getContext().getProperty(Router.PROP_HIDDEN,"false")))       info.addCapability(RouterInfo.CAPABILITY_HIDDEN);
      getContext().router().addReachabilityCapability(info);
      info.setPublished(CreateRouterInfoJob.getCurrentPublishDate(getContext()));
      info.sign(getContext().keyManager().getSigningPrivateKey());
    }
 catch (    DataFormatException dfe) {
      _log.error("Error rebuilding the new router info",dfe);
      return;
    }
    FileOutputStream fos=null;
    try {
      fos=new FileOutputStream(infoFilename);
      info.writeBytes(fos);
    }
 catch (    DataFormatException dfe) {
      _log.error("Error rebuilding the router information",dfe);
    }
catch (    IOException ioe) {
      _log.error("Error writing out the rebuilt router information",ioe);
    }
 finally {
      if (fos != null)       try {
        fos.close();
      }
 catch (      IOException ioe) {
      }
    }
  }
 else {
    _log.warn("Private key file " + keyFile.getAbsolutePath() + " deleted!  Rebuilding a brand new router identity!");
    CreateRouterInfoJob j=new CreateRouterInfoJob(getContext(),null);
    info=j.createRouterInfo();
    fullRebuild=true;
  }
  getContext().router().setRouterInfo(info);
  _log.info("Router info rebuilt and stored at " + infoFilename + " ["+ info+ "]");
}
