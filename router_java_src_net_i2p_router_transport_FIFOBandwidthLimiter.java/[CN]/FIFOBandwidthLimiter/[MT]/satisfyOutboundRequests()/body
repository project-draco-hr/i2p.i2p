{
  List satisfied=null;
synchronized (_pendingOutboundRequests) {
    while (_pendingOutboundRequests.size() > 0) {
      SimpleRequest req=(SimpleRequest)_pendingOutboundRequests.get(0);
      if (_outboundUnlimited) {
        int allocated=req.getPendingOutboundRequested();
        _totalAllocatedOutboundBytes+=allocated;
        req.allocateBytes(0,allocated);
        if (satisfied == null)         satisfied=new ArrayList(2);
        satisfied.add(req);
        long waited=_context.clock().now() - req.getRequestTime();
        if (_log.shouldLog(Log.INFO))         _log.info("Granting outbound request " + req.getRequestName() + " fully for "+ req.getTotalOutboundRequested()+ " bytes (waited "+ waited+ "ms) pending "+ _pendingOutboundRequests.size());
        _pendingOutboundRequests.remove(0);
        if (waited > 10)         _context.statManager().addRateData("bwLimiter.outboundDelayedTime",waited,waited);
      }
 else       if (_availableOutboundBytes > 0) {
        int requested=req.getPendingOutboundRequested();
        int allocated=0;
        if (_availableOutboundBytes > requested)         allocated=requested;
 else         allocated=_availableOutboundBytes;
        _availableOutboundBytes-=allocated;
        _totalAllocatedOutboundBytes+=allocated;
        req.allocateBytes(0,allocated);
        if (satisfied == null)         satisfied=new ArrayList(2);
        satisfied.add(req);
        long waited=_context.clock().now() - req.getRequestTime();
        if (req.getPendingOutboundRequested() > 0) {
          if (_log.shouldLog(Log.INFO))           _log.info("Allocating " + allocated + " bytes outbound as a partial grant to "+ req.getRequestName()+ " (wanted "+ req.getTotalOutboundRequested()+ " bytes, waited "+ waited+ "ms) pending "+ _pendingOutboundRequests.size());
        }
 else {
          if (_log.shouldLog(Log.INFO))           _log.info("Allocating " + allocated + " bytes outbound to finish the partial grant to "+ req.getRequestName()+ " (total "+ req.getTotalOutboundRequested()+ " bytes, waited "+ waited+ "ms) pending "+ _pendingOutboundRequests.size());
          _pendingOutboundRequests.remove(0);
          if (waited > 10)           _context.statManager().addRateData("bwLimiter.outboundDelayedTime",waited,waited);
        }
      }
 else {
        if (_log.shouldLog(Log.WARN))         _log.warn("Still denying the first outbound request (" + req.getRequestName() + " for "+ req.getTotalOutboundRequested()+ " bytes (available "+ _availableInboundBytes+ "/"+ _availableOutboundBytes+ " in/out) (waited "+ (_context.clock().now() - req.getRequestTime())+ "ms so far) pending "+ (_pendingOutboundRequests.size()));
        break;
      }
    }
  }
  if (satisfied != null) {
    for (int i=0; i < satisfied.size(); i++) {
      SimpleRequest req=(SimpleRequest)satisfied.get(i);
      req.notifyAllocation();
    }
  }
}
