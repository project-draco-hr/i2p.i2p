{
  ArrayList matches=new ArrayList(2);
  long beforeSync=_context.clock().now();
  Map messages=null;
synchronized (_pendingMessages) {
    messages=(Map)_pendingMessages.clone();
  }
  long matchTime=0;
  long continueTime=0;
  int numMessages=messages.size();
  long afterSync1=_context.clock().now();
  ArrayList matchedRemove=null;
  for (Iterator iter=messages.keySet().iterator(); iter.hasNext(); ) {
    Long exp=(Long)iter.next();
    OutNetMessage msg=(OutNetMessage)messages.get(exp);
    MessageSelector selector=msg.getReplySelector();
    if (selector != null) {
      long before=_context.clock().now();
      boolean isMatch=selector.isMatch(message);
      long after=_context.clock().now();
      long diff=after - before;
      if (diff > 100) {
        if (_log.shouldLog(Log.WARN))         _log.warn("Matching with selector took too long (" + diff + "ms) : "+ selector.getClass().getName());
      }
      matchTime+=diff;
      if (isMatch) {
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Selector matches [" + selector);
        if (!matches.contains(msg))         matches.add(msg);
        long beforeCon=_context.clock().now();
        boolean continueMatching=selector.continueMatching();
        long afterCon=_context.clock().now();
        long diffCon=afterCon - beforeCon;
        if (diffCon > 100) {
          if (_log.shouldLog(Log.WARN))           _log.warn("Error continueMatching on a match took too long (" + diffCon + "ms) : "+ selector.getClass().getName());
        }
        continueTime+=diffCon;
        if (continueMatching) {
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Continue matching");
        }
 else {
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Stop matching selector " + selector + " for message "+ msg.getMessageType());
          if (matchedRemove == null)           matchedRemove=new ArrayList(4);
          matchedRemove.add(exp);
        }
      }
 else {
      }
    }
  }
  long afterSearch=_context.clock().now();
  doRemove(matchedRemove);
  long delay=_context.clock().now() - beforeSync;
  long search=afterSearch - afterSync1;
  long sync=afterSync1 - beforeSync;
  int level=Log.DEBUG;
  if (delay > 1000)   level=Log.ERROR;
  if (_log.shouldLog(level)) {
    _log.log(level,"getMessages took " + delay + "ms with search time of "+ search+ "ms (match: "+ matchTime+ "ms, continue: "+ continueTime+ "ms, #: "+ numMessages+ ") and sync time of "+ sync+ "ms for "+ (matchedRemove == null ? 0 : matchedRemove.size())+ " removed, "+ matches.size()+ " matches");
  }
  return matches;
}
