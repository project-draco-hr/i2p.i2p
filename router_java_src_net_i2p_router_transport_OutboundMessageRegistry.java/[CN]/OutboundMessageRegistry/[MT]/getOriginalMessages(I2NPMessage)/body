{
  List<MessageSelector> matchedSelectors=null;
  List<MessageSelector> removedSelectors=null;
synchronized (_selectors) {
    for (Iterator<MessageSelector> iter=_selectors.iterator(); iter.hasNext(); ) {
      MessageSelector sel=iter.next();
      if (sel == null)       continue;
      boolean isMatch=sel.isMatch(message);
      if (isMatch) {
        if (matchedSelectors == null)         matchedSelectors=new ArrayList(1);
        matchedSelectors.add(sel);
        if (!sel.continueMatching()) {
          if (removedSelectors == null)           removedSelectors=new ArrayList(1);
          removedSelectors.add(sel);
          iter.remove();
        }
      }
    }
  }
  List<OutNetMessage> rv=null;
  if (matchedSelectors != null) {
    rv=new ArrayList(matchedSelectors.size());
    for (    MessageSelector sel : matchedSelectors) {
      boolean removed=false;
      OutNetMessage msg=null;
      List msgs=null;
synchronized (_selectorToMessage) {
        Object o=null;
        if ((removedSelectors != null) && (removedSelectors.contains(sel))) {
          o=_selectorToMessage.remove(sel);
          removed=true;
        }
 else {
          o=_selectorToMessage.get(sel);
        }
        if (o instanceof OutNetMessage) {
          msg=(OutNetMessage)o;
          if (msg != null)           rv.add(msg);
        }
 else         if (o instanceof List) {
          msgs=(List<OutNetMessage>)o;
          if (msgs != null)           rv.addAll(msgs);
        }
      }
      if (removed) {
        if (msg != null) {
synchronized (_activeMessages) {
            _activeMessages.remove(msg);
          }
        }
 else         if (msgs != null) {
synchronized (_activeMessages) {
            _activeMessages.removeAll(msgs);
          }
        }
      }
    }
  }
 else {
    rv=Collections.EMPTY_LIST;
  }
  return rv;
}
