{
  ArrayList matchedSelectors=null;
  ArrayList removedSelectors=null;
  long beforeSync=_context.clock().now();
synchronized (_selectors) {
    for (int i=0; i < _selectors.size(); i++) {
      MessageSelector sel=(MessageSelector)_selectors.get(i);
      boolean isMatch=sel.isMatch(message);
      if (isMatch) {
        if (matchedSelectors == null)         matchedSelectors=new ArrayList(1);
        matchedSelectors.add(sel);
        if (!sel.continueMatching()) {
          if (removedSelectors == null)           removedSelectors=new ArrayList(1);
          removedSelectors.add(sel);
          _selectors.remove(i);
          i--;
        }
      }
    }
  }
  List rv=null;
  if (matchedSelectors != null) {
    rv=new ArrayList(matchedSelectors.size());
    for (int i=0; i < matchedSelectors.size(); i++) {
      MessageSelector sel=(MessageSelector)matchedSelectors.get(i);
      boolean removed=false;
      OutNetMessage msg=null;
synchronized (_selectorToMessage) {
        if ((removedSelectors != null) && (removedSelectors.contains(sel))) {
          msg=(OutNetMessage)_selectorToMessage.remove(sel);
          removed=true;
        }
 else {
          msg=(OutNetMessage)_selectorToMessage.get(sel);
        }
        if (msg != null)         rv.add(msg);
      }
      if (removed && msg != null) {
synchronized (_activeMessages) {
          _activeMessages.remove(msg);
        }
      }
    }
  }
 else {
    rv=Collections.EMPTY_LIST;
  }
  return rv;
}
