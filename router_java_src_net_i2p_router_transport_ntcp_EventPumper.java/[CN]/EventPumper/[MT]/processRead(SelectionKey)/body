{
  NTCPConnection con=(NTCPConnection)key.attachment();
  ByteBuffer buf=acquireBuf();
  try {
    int read=con.getChannel().read(buf);
    if (read == -1) {
      _context.statManager().addRateData("ntcp.readEOF",1);
      con.close();
      releaseBuf(buf);
    }
 else     if (read == 0) {
      key.interestOps(key.interestOps() | SelectionKey.OP_READ);
      releaseBuf(buf);
    }
 else     if (read > 0) {
      byte data[]=new byte[read];
      buf.flip();
      buf.get(data);
      releaseBuf(buf);
      buf=null;
      ByteBuffer rbuf=ByteBuffer.wrap(data);
      FIFOBandwidthLimiter.Request req=_context.bandwidthLimiter().requestInbound(read,"NTCP read");
      if (req.getPendingInboundRequested() > 0) {
        key.interestOps(key.interestOps() & ~SelectionKey.OP_READ);
        _context.statManager().addRateData("ntcp.queuedRecv",read);
        con.queuedRecv(rbuf,req);
      }
 else {
        key.interestOps(key.interestOps() | SelectionKey.OP_READ);
        con.recv(rbuf);
      }
    }
  }
 catch (  CancelledKeyException cke) {
    if (_log.shouldLog(Log.WARN))     _log.warn("error reading",cke);
    con.close();
    _context.statManager().addRateData("ntcp.readError",1);
    if (buf != null)     releaseBuf(buf);
  }
catch (  IOException ioe) {
    if (_log.shouldLog(Log.WARN))     _log.warn("error reading",ioe);
    con.close();
    _context.statManager().addRateData("ntcp.readError",1);
    if (buf != null)     releaseBuf(buf);
  }
catch (  NotYetConnectedException nyce) {
  }
}
