{
  NTCPConnection con=(NTCPConnection)key.attachment();
  ByteBuffer buf=acquireBuf();
  try {
    int read=con.getChannel().read(buf);
    if (read == -1) {
      con.close();
      releaseBuf(buf);
    }
 else     if (read == 0) {
      releaseBuf(buf);
      int consec=con.gotZeroRead();
      if (consec >= 5) {
        _context.statManager().addRateData("ntcp.zeroReadDrop",1);
        if (_log.shouldLog(Log.WARN))         _log.warn("Fail safe zero read close " + con);
        con.close();
      }
 else {
        _context.statManager().addRateData("ntcp.zeroRead",consec);
        if (_log.shouldLog(Log.INFO))         _log.info("nothing to read for " + con + ", but stay interested");
      }
    }
 else     if (read > 0) {
      con.clearZeroRead();
      buf.flip();
      FIFOBandwidthLimiter.Request req=_context.bandwidthLimiter().requestInbound(read,"NTCP read");
      if (req.getPendingInboundRequested() > 0) {
        key.interestOps(key.interestOps() & ~SelectionKey.OP_READ);
        _context.statManager().addRateData("ntcp.queuedRecv",read);
        con.queuedRecv(buf,req);
      }
 else {
        con.recv(buf);
        _context.statManager().addRateData("ntcp.read",read);
      }
    }
  }
 catch (  CancelledKeyException cke) {
    releaseBuf(buf);
    if (_log.shouldLog(Log.WARN))     _log.warn("error reading on " + con,cke);
    con.close();
    _context.statManager().addRateData("ntcp.readError",1);
  }
catch (  IOException ioe) {
    releaseBuf(buf);
    if (_log.shouldLog(Log.INFO))     _log.info("error reading on " + con,ioe);
    if (con.isEstablished()) {
      _context.statManager().addRateData("ntcp.readError",1);
    }
 else {
      _context.statManager().addRateData("ntcp.connectFailedTimeoutIOE",1);
      RouterIdentity rem=con.getRemotePeer();
      if (rem != null)       _transport.markUnreachable(rem.calculateHash());
    }
    con.close();
  }
catch (  NotYetConnectedException nyce) {
    releaseBuf(buf);
    key.interestOps(key.interestOps() & ~SelectionKey.OP_READ);
    if (_log.shouldLog(Log.WARN))     _log.warn("error reading on " + con,nyce);
  }
}
