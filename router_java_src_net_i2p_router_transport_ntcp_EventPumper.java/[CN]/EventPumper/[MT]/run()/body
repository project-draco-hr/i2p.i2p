{
  long lastFailsafeIteration=System.currentTimeMillis();
  List bufList=new ArrayList(16);
  while (_alive && _selector.isOpen()) {
    try {
      runDelayedEvents(bufList);
      int count=0;
      try {
        count=_selector.select(200);
      }
 catch (      IOException ioe) {
        if (_log.shouldLog(Log.WARN))         _log.warn("Error selecting",ioe);
      }
      if (count <= 0)       continue;
      if (_log.shouldLog(Log.DEBUG))       _log.debug("select returned " + count);
      Set selected=null;
      try {
        selected=_selector.selectedKeys();
      }
 catch (      ClosedSelectorException cse) {
        continue;
      }
      processKeys(selected);
      selected.clear();
      if (lastFailsafeIteration + FAILSAFE_ITERATION_FREQ < System.currentTimeMillis()) {
        lastFailsafeIteration=System.currentTimeMillis();
        try {
          Set all=_selector.keys();
          int failsafeWrites=0;
          int failsafeCloses=0;
          long expireIdleWriteTime=20 * 60 * 1000l;
          for (Iterator iter=all.iterator(); iter.hasNext(); ) {
            try {
              SelectionKey key=(SelectionKey)iter.next();
              Object att=key.attachment();
              if (!(att instanceof NTCPConnection))               continue;
              NTCPConnection con=(NTCPConnection)att;
              if ((con.getWriteBufCount() > 0) && ((key.interestOps() & SelectionKey.OP_WRITE) == 0)) {
                key.interestOps(SelectionKey.OP_WRITE | key.interestOps());
                failsafeWrites++;
              }
              if (con.getTimeSinceSend() > expireIdleWriteTime && con.getTimeSinceReceive() > expireIdleWriteTime) {
                con.close();
                failsafeCloses++;
              }
            }
 catch (            CancelledKeyException cke) {
            }
            if (failsafeWrites > 0)             _context.statManager().addRateData("ntcp.failsafeWrites",failsafeWrites,0);
            if (failsafeCloses > 0)             _context.statManager().addRateData("ntcp.failsafeCloses",failsafeCloses,0);
          }
        }
 catch (        ClosedSelectorException cse) {
          continue;
        }
      }
    }
 catch (    RuntimeException re) {
      _log.log(Log.CRIT,"Error in the event pumper",re);
    }
  }
  try {
    if (_selector.isOpen()) {
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Closing down the event pumper with selection keys remaining");
      Set keys=_selector.keys();
      for (Iterator iter=keys.iterator(); iter.hasNext(); ) {
        SelectionKey key=(SelectionKey)iter.next();
        try {
          Object att=key.attachment();
          if (att instanceof ServerSocketChannel) {
            ServerSocketChannel chan=(ServerSocketChannel)att;
            chan.close();
            key.cancel();
          }
 else           if (att instanceof NTCPConnection) {
            NTCPConnection con=(NTCPConnection)att;
            con.close();
            key.cancel();
          }
        }
 catch (        Exception ke) {
          _log.error("Error closing key " + key + " on pumper shutdown",ke);
        }
      }
      _selector.close();
    }
 else {
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Closing down the event pumper with no selection keys remaining");
    }
  }
 catch (  Exception e) {
    _log.error("Error closing keys on pumper shutdown",e);
  }
synchronized (_wantsConRegister) {
    _wantsConRegister.clear();
  }
synchronized (_wantsRead) {
    _wantsRead.clear();
  }
synchronized (_wantsRegister) {
    _wantsRegister.clear();
  }
synchronized (_wantsWrite) {
    _wantsWrite.clear();
  }
}
