{
  createSocket();
  if ((_socket == null) || (_error != null))   return null;
  try {
    _socket.setSoTimeout(CONNECTION_TIMEOUT);
  }
 catch (  SocketException se) {
  }
  negotiateProtocol();
  if ((_agreedProtocol < 0) || (_error != null))   return null;
  boolean ok=false;
  if (_connectionTag != null)   ok=connectExistingSession();
 else   ok=connectNewSession();
  if (_log.shouldLog(Log.DEBUG))   _log.debug("connection ok? " + ok + " error: "+ _error);
  if (ok && (_error == null)) {
    establishComplete();
    try {
      _socket.setSoTimeout(0);
    }
 catch (    SocketException se) {
    }
    TCPConnection con=new TCPConnection(_context);
    con.setInputStream(_connectionIn);
    con.setOutputStream(_connectionOut);
    con.setSocket(_socket);
    con.setRemoteRouterIdentity(_actualPeer.getIdentity());
    con.setRemoteAddress(_remoteAddress);
    if (_error == null) {
      if (_log.shouldLog(Log.INFO))       _log.info("Establishment successful!  returning the con");
      return con;
    }
 else {
      return null;
    }
  }
 else {
    return null;
  }
}
