{
  msg.timestamp("TCPConnection.addMessage");
  List expired=null;
  int remaining=0;
  long remainingSize=0;
  long curSize=msg.getMessageSize();
synchronized (_pendingMessages) {
    _pendingMessages.add(msg);
    expired=locked_expireOld();
    List throttled=locked_throttle();
    if (expired == null)     expired=throttled;
 else     if (throttled != null)     expired.addAll(throttled);
    for (int i=0; i < _pendingMessages.size(); i++) {
      OutNetMessage cur=(OutNetMessage)_pendingMessages.get(i);
      remaining++;
      remainingSize+=cur.getMessageSize();
    }
    remaining=_pendingMessages.size();
    _pendingMessages.notifyAll();
  }
  if (expired != null) {
    for (int i=0; i < expired.size(); i++) {
      OutNetMessage cur=(OutNetMessage)expired.get(i);
      cur.timestamp("TCPConnection.addMessage expired");
      if (_log.shouldLog(Log.WARN))       _log.warn("Message " + cur.getMessageId() + " expired on the queue to "+ _ident.getHash().toBase64().substring(0,6)+ " (queue size "+ remaining+ "/"+ remainingSize+ ") with lifetime "+ cur.getLifetime()+ " and size "+ cur.getMessageSize());
      sent(cur,false,0);
    }
  }
}
