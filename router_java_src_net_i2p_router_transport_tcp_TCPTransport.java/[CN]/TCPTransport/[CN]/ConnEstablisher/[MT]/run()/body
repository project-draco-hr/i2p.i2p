{
  Thread.currentThread().setName("Conn Establisher" + _id + ':'+ _listenPort);
  while (_running) {
    try {
      PendingMessages pending=nextPeer(this);
      long start=_context.clock().now();
      if (_log.shouldLog(Log.INFO))       _log.info("Beginning establishment with " + pending.getPeer().toBase64() + " [not error]");
      TCPConnection con=getConnection(pending.getPeerInfo().getIdentity());
      long conFetched=_context.clock().now();
      long sentPending=0;
      long establishedCon=0;
      long refetchedCon=0;
      long sentRefetched=0;
      long failedPending=0;
      if (con != null) {
        sendPending(con,pending);
        sentPending=_context.clock().now();
      }
 else {
        boolean established=establishConnection(pending.getPeerInfo());
        establishedCon=_context.clock().now();
        if (established) {
          _context.statManager().updateFrequency("tcp.attemptSuccessFrequency");
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Connection established");
          con=getConnection(pending.getPeerInfo().getIdentity());
          refetchedCon=_context.clock().now();
          if (con == null) {
            if (_log.shouldLog(Log.ERROR))             _log.error("Connection established but we can't find the connection? wtf!  peer = " + pending.getPeer());
          }
 else {
            _context.shitlist().unshitlistRouter(pending.getPeer());
            sendPending(con,pending);
            sentRefetched=_context.clock().now();
          }
        }
 else {
          _context.statManager().updateFrequency("tcp.attemptFailureFrequency");
          if (_log.shouldLog(Log.INFO))           _log.info("Unable to establish a connection to " + pending.getPeer());
          failPending(pending);
          failedPending=_context.clock().now();
        }
      }
      long end=_context.clock().now();
      long diff=end - start;
      StringBuffer buf=new StringBuffer(128);
      buf.append("Time to establish with ").append(pending.getPeer().toBase64()).append(": ").append(diff).append("ms");
      buf.append(" fetched: ").append(conFetched - start).append(" ms");
      if (sentPending != 0)       buf.append(" sendPending: ").append(sentPending - conFetched).append("ms");
      if (establishedCon != 0) {
        buf.append(" established: ").append(establishedCon - conFetched).append("ms");
        if (refetchedCon != 0) {
          buf.append(" refetched: ").append(refetchedCon - establishedCon).append("ms");
          if (sentRefetched != 0) {
            buf.append(" sentRefetched: ").append(sentRefetched - refetchedCon).append("ms");
          }
        }
 else {
          buf.append(" failedPending: ").append(failedPending - establishedCon).append("ms");
        }
      }
      if (diff > 6000) {
        if (_log.shouldLog(Log.WARN))         _log.warn(buf.toString());
      }
 else {
        if (_log.shouldLog(Log.INFO))         _log.info(buf.toString());
      }
    }
 catch (    Throwable t) {
      if (_log.shouldLog(Log.CRIT))       _log.log(Log.CRIT,"Error in connection establisher thread - NO MORE CONNECTIONS",t);
    }
  }
}
