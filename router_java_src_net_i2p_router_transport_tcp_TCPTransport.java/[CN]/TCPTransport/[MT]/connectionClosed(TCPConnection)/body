{
  Hash remotePeer=null;
  if (con == null)   return;
  RouterIdentity peer=con.getRemoteRouterIdentity();
  if (peer == null)   return;
  remotePeer=peer.getHash();
synchronized (_connectionLock) {
    TCPConnection cur=(TCPConnection)_connectionsByIdent.remove(remotePeer);
    if ((cur != null) && (cur != con))     _connectionsByIdent.put(cur.getRemoteRouterIdentity().getHash(),cur);
    cur=(TCPConnection)_connectionsByAddress.remove(con.getRemoteAddress().toString());
    if ((cur != null) && (cur != con))     _connectionsByAddress.put(cur.getRemoteAddress().toString(),cur);
    if (_log.shouldLog(Log.DEBUG)) {
      StringBuffer buf=new StringBuffer(256);
      buf.append("\nCLOSING ").append(con.getRemoteRouterIdentity().getHash().toBase64().substring(0,6));
      buf.append(".");
      if (cur != null)       buf.append("\nconnectionsByAddress: (cur=").append(con.getRemoteAddress().toString()).append(") ");
      for (Iterator iter=_connectionsByAddress.keySet().iterator(); iter.hasNext(); ) {
        String addr=(String)iter.next();
        buf.append(addr).append(" ");
      }
      buf.append("\nconnectionsByIdent: ");
      for (Iterator iter=_connectionsByIdent.keySet().iterator(); iter.hasNext(); ) {
        Hash h=(Hash)iter.next();
        buf.append(h.toBase64().substring(0,6)).append(" ");
      }
      _log.debug(buf.toString(),new Exception("Closed by"));
    }
  }
}
