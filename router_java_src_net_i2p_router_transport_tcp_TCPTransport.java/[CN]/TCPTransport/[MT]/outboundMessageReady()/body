{
  OutNetMessage msg=getNextMessage();
  if (msg != null) {
    if (msg.getTarget() == null)     throw new IllegalStateException("Null target for a ready message?");
    msg.timestamp("TCPTransport.outboundMessageReady");
    TCPConnection con=null;
    boolean newPeer=false;
    Hash peer=msg.getTarget().getIdentity().calculateHash();
synchronized (_connectionLock) {
      con=(TCPConnection)_connectionsByIdent.get(peer);
      if (con == null) {
        if (_log.shouldLog(Log.DEBUG)) {
          StringBuffer buf=new StringBuffer(128);
          buf.append("No connections to ");
          buf.append(peer.toBase64().substring(0,6));
          buf.append(", but we are connected to ");
          for (Iterator iter=_connectionsByIdent.keySet().iterator(); iter.hasNext(); ) {
            Hash cur=(Hash)iter.next();
            buf.append(cur.toBase64().substring(0,6)).append(", ");
          }
          _log.debug(buf.toString());
        }
        List msgs=(List)_pendingMessages.get(peer);
        if (msgs == null) {
          msgs=new ArrayList(4);
          _pendingMessages.put(peer,msgs);
          newPeer=true;
        }
        msgs.add(msg);
        msg.timestamp("TCPTransport.outboundMessageReady queued behind " + (msgs.size() - 1));
        if (newPeer)         _connectionLock.notifyAll();
      }
    }
    if (con != null)     con.addMessage(msg);
  }
}
