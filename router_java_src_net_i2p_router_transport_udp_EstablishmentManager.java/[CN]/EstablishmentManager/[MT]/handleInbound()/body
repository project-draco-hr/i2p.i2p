{
  long now=_context.clock().now();
  long nextSendTime=-1;
  InboundEstablishState inboundState=null;
synchronized (_inboundStates) {
    for (Iterator iter=_inboundStates.values().iterator(); iter.hasNext(); ) {
      InboundEstablishState cur=(InboundEstablishState)iter.next();
      if (cur.getState() == InboundEstablishState.STATE_CONFIRMED_COMPLETELY) {
        iter.remove();
        inboundState=cur;
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Removing completely confirmed inbound state");
        break;
      }
 else       if (cur.getLifetime() > MAX_ESTABLISH_TIME) {
        iter.remove();
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Removing expired inbound state");
      }
 else {
        if (cur.getNextSendTime() <= now) {
          inboundState=cur;
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Processing inbound that wanted activity");
          break;
        }
 else {
          long when=-1;
          if (cur.getNextSendTime() <= 0) {
            when=cur.getEstablishBeginTime() + MAX_ESTABLISH_TIME;
          }
 else {
            when=cur.getNextSendTime();
          }
          if (when < nextSendTime)           nextSendTime=when;
        }
      }
    }
  }
  if (inboundState != null) {
switch (inboundState.getState()) {
case InboundEstablishState.STATE_REQUEST_RECEIVED:
      sendCreated(inboundState);
    break;
case InboundEstablishState.STATE_CREATED_SENT:
case InboundEstablishState.STATE_CONFIRMED_PARTIALLY:
  if (inboundState.getNextSendTime() <= now)   sendCreated(inboundState);
break;
case InboundEstablishState.STATE_CONFIRMED_COMPLETELY:
if (inboundState.getConfirmedIdentity() != null) {
handleCompletelyEstablished(inboundState);
break;
}
 else {
if (_log.shouldLog(Log.WARN)) _log.warn("why are we confirmed with no identity? " + inboundState);
break;
}
case InboundEstablishState.STATE_UNKNOWN:
default :
if (_log.shouldLog(Log.ERROR)) _log.error("hrm, state is unknown for " + inboundState);
}
nextSendTime=now;
}
return nextSendTime;
}
