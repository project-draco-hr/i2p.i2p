{
  long now=_context.clock().now();
  long nextSendTime=-1;
  InboundEstablishState inboundState=null;
  for (Iterator<InboundEstablishState> iter=_inboundStates.values().iterator(); iter.hasNext(); ) {
    InboundEstablishState cur=iter.next();
    if (cur.getState() == InboundEstablishState.STATE_CONFIRMED_COMPLETELY) {
      iter.remove();
      inboundState=cur;
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Removing completely confirmed inbound state");
      break;
    }
 else     if (cur.getLifetime() > MAX_ESTABLISH_TIME) {
      iter.remove();
      _context.statManager().addRateData("udp.inboundEstablishFailedState",cur.getState(),cur.getLifetime());
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Removing expired inbound state");
    }
 else     if (cur.getState() == InboundEstablishState.STATE_FAILED) {
      iter.remove();
      _context.statManager().addRateData("udp.inboundEstablishFailedState",cur.getState(),cur.getLifetime());
    }
 else {
      if (cur.getNextSendTime() <= now) {
        inboundState=cur;
        break;
      }
 else {
        long when=-1;
        if (cur.getNextSendTime() <= 0) {
          when=cur.getEstablishBeginTime() + MAX_ESTABLISH_TIME;
        }
 else {
          when=cur.getNextSendTime();
        }
        if (when < nextSendTime)         nextSendTime=when;
      }
    }
  }
  if (inboundState != null) {
switch (inboundState.getState()) {
case InboundEstablishState.STATE_REQUEST_RECEIVED:
      sendCreated(inboundState);
    break;
case InboundEstablishState.STATE_CREATED_SENT:
case InboundEstablishState.STATE_CONFIRMED_PARTIALLY:
  if (inboundState.getNextSendTime() <= now)   sendCreated(inboundState);
break;
case InboundEstablishState.STATE_CONFIRMED_COMPLETELY:
RouterIdentity remote=inboundState.getConfirmedIdentity();
if (remote != null) {
if (_context.shitlist().isShitlistedForever(remote.calculateHash())) {
if (_log.shouldLog(Log.WARN)) _log.warn("Dropping inbound connection from permanently shitlisted peer: " + remote.calculateHash().toBase64());
_context.blocklist().add(inboundState.getSentIP());
inboundState.fail();
break;
}
handleCompletelyEstablished(inboundState);
break;
}
 else {
if (_log.shouldLog(Log.WARN)) _log.warn("confirmed with invalid? " + inboundState);
inboundState.fail();
break;
}
case InboundEstablishState.STATE_FAILED:
break;
case InboundEstablishState.STATE_UNKNOWN:
default :
if (_log.shouldLog(Log.ERROR)) _log.error("hrm, state is unknown for " + inboundState);
}
nextSendTime=now;
}
return nextSendTime;
}
