{
  if (!_transport.isValid(from.getIP()))   return;
  int maxInbound=getMaxInboundEstablishers();
  boolean isNew=false;
  if (_inboundStates.size() >= maxInbound) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Dropping inbound establish, increase " + PROP_MAX_CONCURRENT_ESTABLISH);
    _context.statManager().addRateData("udp.establishDropped",1);
    return;
  }
  InboundEstablishState state=_inboundStates.get(from);
  if (state == null) {
    if (_context.blocklist().isBlocklisted(from.getIP())) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Receive session request from blocklisted IP: " + from);
      return;
    }
    if (!_transport.allowConnection())     return;
    state=new InboundEstablishState(_context,from.getIP(),from.getPort(),_transport.getLocalPort(),_transport.getDHBuilder());
    state.receiveSessionRequest(reader.getSessionRequestReader());
    InboundEstablishState oldState=_inboundStates.putIfAbsent(from,state);
    isNew=oldState == null;
    if (!isNew)     state=oldState;
  }
  if (isNew) {
    if ((!_context.router().isHidden()) && (!_transport.introducersRequired()) && _transport.haveCapacity()&& !((FloodfillNetworkDatabaseFacade)_context.netDb()).floodfillEnabled()) {
      long tag=1 + _context.random().nextLong(MAX_TAG_VALUE);
      state.setSentRelayTag(tag);
      if (_log.shouldLog(Log.INFO))       _log.info("Received session request from " + from + ", sending relay tag "+ tag);
    }
 else {
      if (_log.shouldLog(Log.INFO))       _log.info("Received session request, but our status is " + _transport.getReachabilityStatus());
    }
  }
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Receive session request from: " + state.getRemoteHostId().toString());
  notifyActivity();
}
