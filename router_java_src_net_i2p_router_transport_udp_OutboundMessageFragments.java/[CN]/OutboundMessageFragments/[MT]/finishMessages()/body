{
  int rv=0;
synchronized (_activePeers) {
    for (int i=0; i < _activePeers.size(); i++) {
      PeerState state=(PeerState)_activePeers.get(i);
      int remaining=state.finishMessages();
      if (remaining <= 0) {
        _activePeers.remove(i);
        if (_log.shouldLog(Log.DEBUG))         _log.debug("No more pending messages for " + state.getRemotePeer().toBase64());
        i--;
      }
      rv+=remaining;
    }
  }
}
