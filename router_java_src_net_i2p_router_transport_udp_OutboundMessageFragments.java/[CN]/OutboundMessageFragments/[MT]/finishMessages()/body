{
  int rv=0;
  List peers=new ArrayList();
synchronized (_activePeers) {
    peers=new ArrayList(_activePeers);
    for (int i=0; i < _activePeers.size(); i++) {
      PeerState state=(PeerState)_activePeers.get(i);
      if (state.getOutboundMessageCount() <= 0) {
        _activePeers.remove(i);
        i--;
      }
    }
    _activePeers.notifyAll();
  }
  for (int i=0; i < peers.size(); i++) {
    PeerState state=(PeerState)peers.get(i);
    int remaining=state.finishMessages();
    if (remaining <= 0) {
      if (_log.shouldLog(Log.DEBUG))       _log.debug("No more pending messages for " + state.getRemotePeer().toBase64());
    }
    rv+=remaining;
  }
}
