{
  if (state != null) {
    int fragments=state.getFragmentCount();
    if (fragments < 0)     return null;
    int sparseCount=0;
    UDPPacket rv[]=new UDPPacket[fragments];
    for (int i=0; i < fragments; i++) {
      if (state.needsSending(i))       rv[i]=_builder.buildPacket(state,i,peer);
 else       sparseCount++;
    }
    if (sparseCount > 0)     _context.statManager().addRateData("udp.sendSparse",sparseCount,state.getLifetime());
    if (_log.shouldLog(Log.INFO))     _log.info("Building packet for " + state + " to "+ peer+ " with sparse count: "+ sparseCount);
    peer.packetsTransmitted(fragments - sparseCount);
    return rv;
  }
 else {
    return null;
  }
}
