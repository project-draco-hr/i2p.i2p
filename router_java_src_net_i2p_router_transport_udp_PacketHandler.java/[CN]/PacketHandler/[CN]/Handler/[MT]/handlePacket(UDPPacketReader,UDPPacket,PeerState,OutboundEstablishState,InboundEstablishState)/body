{
  _state=43;
  reader.initialize(packet);
  _state=44;
  long recvOn=packet.getBegin();
  long sendOn=reader.readTimestamp() * 1000;
  long skew=recvOn - sendOn;
  if (skew > GRACE_PERIOD) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Packet too far in the past: " + new Date(sendOn / 1000) + ": "+ packet);
    _context.statManager().addRateData("udp.droppedInvalidSkew",skew,packet.getExpiration());
    return;
  }
 else   if (skew < 0 - GRACE_PERIOD) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Packet too far in the future: " + new Date(sendOn / 1000) + ": "+ packet);
    _context.statManager().addRateData("udp.droppedInvalidSkew",0 - skew,packet.getExpiration());
    return;
  }
  if (state != null) {
    if (_log.shouldLog(Log.DEBUG))     _log.debug("Received packet from " + state.getRemoteHostId().toString() + " with skew "+ skew);
    state.adjustClockSkew((short)skew);
  }
  _context.statManager().addRateData("udp.receivePacketSkew",skew,packet.getLifetime());
  _state=45;
  RemoteHostId from=packet.getRemoteHost();
  _state=46;
switch (reader.readPayloadType()) {
case UDPPacket.PAYLOAD_TYPE_SESSION_REQUEST:
    _state=47;
  _establisher.receiveSessionRequest(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.sessionRequest",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_SESSION_CONFIRMED:
_state=48;
_establisher.receiveSessionConfirmed(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.sessionConfirmed",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_SESSION_CREATED:
_state=49;
_establisher.receiveSessionCreated(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.sessionCreated",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_DATA:
_state=50;
if (outState != null) state=_establisher.receiveData(outState);
if (_log.shouldLog(Log.DEBUG)) _log.debug("Received new DATA packet from " + state + ": "+ packet);
if (state != null) {
UDPPacketReader.DataReader dr=reader.getDataReader();
if (_log.shouldLog(Log.INFO)) {
StringBuilder msg=new StringBuilder();
msg.append("Receive ").append(System.identityHashCode(packet));
msg.append(" from ").append(state.getRemotePeer().toBase64()).append(" ").append(state.getRemoteHostId());
for (int i=0; i < dr.readFragmentCount(); i++) {
msg.append(" msg ").append(dr.readMessageId(i));
msg.append(":").append(dr.readMessageFragmentNum(i));
if (dr.readMessageIsLast(i)) msg.append("*");
}
msg.append(": ").append(dr.toString());
_log.info(msg.toString());
}
packet.beforeReceiveFragments();
_inbound.receiveData(state,dr);
_context.statManager().addRateData("udp.receivePacketSize.dataKnown",packet.getPacket().getLength(),packet.getLifetime());
if (dr.readFragmentCount() <= 0) _context.statManager().addRateData("udp.receivePacketSize.dataKnownAck",packet.getPacket().getLength(),packet.getLifetime());
}
 else {
_context.statManager().addRateData("udp.receivePacketSize.dataUnknown",packet.getPacket().getLength(),packet.getLifetime());
UDPPacketReader.DataReader dr=reader.getDataReader();
if (dr.readFragmentCount() <= 0) _context.statManager().addRateData("udp.receivePacketSize.dataUnknownAck",packet.getPacket().getLength(),packet.getLifetime());
}
break;
case UDPPacket.PAYLOAD_TYPE_TEST:
_state=51;
if (_log.shouldLog(Log.DEBUG)) _log.debug("Received test packet: " + reader + " from "+ from);
_testManager.receiveTest(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.test",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_RELAY_REQUEST:
if (_log.shouldLog(Log.INFO)) _log.info("Received relay request packet: " + reader + " from "+ from);
_introManager.receiveRelayRequest(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.relayRequest",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_RELAY_INTRO:
if (_log.shouldLog(Log.INFO)) _log.info("Received relay intro packet: " + reader + " from "+ from);
_introManager.receiveRelayIntro(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.relayIntro",packet.getPacket().getLength(),packet.getLifetime());
break;
case UDPPacket.PAYLOAD_TYPE_RELAY_RESPONSE:
if (_log.shouldLog(Log.INFO)) _log.info("Received relay response packet: " + reader + " from "+ from);
_establisher.receiveRelayResponse(from,reader);
_context.statManager().addRateData("udp.receivePacketSize.relayResponse",packet.getPacket().getLength(),packet.getLifetime());
break;
default :
_state=52;
if (_log.shouldLog(Log.WARN)) _log.warn("Unknown payload type: " + reader.readPayloadType());
_context.statManager().addRateData("udp.droppedInvalidUnknown",packet.getLifetime(),packet.getExpiration());
return;
}
}
