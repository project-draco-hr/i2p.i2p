{
  if (_dead) {
    _transport.failed(state,false);
    return 0;
  }
  state.setPeer(this);
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Adding to " + _remotePeer.toBase64() + ": "+ state.getMessageId());
  List<OutboundMessageState> msgs=_outboundMessages;
  int rv=0;
  boolean fail=false;
synchronized (msgs) {
    rv=msgs.size() + 1;
    if (rv > 32) {
      fail=true;
      rv--;
    }
 else {
      msgs.add(state);
    }
  }
  if (fail)   _transport.failed(state,false);
  return rv;
}
