{
  PeerState charlie=null;
  RouterInfo charlieInfo=null;
  if (state == null) {
    for (int i=0; i < 5; i++) {
      charlie=_transport.getPeerState(UDPAddress.CAPACITY_TESTING);
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Picking charlie as " + charlie + " for alice of "+ from);
      if ((charlie != null) && (!DataHelper.eq(charlie.getRemoteHostId(),from))) {
        charlieInfo=_context.netDb().lookupRouterInfoLocally(charlie.getRemotePeer());
        if (charlieInfo != null)         break;
      }
      charlie=null;
    }
  }
 else {
    charlie=_transport.getPeerState(new RemoteHostId(state.getCharlieIP().getAddress(),state.getCharliePort()));
    if (charlie != null)     charlieInfo=_context.netDb().lookupRouterInfoLocally(charlie.getRemotePeer());
  }
  if (charlie == null) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Unable to pick a charlie");
    return;
  }
  InetAddress aliceIP=null;
  SessionKey aliceIntroKey=null;
  try {
    aliceIP=InetAddress.getByAddress(from.getIP());
    aliceIntroKey=new SessionKey(new byte[SessionKey.KEYSIZE_BYTES]);
    testInfo.readIntroKey(aliceIntroKey.getData(),0);
    UDPAddress addr=new UDPAddress(charlieInfo.getTargetAddress(UDPTransport.STYLE));
    SessionKey charlieIntroKey=new SessionKey(addr.getIntroKey());
    boolean isNew=false;
    if (state == null) {
      isNew=true;
      state=new PeerTestState();
      state.setBeginTime(_context.clock().now());
    }
    state.setAliceIP(aliceIP);
    state.setAlicePort(from.getPort());
    state.setAliceIntroKey(aliceIntroKey);
    state.setNonce(nonce);
    state.setCharlieIP(charlie.getRemoteIPAddress());
    state.setCharliePort(charlie.getRemotePort());
    state.setCharlieIntroKey(charlieIntroKey);
    state.setLastSendTime(_context.clock().now());
    state.setOurRole(PeerTestState.BOB);
    state.setReceiveAliceTime(_context.clock().now());
    if (isNew) {
synchronized (_activeTests) {
        _activeTests.put(new Long(nonce),state);
      }
      SimpleTimer.getInstance().addEvent(new RemoveTest(nonce),MAX_CHARLIE_LIFETIME);
    }
    UDPPacket packet=_packetBuilder.buildPeerTestToCharlie(aliceIP,from.getPort(),aliceIntroKey,nonce,charlie.getRemoteIPAddress(),charlie.getRemotePort(),charlie.getCurrentCipherKey(),charlie.getCurrentMACKey());
    if (_log.shouldLog(Log.DEBUG))     _log.debug("Receive from alice as bob for " + nonce + ", picking charlie @ "+ charlie.getRemoteIPAddress()+ ":"+ charlie.getRemotePort()+ " for alice @ "+ aliceIP+ ":"+ from.getPort());
    _transport.send(packet);
  }
 catch (  UnknownHostException uhe) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Unable to build the aliceIP from " + from,uhe);
  }
}
