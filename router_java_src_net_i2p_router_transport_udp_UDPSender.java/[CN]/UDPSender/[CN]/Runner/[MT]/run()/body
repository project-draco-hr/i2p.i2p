{
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Running the UDP sender");
  _socketChanged=false;
  while (_keepRunning) {
    if (_socketChanged) {
      Thread.currentThread().setName(_name);
      _socketChanged=false;
    }
    UDPPacket packet=getNextPacket();
    if (packet != null) {
      if (_log.shouldLog(Log.DEBUG))       _log.debug("Packet to send known: " + packet);
      long acquireTime=_context.clock().now();
      int size=packet.getPacket().getLength();
      int size2=packet.getPacket().getLength();
      if (size > 0) {
        FIFOBandwidthLimiter.Request req=_context.bandwidthLimiter().requestOutbound(size,"UDP sender");
        while (req.getPendingOutboundRequested() > 0)         req.waitForNextAllocation();
      }
      long afterBW=_context.clock().now();
      if (_log.shouldLog(Log.DEBUG)) {
      }
      _context.statManager().addRateData("udp.sendPacketSize." + packet.getMessageType(),size,packet.getFragmentCount());
      try {
        long before=_context.clock().now();
synchronized (Runner.this) {
          DatagramPacket dp=packet.getPacket();
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Just before socket.send of " + packet);
          _socket.send(dp);
          if (_log.shouldLog(Log.DEBUG))           _log.debug("Just after socket.send of " + packet);
        }
        long sendTime=_context.clock().now() - before;
        _context.statManager().addRateData("udp.socketSendTime",sendTime,packet.getLifetime());
        if (_log.shouldLog(Log.INFO))         _log.info("Sent the packet " + packet);
        long throttleTime=afterBW - acquireTime;
        if (throttleTime > 10)         _context.statManager().addRateData("udp.sendBWThrottleTime",throttleTime,acquireTime - packet.getBegin());
        if (packet.getMarkedType() == 1)         _context.statManager().addRateData("udp.sendACKTime",throttleTime,packet.getLifetime());
        _context.statManager().addRateData("udp.pushTime",packet.getLifetime(),packet.getLifetime());
        _context.statManager().addRateData("udp.sendPacketSize",size,packet.getLifetime());
      }
 catch (      IOException ioe) {
        if (_log.shouldLog(Log.WARN))         _log.warn("Error sending",ioe);
        _context.statManager().addRateData("udp.sendException",1,packet.getLifetime());
      }
      packet.release();
    }
  }
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Stop sending...");
}
