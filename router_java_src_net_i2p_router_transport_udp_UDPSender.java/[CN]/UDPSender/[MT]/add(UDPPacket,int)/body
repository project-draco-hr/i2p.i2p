{
  long expiration=_context.clock().now() + blockTime;
  int remaining=-1;
  long lifetime=-1;
  boolean added=false;
  int removed=0;
  while ((_keepRunning) && (remaining < 0)) {
    try {
synchronized (_outboundQueue) {
        UDPPacket head=null;
        if (_outboundQueue.size() > 0) {
          head=(UDPPacket)_outboundQueue.get(0);
          while (head.getLifetime() > MAX_HEAD_LIFETIME) {
            _outboundQueue.remove(0);
            removed++;
            if (_outboundQueue.size() > 0)             head=(UDPPacket)_outboundQueue.get(0);
 else             break;
          }
        }
        if (true || (_outboundQueue.size() < MAX_QUEUED)) {
          lifetime=packet.getLifetime();
          _outboundQueue.add(packet);
          added=true;
          remaining=_outboundQueue.size();
          _outboundQueue.notifyAll();
        }
 else {
          long remainingTime=expiration - _context.clock().now();
          if (remainingTime > 0) {
            _outboundQueue.wait(remainingTime);
          }
 else {
            remaining=_outboundQueue.size();
            _outboundQueue.notifyAll();
          }
          lifetime=packet.getLifetime();
        }
      }
    }
 catch (    InterruptedException ie) {
    }
  }
  _context.statManager().addRateData("udp.sendQueueSize",remaining,lifetime);
  if (!added)   _context.statManager().addRateData("udp.sendQueueFailed",remaining,lifetime);
  if (removed > 0)   _context.statManager().addRateData("udp.sendQueueTrimmed",removed,remaining);
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Added the packet onto the queue with " + remaining + " remaining and a lifetime of "+ lifetime);
  return remaining;
}
