{
  if (msg == null)   return;
  if (_log.shouldLog(Log.WARN))   _log.warn("Sending message failed: " + msg,new Exception("failed from"));
  _context.messageHistory().sendMessage(msg.getMessageType(),msg.getMessageId(),msg.getExpiration(),msg.getTarget().getIdentity().calculateHash(),false,reason);
  super.afterSend(msg,false);
}
