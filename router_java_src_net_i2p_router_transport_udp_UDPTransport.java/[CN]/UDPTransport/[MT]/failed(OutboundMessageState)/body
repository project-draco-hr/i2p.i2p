{
  if (msg == null)   return;
  int consecutive=0;
  OutNetMessage m=msg.getMessage();
  if ((msg.getPeer() != null) && ((msg.getMaxSends() >= OutboundMessageFragments.MAX_VOLLEYS) || (msg.isExpired()))) {
    long recvDelay=_context.clock().now() - msg.getPeer().getLastReceiveTime();
    long sendDelay=_context.clock().now() - msg.getPeer().getLastSendFullyTime();
    if (m != null)     m.timestamp("message failure - volleys = " + msg.getMaxSends() + " lastReceived: "+ recvDelay+ " lastSentFully: "+ sendDelay+ " expired? "+ msg.isExpired());
    consecutive=msg.getPeer().incrementConsecutiveFailedSends();
    if (_log.shouldLog(Log.WARN))     _log.warn("Consecutive failure #" + consecutive + " on "+ msg.toString()+ " to "+ msg.getPeer());
    if ((consecutive > MAX_CONSECUTIVE_FAILED) && (msg.getPeer().getInactivityTime() > DROP_INACTIVITY_TIME))     dropPeer(msg.getPeer(),false);
 else     if (consecutive > 2 * MAX_CONSECUTIVE_FAILED)     dropPeer(msg.getPeer(),false);
  }
  noteSend(msg,false);
  if (m != null)   super.afterSend(m,false);
}
