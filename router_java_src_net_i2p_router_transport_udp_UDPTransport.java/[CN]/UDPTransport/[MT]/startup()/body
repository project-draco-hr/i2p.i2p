{
  if (_fragments != null)   _fragments.shutdown();
  if (_pusher != null)   _pusher.shutdown();
  if (_handler != null)   _handler.shutdown();
  if (_endpoint != null)   _endpoint.shutdown();
  if (_establisher != null)   _establisher.shutdown();
  if (_refiller != null)   _refiller.shutdown();
  if (_inboundFragments != null)   _inboundFragments.shutdown();
  if (_flooder != null)   _flooder.shutdown();
  _introManager.reset();
  _introKey=new SessionKey(new byte[SessionKey.KEYSIZE_BYTES]);
  System.arraycopy(_context.routerHash().getData(),0,_introKey.getData(),0,SessionKey.KEYSIZE_BYTES);
  rebuildExternalAddress();
  int port=-1;
  if (_externalListenPort <= 0) {
    port=_context.getProperty(PROP_INTERNAL_PORT,DEFAULT_INTERNAL_PORT);
    if (port <= 0) {
      port=DEFAULT_INTERNAL_PORT;
      _context.router().setConfigSetting(PROP_INTERNAL_PORT,port + "");
    }
    _context.router().setConfigSetting(PROP_EXTERNAL_PORT,port + "");
    _context.router().saveConfig();
  }
 else {
    port=_externalListenPort;
    if (_log.shouldLog(Log.INFO))     _log.info("Binding to the explicitly specified external port: " + port);
  }
  if (_endpoint == null) {
    String bindTo=_context.getProperty(PROP_BIND_INTERFACE);
    InetAddress bindToAddr=null;
    if (bindTo != null) {
      try {
        bindToAddr=InetAddress.getByName(bindTo);
      }
 catch (      UnknownHostException uhe) {
        if (_log.shouldLog(Log.ERROR))         _log.error("Invalid SSU bind interface specified [" + bindTo + "]",uhe);
        bindToAddr=null;
      }
    }
    try {
      _endpoint=new UDPEndpoint(_context,this,port,bindToAddr);
    }
 catch (    SocketException se) {
      if (_log.shouldLog(Log.CRIT))       _log.log(Log.CRIT,"Unable to listen on the UDP port (" + port + ")",se);
      return;
    }
  }
 else {
    _endpoint.setListenPort(port);
  }
  if (_establisher == null)   _establisher=new EstablishmentManager(_context,this);
  if (_testManager == null)   _testManager=new PeerTestManager(_context,this);
  if (_handler == null)   _handler=new PacketHandler(_context,this,_endpoint,_establisher,_inboundFragments,_testManager,_introManager);
  if (_refiller == null)   _refiller=new OutboundRefiller(_context,_fragments,_outboundMessages);
  if (_flooder == null)   _flooder=new UDPFlooder(_context,this);
  _endpoint.startup();
  _establisher.startup();
  _handler.startup();
  _fragments.startup();
  _inboundFragments.startup();
  _pusher=new PacketPusher(_context,_fragments,_endpoint.getSender());
  _pusher.startup();
  _refiller.startup();
  _flooder.startup();
  _expireEvent.setIsAlive(true);
  _testEvent.setIsAlive(true);
  SimpleTimer.getInstance().addEvent(_testEvent,10 * 1000);
}
