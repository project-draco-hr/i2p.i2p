{
  _fragments.shutdown();
  if (_pusher != null)   _pusher.shutdown();
  if (_handler != null)   _handler.shutdown();
  for (  UDPEndpoint endpoint : _endpoints) {
    endpoint.shutdown();
    _endpoints.remove(endpoint);
  }
  if (_establisher != null)   _establisher.shutdown();
  if (_refiller != null)   _refiller.shutdown();
  _inboundFragments.shutdown();
  _introManager.reset();
  UDPPacket.clearCache();
  if (_log.shouldLog(Log.WARN))   _log.warn("Starting SSU transport listening");
  _introKey=new SessionKey(new byte[SessionKey.KEYSIZE_BYTES]);
  System.arraycopy(_context.routerHash().getData(),0,_introKey.getData(),0,SessionKey.KEYSIZE_BYTES);
  String bindTo=_context.getProperty(PROP_BIND_INTERFACE);
  if (bindTo == null) {
    String fixedHost=_context.getProperty(PROP_EXTERNAL_HOST);
    if (fixedHost != null && fixedHost.length() > 0) {
      try {
        String testAddr=InetAddress.getByName(fixedHost).getHostAddress();
        if (Addresses.getAddresses().contains(testAddr))         bindTo=testAddr;
      }
 catch (      UnknownHostException uhe) {
      }
    }
  }
  List<InetAddress> bindToAddrs=new ArrayList<InetAddress>(4);
  if (bindTo != null) {
    String[] bta=bindTo.split("[,; \r\n\t]");
    for (int i=0; i < bta.length; i++) {
      String bt=bta[i];
      if (bt.length() <= 0)       continue;
      try {
        bindToAddrs.add(InetAddress.getByName(bt));
      }
 catch (      UnknownHostException uhe) {
        _log.error("Invalid SSU bind interface specified [" + bt + "]",uhe);
      }
    }
  }
  int port;
  int oldIPort=_context.getProperty(PROP_INTERNAL_PORT,-1);
  int oldBindPort=getListenPort(false);
  int oldEPort=_context.getProperty(PROP_EXTERNAL_PORT,-1);
  if (oldIPort > 0)   port=oldIPort;
 else   if (oldBindPort > 0)   port=oldBindPort;
 else   port=oldEPort;
  if (!bindToAddrs.isEmpty() && _log.shouldLog(Log.WARN))   _log.warn("Binding only to " + bindToAddrs);
  if (_log.shouldLog(Log.INFO))   _log.info("Binding to the port: " + port);
  if (_endpoints.isEmpty()) {
    if (bindToAddrs.isEmpty()) {
      UDPEndpoint endpoint=new UDPEndpoint(_context,this,port,null);
      _endpoints.add(endpoint);
      setMTU(null);
    }
 else {
      for (      InetAddress bindToAddr : bindToAddrs) {
        UDPEndpoint endpoint=new UDPEndpoint(_context,this,port,bindToAddr);
        _endpoints.add(endpoint);
        setMTU(bindToAddr);
      }
    }
  }
 else {
    for (    UDPEndpoint endpoint : _endpoints) {
      if (endpoint.isIPv4()) {
        endpoint.setListenPort(port);
        break;
      }
    }
  }
  if (_establisher == null)   _establisher=new EstablishmentManager(_context,this);
  if (_testManager == null)   _testManager=new PeerTestManager(_context,this);
  if (_handler == null)   _handler=new PacketHandler(_context,this,_establisher,_inboundFragments,_testManager,_introManager);
  if (USE_PRIORITY && _refiller == null)   _refiller=new OutboundRefiller(_context,_fragments,_outboundMessages);
  int newPort=-1;
  for (  UDPEndpoint endpoint : _endpoints) {
    try {
      endpoint.startup();
      if (newPort < 0 && endpoint.isIPv4()) {
        newPort=endpoint.getListenPort();
      }
    }
 catch (    SocketException se) {
      _endpoints.remove(endpoint);
    }
  }
  if (_endpoints.isEmpty()) {
    _log.log(Log.CRIT,"Unable to open UDP port");
    setReachabilityStatus(CommSystemFacade.STATUS_HOSED);
    return;
  }
  if (newPort > 0 && (newPort != port || newPort != oldIPort || newPort != oldEPort)) {
    Map<String,String> changes=new HashMap<String,String>();
    changes.put(PROP_INTERNAL_PORT,Integer.toString(newPort));
    changes.put(PROP_EXTERNAL_PORT,Integer.toString(newPort));
    _context.router().saveConfig(changes,null);
  }
  _handler.startup();
  _fragments.startup();
  _inboundFragments.startup();
  _pusher=new PacketPusher(_context,_fragments,_endpoints);
  _pusher.startup();
  _establisher.startup();
  if (USE_PRIORITY)   _refiller.startup();
  _expireEvent.setIsAlive(true);
  _testEvent.setIsAlive(true);
  _testEvent.reschedule(10 * 1000);
  if (newPort > 0 && bindToAddrs.isEmpty()) {
    for (    InetAddress ia : getSavedLocalAddresses()) {
      rebuildExternalAddress(ia.getHostAddress(),newPort,false);
    }
  }
  rebuildExternalAddress(false);
}
