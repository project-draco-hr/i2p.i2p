{
  TunnelGateway.Pending pending1=createPending(10,false,false);
  ArrayList messages=new ArrayList();
  messages.add(pending1);
  TunnelGateway.Pending pending2=createPending(1024,false,false);
  TunnelGateway.QueuePreprocessor pre=createPreprocessor(_context);
  SenderImpl sender=new SenderImpl();
  DefragmentedReceiverImpl handleReceiver=new DefragmentedReceiverImpl(pending1.getData(),pending2.getData());
  FragmentHandler handler=new FragmentHandler(_context,handleReceiver);
  ReceiverImpl receiver=new ReceiverImpl(handler,0);
  byte msg[]=pending1.getData();
  _log.debug("SEND(" + msg.length + "): "+ Base64.encode(msg)+ " "+ _context.sha().calculateHash(msg).toBase64());
  boolean keepGoing=true;
  boolean alreadyAdded=false;
  while (keepGoing) {
    keepGoing=pre.preprocessQueue(messages,new SenderImpl(),receiver);
    if (keepGoing) {
      try {
        Thread.sleep(150);
      }
 catch (      InterruptedException ie) {
      }
      if (!alreadyAdded) {
        messages.add(pending2);
        alreadyAdded=true;
      }
    }
  }
  if (handleReceiver.receivedOk())   _log.info("Receive batched ok");
 else   _log.info("Failed to receive batched");
}
