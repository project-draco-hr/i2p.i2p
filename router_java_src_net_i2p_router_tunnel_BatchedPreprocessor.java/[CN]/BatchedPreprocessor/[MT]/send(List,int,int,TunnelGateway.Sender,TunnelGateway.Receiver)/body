{
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Sending " + startAt + ":"+ sendThrough+ " out of "+ pending);
  byte preprocessed[]=_dataCache.acquire().getData();
  int offset=0;
  offset=writeFragments(pending,startAt,sendThrough,preprocessed,offset);
  if (offset <= 0) {
    StringBuffer buf=new StringBuffer(128);
    buf.append("wtf, written offset is ").append(offset);
    buf.append(" for ").append(startAt).append(" through ").append(sendThrough);
    for (int i=startAt; i <= sendThrough; i++) {
      buf.append(" ").append(pending.get(i).toString());
    }
    _log.log(Log.CRIT,buf.toString());
    return;
  }
  preprocess(preprocessed,offset);
  long msgId=sender.sendPreprocessed(preprocessed,rec);
  for (int i=0; i < pending.size(); i++) {
    TunnelGateway.Pending cur=(TunnelGateway.Pending)pending.get(i);
    cur.addMessageId(msgId);
  }
}
