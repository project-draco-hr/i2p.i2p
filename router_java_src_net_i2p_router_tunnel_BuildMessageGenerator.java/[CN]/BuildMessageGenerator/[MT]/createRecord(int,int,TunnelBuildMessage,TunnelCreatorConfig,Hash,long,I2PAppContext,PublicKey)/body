{
  byte encrypted[]=new byte[TunnelBuildMessage.RECORD_SIZE];
  Log log=ctx.logManager().getLog(getClass());
  if (peerKey != null) {
    BuildRequestRecord req=null;
    if ((!cfg.isInbound()) && (hop + 1 == cfg.getLength()))     req=createUnencryptedRecord(ctx,cfg,hop,replyRouter,replyTunnel);
 else     req=createUnencryptedRecord(ctx,cfg,hop,null,-1);
    Hash peer=cfg.getPeer(hop);
    if (log.shouldLog(Log.DEBUG))     log.debug("Record " + recordNum + "/"+ hop+ "/"+ peer.toBase64()+ ": unencrypted = "+ Base64.encode(req.getData().getData()));
    req.encryptRecord(ctx,peerKey,peer,encrypted,0);
  }
 else {
    if (log.shouldLog(Log.DEBUG))     log.debug("Record " + recordNum + "/"+ hop+ "/ is blank/random");
    ctx.random().nextBytes(encrypted);
  }
  msg.setRecord(recordNum,new ByteArray(encrypted));
}
