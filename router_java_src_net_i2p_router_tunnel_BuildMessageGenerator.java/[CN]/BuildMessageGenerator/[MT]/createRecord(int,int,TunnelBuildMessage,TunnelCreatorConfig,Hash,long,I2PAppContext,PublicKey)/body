{
  byte encrypted[]=new byte[TunnelBuildMessage.RECORD_SIZE];
  if (peerKey != null) {
    BuildRequestRecord req=null;
    if ((!cfg.isInbound()) && (hop + 1 == cfg.getLength()))     req=createUnencryptedRecord(ctx,cfg,hop,replyRouter,replyTunnel);
 else     req=createUnencryptedRecord(ctx,cfg,hop,null,-1);
    Hash peer=cfg.getPeer(hop);
    req.encryptRecord(ctx,peerKey,peer,encrypted,0);
  }
 else {
    ctx.random().nextBytes(encrypted);
  }
  msg.setRecord(recordNum,new ByteArray(encrypted));
}
