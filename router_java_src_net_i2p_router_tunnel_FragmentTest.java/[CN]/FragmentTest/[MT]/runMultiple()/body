{
  TunnelGateway.Pending pending=createPending(2048,false,false);
  ArrayList messages=new ArrayList();
  messages.add(pending);
  TunnelGateway.QueuePreprocessor pre=createPreprocessor(_context);
  SenderImpl sender=new SenderImpl();
  DefragmentedReceiverImpl handleReceiver=new DefragmentedReceiverImpl(pending.getData());
  FragmentHandler handler=new FragmentHandler(_context,handleReceiver);
  ReceiverImpl receiver=new ReceiverImpl(handler,0);
  byte msg[]=pending.getData();
  _log.debug("SEND(" + msg.length + "): "+ Base64.encode(msg)+ " "+ _context.sha().calculateHash(msg).toBase64());
  boolean keepGoing=true;
  while (keepGoing) {
    keepGoing=pre.preprocessQueue(messages,new SenderImpl(),receiver);
    if (keepGoing)     try {
      Thread.sleep(100);
    }
 catch (    InterruptedException ie) {
    }
  }
  if (handleReceiver.receivedOk())   _log.info("received OK");
}
