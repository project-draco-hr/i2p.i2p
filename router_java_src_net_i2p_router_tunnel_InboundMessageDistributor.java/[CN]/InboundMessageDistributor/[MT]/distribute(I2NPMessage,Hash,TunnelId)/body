{
  int type=msg.getType();
  if ((_client != null) && (type == DatabaseSearchReplyMessage.MESSAGE_TYPE) && (_client.equals(((DatabaseSearchReplyMessage)msg).getSearchKey()))) {
    DatabaseSearchReplyMessage orig=(DatabaseSearchReplyMessage)msg;
    if (orig.getNumReplies() > 0) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Removing replies from a DSRM down a tunnel for " + _client + ": "+ msg);
      DatabaseSearchReplyMessage newMsg=new DatabaseSearchReplyMessage(_context);
      newMsg.setFromHash(orig.getFromHash());
      newMsg.setSearchKey(orig.getSearchKey());
      msg=newMsg;
    }
  }
 else   if ((_client != null) && (type == DatabaseStoreMessage.MESSAGE_TYPE) && (((DatabaseStoreMessage)msg).getEntry().getType() == DatabaseEntry.KEY_TYPE_ROUTERINFO)) {
    if (_log.shouldLog(Log.WARN))     _log.warn("Dropping DSM down a tunnel for " + _client + ": "+ msg);
    return;
  }
 else   if ((_client != null) && (type != DeliveryStatusMessage.MESSAGE_TYPE) && (type != GarlicMessage.MESSAGE_TYPE)&& ((type != DatabaseStoreMessage.MESSAGE_TYPE) || (!_client.equals(((DatabaseStoreMessage)msg).getKey())) || (((DatabaseStoreMessage)msg).getReplyToken() != 0))&& (type != TunnelBuildReplyMessage.MESSAGE_TYPE)&& (type != VariableTunnelBuildReplyMessage.MESSAGE_TYPE)) {
    _context.statManager().addRateData("tunnel.dropDangerousClientTunnelMessage",1,type);
    _log.error("Dropped dangerous message down a tunnel for " + _client + ": "+ msg,new Exception("cause"));
    return;
  }
  if ((target == null) || ((tunnel == null) && (_context.routerHash().equals(target)))) {
    if (type == GarlicMessage.MESSAGE_TYPE) {
      _context.inNetMessagePool().handleReplies(msg);
      if (_log.shouldLog(Log.DEBUG))       _log.debug("received garlic message in the tunnel, parse it out");
      _receiver.receive((GarlicMessage)msg);
    }
 else {
      if (_log.shouldLog(Log.INFO))       _log.info("distributing inbound tunnel message into our inNetMessagePool: " + msg);
      _context.inNetMessagePool().add(msg,null,null);
    }
  }
 else {
    TunnelInfo out=_context.tunnelManager().selectOutboundTunnel(_client);
    if (out == null) {
      if (_log.shouldLog(Log.WARN))       _log.warn("no outbound tunnel to send the client message for " + _client + ": "+ msg);
      return;
    }
    if (_log.shouldLog(Log.INFO))     _log.info("distributing inbound tunnel message back out " + out + " targetting "+ target);
    TunnelId outId=out.getSendTunnelId(0);
    if (outId == null) {
      if (_log.shouldLog(Log.ERROR))       _log.error("wtf, outbound tunnel has no outboundId? " + out + " failing to distribute "+ msg);
      return;
    }
    if (msg.getMessageExpiration() < _context.clock().now() + 10 * 1000)     msg.setMessageExpiration(_context.clock().now() + 10 * 1000);
    _context.tunnelDispatcher().dispatchOutbound(msg,outId,tunnel,target);
  }
}
