{
  _found=false;
  TunnelInfo replyTunnel=null;
  TunnelInfo outTunnel=null;
  if (_cfg.isInbound()) {
    replyTunnel=_cfg;
    outTunnel=getContext().tunnelManager().selectOutboundTunnel();
  }
 else {
    replyTunnel=getContext().tunnelManager().selectInboundTunnel();
    outTunnel=_cfg;
  }
  if ((replyTunnel == null) || (outTunnel == null)) {
    if (_log.shouldLog(Log.ERROR))     _log.error("Insufficient tunnels to test " + _cfg + " with: "+ replyTunnel+ " / "+ outTunnel);
    getContext().statManager().addRateData("tunnel.testAborted",_cfg.getLength(),0);
    scheduleRetest();
  }
 else {
    int testPeriod=getTestPeriod();
    long testExpiration=getContext().clock().now() + testPeriod;
    DeliveryStatusMessage m=new DeliveryStatusMessage(getContext());
    m.setArrival(getContext().clock().now());
    m.setMessageExpiration(testExpiration + 2 * testPeriod);
    m.setMessageId(getContext().random().nextLong(I2NPMessage.MAX_ID_VALUE));
    ReplySelector sel=new ReplySelector(getContext(),m.getMessageId(),testExpiration + 2 * testPeriod);
    OnTestReply onReply=new OnTestReply(getContext());
    OnTestTimeout onTimeout=new OnTestTimeout(getContext());
    getContext().messageRegistry().registerPending(sel,onReply,onTimeout,3 * testPeriod);
    sendTest(m,outTunnel,replyTunnel);
  }
}
