{
  int length=settings.getLength();
  if (settings.getLengthVariance() != 0) {
    int skew=settings.getLengthVariance();
    if (skew > 0)     length+=ctx.random().nextInt(skew + 1);
 else {
      skew=1 - skew;
      int off=ctx.random().nextInt(skew);
      if (ctx.random().nextBoolean())       length+=off;
 else       length-=off;
    }
    if (length < 0)     length=0;
  }
  if ((ctx.tunnelManager().getOutboundTunnelCount() <= 0) || (ctx.tunnelManager().getFreeTunnelCount() <= 0)) {
    Log log=ctx.logManager().getLog(TunnelPeerSelector.class);
    if (settings.getAllowZeroHop()) {
      if (log.shouldLog(Log.INFO))       log.info("no outbound tunnels or free inbound tunnels, but we do allow zeroHop: " + settings);
      return 0;
    }
 else {
      if (log.shouldLog(Log.WARN))       log.warn("no outbound tunnels or free inbound tunnels, and we dont allow zeroHop: " + settings);
      return -1;
    }
  }
  return length;
}
