{
  if (_log.shouldLog(Log.WARN))   _log.warn(toString() + ": Tunnel failed: " + cfg);
  int remaining=0;
  LeaseSet ls=null;
synchronized (_tunnels) {
    _tunnels.remove(cfg);
    if (_settings.isInbound() && (_settings.getDestination() != null))     ls=locked_buildNewLeaseSet();
    remaining=_tunnels.size();
    if (_lastSelected == cfg) {
      _lastSelected=null;
      _lastSelectionPeriod=0;
    }
  }
  _lifetimeProcessed+=cfg.getProcessedMessagesCount();
  if (_settings.isInbound() && (_settings.getDestination() != null)) {
    if (ls != null) {
      _context.clientManager().requestLeaseSet(_settings.getDestination(),ls);
      if (_settings.isExploratory())       refreshBuilders(3,4);
 else       refreshBuilders(1,4);
    }
 else {
      if (_log.shouldLog(Log.WARN))       _log.warn(toString() + ": unable to build a new leaseSet on failure (" + remaining+ " remaining), request a new tunnel");
      if (remaining < _settings.getBackupQuantity() + _settings.getQuantity())       if (!buildFallback())       if (_settings.isExploratory())       refreshBuilders(3,4);
 else       refreshBuilders(1,4);
    }
  }
 else {
    if (_settings.isExploratory())     refreshBuilders(3,4);
 else     refreshBuilders(1,4);
  }
}
