{
  if (replyPeer == null) {
    if (_log.shouldLog(Log.ERROR))     _log.error("No peer specified for reply!");
    return null;
  }
  SessionKey replySessionKey=_context.keyGenerator().generateSessionKey();
  SessionTag tag=new SessionTag(true);
  Set tags=new HashSet();
  tags.add(tag);
  _context.sessionKeyManager().tagsReceived(replySessionKey,tags);
  PublicKey pk=replyPeer.getIdentity().getPublicKey();
  DeliveryInstructions instructions=new DeliveryInstructions();
  instructions.setDelayRequested(false);
  instructions.setDelaySeconds(0);
  instructions.setDeliveryMode(DeliveryInstructions.DELIVERY_MODE_TUNNEL);
  instructions.setDestination(null);
  instructions.setEncrypted(false);
  instructions.setEncryptionKey(null);
  instructions.setRouter(gateway.getGateway());
  instructions.setTunnelId(gateway.getTunnelId());
  long replyId=_context.random().nextInt(Integer.MAX_VALUE);
  Certificate replyCert=new Certificate(Certificate.CERTIFICATE_TYPE_NULL,null);
  long expiration=_expiration;
  if (_log.shouldLog(Log.DEBUG))   _log.debug("Setting the expiration on the reply block to " + (new Date(expiration)));
  SourceRouteBlock block=new SourceRouteBlock();
  try {
    long begin=_context.clock().now();
    block.setData(_context,instructions,replyId,replyCert,expiration,pk);
    long end=_context.clock().now();
    if ((end - begin) > 1000) {
      if (_log.shouldLog(Log.WARN))       _log.warn("Took too long (" + (end - begin) + "ms) to build source route block");
    }
 else {
      if (_log.shouldLog(Log.DEBUG))       _log.debug("did NOT take long (" + (end - begin) + "ms) to build source route block!");
    }
  }
 catch (  DataFormatException dfe) {
    if (_log.shouldLog(Log.ERROR))     _log.error("Error building the reply block",dfe);
    return null;
  }
  block.setRouter(replyPeer.getIdentity().getHash());
  block.setKey(replySessionKey);
  block.setTag(tag);
  return block;
}
