{
  SessionKey encryptionKey=_context.keyGenerator().generateSessionKey();
  Object kp[]=_context.keyGenerator().generateSigningKeypair();
  SigningPublicKey pubkey=(SigningPublicKey)kp[0];
  SigningPrivateKey privkey=(SigningPrivateKey)kp[1];
  long duration=settings.getInboundDuration();
  if (duration <= 0)   duration=DEFAULT_TUNNEL_DURATION;
  long expiration=_context.clock().now() + duration;
  TunnelSettings tunnelSettings=new TunnelSettings(_context);
  tunnelSettings.setBytesPerMinuteAverage(settings.getBytesPerMinuteInboundAverage());
  tunnelSettings.setBytesPerMinutePeak(settings.getBytesPerMinuteInboundPeak());
  tunnelSettings.setDepth(peerHashList.size() + 1);
  tunnelSettings.setExpiration(expiration);
  tunnelSettings.setIncludeDummy(settings.getIncludeDummyInbound());
  tunnelSettings.setMessagesPerMinuteAverage(settings.getMessagesPerMinuteInboundAverage());
  tunnelSettings.setMessagesPerMinutePeak(settings.getMessagesPerMinuteInboundPeak());
  tunnelSettings.setReorder(settings.getReorderInbound());
  TunnelId id=new TunnelId();
  id.setTunnelId(_context.random().nextLong(TunnelId.MAX_ID_VALUE));
  id.setType(TunnelId.TYPE_INBOUND);
  TunnelInfo first=null;
  TunnelInfo prev=null;
  for (int i=0; i < peerHashList.size(); i++) {
    Hash peer=(Hash)peerHashList.get(i);
    TunnelInfo cur=new TunnelInfo(_context);
    cur.setThisHop(peer);
    cur.setConfigurationKey(_context.keyGenerator().generateSessionKey());
    cur.setDestination(null);
    if (i == 0) {
      cur.setEncryptionKey(encryptionKey);
      cur.setSigningKey(privkey);
    }
    cur.setSettings(tunnelSettings);
    cur.setTunnelId(id);
    cur.setVerificationKey(pubkey);
    if (prev != null) {
      prev.setNextHop(peer);
      prev.setNextHopInfo(cur);
    }
 else {
      first=cur;
    }
    prev=cur;
  }
  TunnelInfo last=new TunnelInfo(_context);
  last.setThisHop(_context.routerHash());
  last.setDestination(dest);
  last.setEncryptionKey(encryptionKey);
  last.setSettings(tunnelSettings);
  last.setTunnelId(id);
  last.setVerificationKey(pubkey);
  last.setSigningKey(privkey);
  last.setConfigurationKey(_context.keyGenerator().generateSessionKey());
  TunnelInfo cur=first;
  if (cur == null) {
    first=last;
  }
 else {
    while (cur.getNextHopInfo() != null)     cur=cur.getNextHopInfo();
    cur.setNextHop(last.getThisHop());
    cur.setNextHopInfo(last);
  }
  return first;
}
