{
  try {
    if (!_pool.isLive())     return;
    boolean built=false;
    ClientTunnelSettings settings=new ClientTunnelSettings();
    settings.readFromProperties(getContext().router().getConfigMap());
    _pool.setPoolSettings(settings);
    try {
      String str=getContext().router().getConfigSetting(TunnelPool.TARGET_CLIENTS_PARAM);
      int clients=Integer.parseInt(str);
      _pool.setTargetClients(clients);
    }
 catch (    NumberFormatException nfe) {
    }
    int targetClients=_pool.getTargetClients();
    int targetInboundTunnels=targetClients * _pool.getPoolSettings().getNumInboundTunnels() + 1;
    int targetOutboundTunnels=targetClients * _pool.getPoolSettings().getNumOutboundTunnels() + 1;
    int curFreeInboundTunnels=getFreeTunnelCount();
    if (curFreeInboundTunnels < targetInboundTunnels) {
      if (_log.shouldLog(Log.INFO))       _log.info("Insufficient free inbound tunnels (" + curFreeInboundTunnels + ", not "+ targetInboundTunnels+ "), requesting more");
      requestInboundTunnels(2);
      built=true;
    }
 else {
      if (getContext().random().nextInt(9) > 0) {
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Sufficient inbound tunnels (" + curFreeInboundTunnels + ")");
      }
 else {
        if (_log.shouldLog(Log.INFO))         _log.info("Building another inbound tunnel, cuz tunnels r k00l");
        requestInboundTunnels(1);
        built=true;
      }
    }
    int curOutboundTunnels=getOutboundTunnelCount();
    if (curOutboundTunnels < targetOutboundTunnels) {
      if (_log.shouldLog(Log.INFO))       _log.info("Insufficient outbound tunnels (" + curOutboundTunnels + ", not "+ targetOutboundTunnels+ "), requesting more");
      requestOutboundTunnels(2);
      built=true;
    }
 else {
      if (getContext().random().nextInt(9) > 0) {
        if (_log.shouldLog(Log.DEBUG))         _log.debug("Sufficient outbound tunnels (" + curOutboundTunnels + ")");
      }
 else {
        if (_log.shouldLog(Log.INFO))         _log.info("Building another outbound tunnel, since gravity still works");
        requestOutboundTunnels(1);
        built=true;
      }
    }
    _pool.buildFakeTunnels();
  }
 catch (  Throwable t) {
    _log.log(Log.CRIT,"Unhandled exception managing the tunnel pool",t);
  }
  requeue(POOL_CHECK_DELAY);
}
