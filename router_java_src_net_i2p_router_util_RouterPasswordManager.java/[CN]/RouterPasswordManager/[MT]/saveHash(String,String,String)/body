{
  String pfx=realm;
  if (user != null && user.length() > 0)   pfx+='.' + user;
  byte[] salt=new byte[SALT_LENGTH];
  _context.random().nextBytes(salt);
  byte[] pwHash=_context.keyGenerator().generateSessionKey(salt,DataHelper.getUTF8(pw)).getData();
  byte[] shashBytes=new byte[SHASH_LENGTH];
  System.arraycopy(salt,0,shashBytes,0,SALT_LENGTH);
  System.arraycopy(pwHash,0,shashBytes,SALT_LENGTH,SessionKey.KEYSIZE_BYTES);
  String shash=Base64.encode(shashBytes);
  Map<String,String> toAdd=Collections.singletonMap(pfx + PROP_SHASH,shash);
  List<String> toDel=new ArrayList<String>(4);
  toDel.add(pfx + PROP_PW);
  toDel.add(pfx + PROP_B64);
  toDel.add(pfx + PROP_MD5);
  toDel.add(pfx + PROP_CRYPT);
  return _context.router().saveConfig(toAdd,toDel);
}
